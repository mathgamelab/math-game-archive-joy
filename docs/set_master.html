<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåê Set Master!</title>
  <style>
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-accent: #3b82f6;
      --bg-accent-hover: #2563eb;
      --glass: rgba(255,255,255,0.8);
      --glass-strong: rgba(255,255,255,0.95);
      --txt-primary: #1e293b;
      --txt-secondary: #64748b;
      --txt-white: #ffffff;
      --p1: #ef4444;
      --p1-hover: #dc2626;
      --p2: #06b6d4;
      --p2-hover: #0891b2;
      --accent: #f59e0b;
      --accent-hover: #d97706;
      --ok: #10b981;
      --bad: #ef4444;
      --border: #e2e8f0;
      --border-hover: #cbd5e1;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; color: var(--txt-primary);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg-primary);
      display: flex; flex-direction: column;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .glass { 
      backdrop-filter: blur(10px); 
      background: var(--glass); 
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .header { 
      text-align: center; 
      padding: 24px 16px; 
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    .title-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      flex-wrap: wrap;
      position: relative;
    }
    
    .title {
      flex: 1;
      text-align: center;
    }
    
    .rules-btn {
      position: absolute;
      right: 0;
    }
    
    .title { 
      font-size: clamp(1.8rem, 4vw, 3rem); 
      font-weight: 800; 
      color: var(--txt-primary);
      margin-bottom: 8px;
    }
    
    .rules-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .rules-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .rules-icon {
      font-size: 1.2rem;
    }
    
    .rules-text {
      font-size: 0.9rem;
    }
    .subtitle { 
      color: var(--txt-secondary); 
      font-size: 1.1rem; 
      font-weight: 500;
    }

    .info { 
      display: grid; 
      grid-template-columns: 1fr auto 1fr; 
      gap: clamp(12px, 3vw, 20px); 
      padding: clamp(12px, 3vw, 20px) clamp(8px, 2vw, 16px); 
      align-items: center; 
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    
    @media (max-width: 1200px) {
      .info {
        grid-template-columns: 1fr auto 1fr;
        gap: clamp(6px, 1.5vw, 12px);
        text-align: center;
      }
      
      .scores {
        justify-content: center;
        gap: clamp(4px, 1vw, 8px);
        flex-wrap: nowrap;
      }
    }
    .timer-wrap { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 8px; 
    }
    .game-title { 
      font-size: clamp(1.6rem, 4vw, 2.2rem); 
      font-weight: 700; 
      color: var(--txt-primary);
      margin-bottom: 4px;
    }
    .timer { 
      font-size: clamp(1.8rem, 5vw, 2.8rem); 
      font-weight: 800; 
      color: var(--accent); 
    }
    .bar { 
      width: min(600px, 80vw); 
      height: 12px; 
      border-radius: 999px; 
      overflow: hidden; 
      background: var(--border); 
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 1200px) {
      .bar {
        width: min(400px, 50vw);
      }
    }
    .bar > div { 
      height: 100%; 
      width: 100%; 
      background: linear-gradient(90deg, var(--ok), var(--accent), var(--bad)); 
      transform-origin: left center; 
      transition: transform 0.3s ease;
    }

    .scores { 
      display: flex; 
      gap: clamp(12px, 3vw, 30px); 
      justify-content: center; 
      align-items: center;
      flex-wrap: wrap;
    }
    
    @media (max-width: 1200px) {
      .scores {
        gap: clamp(4px, 1vw, 8px);
        flex-wrap: nowrap;
      }
    }
    .score { 
      text-align: center; 
      min-width: clamp(80px, 15vw, 120px); 
      padding: clamp(8px, 2vw, 16px);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    @media (max-width: 1200px) {
      .score {
        min-width: clamp(70px, 12vw, 100px);
        padding: clamp(6px, 1.5vw, 12px);
      }
    }
    .score .label { 
      font-size: clamp(0.8rem, 2vw, 1rem); 
      color: var(--txt-secondary); 
      margin-bottom: clamp(4px, 1vw, 8px); 
      font-weight: 600;
    }
    .score .val { 
      font-size: clamp(1.4rem, 4vw, 2.8rem); 
      font-weight: 900; 
    }
    
    @media (max-width: 1200px) {
      .score .label {
        font-size: clamp(0.7rem, 1.8vw, 0.9rem);
        margin-bottom: 4px;
      }
      .score .val {
        font-size: clamp(1.2rem, 3.5vw, 2.2rem);
      }
    }
    .p1 .val { color: var(--p1); } 
    .p2 .val { color: var(--p2); }
    .combo { 
      font-size: 0.9rem; 
      margin-top: 6px; 
      color: var(--accent); 
      font-weight: 700; 
    }

    /* ÏΩ§Î≥¥ ÌëúÏãú Ïä§ÌÉÄÏùº */
    .combo-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: clamp(80px, 12vw, 135px);
      height: clamp(70px, 10vw, 105px);
      font-weight: 700;
      color: var(--accent);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin: 0 clamp(4px, 1vw, 8px);
      gap: clamp(4px, 1vw, 9px);
    }
    
    @media (max-width: 1200px) {
      .combo-display {
        min-width: clamp(60px, 10vw, 90px);
        height: clamp(50px, 8vw, 75px);
        margin: 0 clamp(2px, 0.5vw, 4px);
        gap: clamp(2px, 0.5vw, 6px);
      }
    }
    
    
    .combo-display .fire {
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      line-height: 1;
      animation: firePulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      filter: drop-shadow(0 0 4px currentColor);
    }
    
    .combo-display .text {
      font-size: clamp(1rem, 2.5vw, 1.6rem);
      line-height: 1;
      color: inherit;
    }
    
    @media (max-width: 1200px) {
      .combo-display .fire {
        font-size: clamp(1rem, 2.5vw, 1.4rem);
      }
      .combo-display .text {
        font-size: clamp(0.8rem, 2vw, 1.2rem);
      }
    }
    
    /* ÏΩ§Î≥¥ Î†àÎ≤®Î≥Ñ ÏÉâÏÉÅ Î≥ÄÌôî */
    .combo-display.combo-level-1 .fire { color: #f59e0b; } /* Ï£ºÌô©ÏÉâ */
    .combo-display.combo-level-1 .text { color: #f59e0b; } /* Ï£ºÌô©ÏÉâ */
    .combo-display.combo-level-2 .fire { color: #ef4444; } /* Îπ®Í∞ÑÏÉâ */
    .combo-display.combo-level-2 .text { color: #ef4444; } /* Îπ®Í∞ÑÏÉâ */
    .combo-display.combo-level-3 .fire { color: #8b5cf6; } /* Î≥¥ÎùºÏÉâ */
    .combo-display.combo-level-3 .text { color: #8b5cf6; } /* Î≥¥ÎùºÏÉâ */
    .combo-display.combo-level-4 .fire { color: #06b6d4; } /* Ï≤≠Î°ùÏÉâ */
    .combo-display.combo-level-4 .text { color: #06b6d4; } /* Ï≤≠Î°ùÏÉâ */
    .combo-display.combo-level-5 .fire { color: #10b981; } /* Ï¥àÎ°ùÏÉâ */
    .combo-display.combo-level-5 .text { color: #10b981; } /* Ï¥àÎ°ùÏÉâ */
    
    /* Î∂àÍΩÉ ÌéÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò */
    @keyframes firePulse {
      0%, 100% { 
        transform: scale(1); 
        filter: drop-shadow(0 0 4px currentColor);
      }
      5% { 
        transform: scale(1.02); 
        filter: drop-shadow(0 0 4.5px currentColor);
      }
      10% { 
        transform: scale(1.05); 
        filter: drop-shadow(0 0 5px currentColor);
      }
      15% { 
        transform: scale(1.08); 
        filter: drop-shadow(0 0 5.5px currentColor);
      }
      20% { 
        transform: scale(1.1); 
        filter: drop-shadow(0 0 6px currentColor);
      }
      25% { 
        transform: scale(1.12); 
        filter: drop-shadow(0 0 6.5px currentColor);
      }
      30% { 
        transform: scale(1.15); 
        filter: drop-shadow(0 0 7px currentColor);
      }
      35% { 
        transform: scale(1.12); 
        filter: drop-shadow(0 0 6.5px currentColor);
      }
      40% { 
        transform: scale(1.1); 
        filter: drop-shadow(0 0 6px currentColor);
      }
      45% { 
        transform: scale(1.08); 
        filter: drop-shadow(0 0 5.5px currentColor);
      }
      50% { 
        transform: scale(1.05); 
        filter: drop-shadow(0 0 5px currentColor);
      }
      55% { 
        transform: scale(1.02); 
        filter: drop-shadow(0 0 4.5px currentColor);
      }
      60% { 
        transform: scale(1); 
        filter: drop-shadow(0 0 4px currentColor);
      }
      65% { 
        transform: scale(1.02); 
        filter: drop-shadow(0 0 4.5px currentColor);
      }
      70% { 
        transform: scale(1.05); 
        filter: drop-shadow(0 0 5px currentColor);
      }
      75% { 
        transform: scale(1.08); 
        filter: drop-shadow(0 0 5.5px currentColor);
      }
      80% { 
        transform: scale(1.1); 
        filter: drop-shadow(0 0 6px currentColor);
      }
      85% { 
        transform: scale(1.08); 
        filter: drop-shadow(0 0 5.5px currentColor);
      }
      90% { 
        transform: scale(1.05); 
        filter: drop-shadow(0 0 5px currentColor);
      }
      95% { 
        transform: scale(1.02); 
        filter: drop-shadow(0 0 4.5px currentColor);
      }
    }
    
    
    /* ÏΩ§Î≥¥ Ïπ¥Îìú Í∏ÄÎ°úÏö∞ Ìö®Í≥º */
    .combo-display {
      transition: all 0.3s ease;
    }
    
    .combo-display.combo-level-2 {
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }
    
    .combo-display.combo-level-3 {
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
    }
    
    .combo-display.combo-level-4 {
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
    }
    
    .combo-display.combo-level-5 {
      box-shadow: 0 0 25px rgba(16, 185, 129, 0.6);
    }
    
    .combo-p1 {
      order: 2; /* ÌîåÎ†àÏù¥Ïñ¥ 1 Ïò§Î•∏Ï™ΩÏóê Î∞∞Ïπò */
    }
    
    .combo-p2 {
      order: -1; /* ÌîåÎ†àÏù¥Ïñ¥ 2 ÏôºÏ™ΩÏóê Î∞∞Ïπò */
    }
    
    .combo-display:empty {
      visibility: hidden;
    }

    .sets { 
      display: flex; 
      justify-content: center; 
      gap: clamp(8px, 2vw, 20px); 
      margin: clamp(12px, 3vw, 24px) auto; 
      flex-wrap: wrap; 
    }
    
    @media (max-width: 1200px) {
      .sets {
        gap: clamp(6px, 1.5vw, 12px);
        margin: clamp(8px, 2vw, 16px) auto;
      }
    }
    .setbox { 
      border-radius: 16px; 
      padding: clamp(12px, 3vw, 20px) clamp(16px, 4vw, 24px); 
      background: var(--bg-secondary); 
      min-width: clamp(180px, 30vw, 240px); 
      text-align: center; 
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    @media (max-width: 1200px) {
      .setbox {
        min-width: clamp(140px, 25vw, 200px);
        padding: clamp(8px, 2vw, 16px) clamp(12px, 3vw, 20px);
      }
    }
    .setbox .name { 
      font-size: clamp(1rem, 2.5vw, 1.3rem); 
      font-weight: 800; 
      margin-bottom: clamp(4px, 1vw, 8px); 
      color: var(--txt-primary);
    }
    .setbox .desc { 
      font-size: clamp(1.1rem, 2.8vw, 1.4rem); 
      color: var(--txt-primary);
      font-weight: 800;
    }
    
    @media (max-width: 1200px) {
      .setbox .name {
        font-size: clamp(0.9rem, 2.2vw, 1.1rem);
        margin-bottom: 4px;
      }
      .setbox .desc {
        font-size: clamp(1rem, 2.5vw, 1.2rem);
      }
    }

    .number { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin: clamp(12px, 3vw, 24px) auto; 
    }
    .num { 
      font-size: clamp(3rem, 8vw, 8rem); 
      font-weight: 900; 
      line-height: 1; 
      padding: clamp(16px, 2.5vw, 24px) clamp(24px, 4vw, 36px); 
      border-radius: 24px; 
      background: var(--bg-secondary); 
      color: var(--txt-primary);
      border: 2px solid var(--border);
      box-shadow: var(--shadow-lg);
    }
    
    @media (max-width: 1200px) {
      .number {
        margin: clamp(8px, 2vw, 16px) auto;
      }
      .num {
        font-size: clamp(2.5rem, 6vw, 6rem);
        padding: clamp(12px, 2vw, 20px) clamp(20px, 3vw, 32px);
      }
    }

    .controls { 
      display: flex; 
      flex-wrap: nowrap;
      justify-content: center;
      align-items: center;
      gap: clamp(3px, 0.8vw, 6px); 
      padding: clamp(16px, 3vw, 24px) clamp(8px, 2vw, 20px) clamp(20px, 4vw, 32px); 
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
    }
    
    @media (max-width: 1200px) {
      .controls {
        gap: clamp(2px, 0.5vw, 4px);
        padding: clamp(12px, 2vw, 20px) clamp(6px, 1.5vw, 16px) clamp(16px, 3vw, 24px);
      }
    }
    .col { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: clamp(8px, 2vw, 16px); 
    }
    .player { 
      font-size: clamp(1rem, 2.5vw, 1.3rem); 
      font-weight: 800; 
      color: var(--txt-primary);
    }
    
    @media (max-width: 1200px) {
      .col {
        gap: clamp(6px, 1.5vw, 12px);
      }
      .player {
        font-size: clamp(0.9rem, 2.2vw, 1.1rem);
      }
    }
    .buttons { 
      display: grid; 
      grid-template-columns: repeat(3, minmax(70px, 1fr)); 
      gap: clamp(8px, 1.5vw, 12px); 
      width: 100%; 
      max-width: clamp(400px, 80vw, 600px); 
    }
    .buttons.any-mode { 
      grid-template-columns: repeat(4, minmax(60px, 1fr)); 
      max-width: clamp(500px, 90vw, 800px); 
    }
    
    @media (max-width: 1200px) {
      .buttons {
        grid-template-columns: repeat(3, minmax(60px, 1fr));
        gap: clamp(6px, 1vw, 10px);
        max-width: clamp(300px, 90vw, 500px);
      }
      .buttons.any-mode {
        grid-template-columns: repeat(4, minmax(50px, 1fr));
        max-width: clamp(350px, 95vw, 600px);
      }
    }
    .btn { 
      border: 0; 
      border-radius: 10px; 
      font-weight: 800; 
      font-size: 1.1rem; 
      padding: clamp(4px, 0.8vw, 8px) clamp(3px, 0.6vw, 6px); 
      cursor: pointer; 
      transition: all 0.2s ease; 
      box-shadow: var(--shadow);
      min-width: clamp(35px, 6vw, 50px);
      flex-shrink: 0;
    }
    
    @media (max-width: 1200px) {
      .btn {
        font-size: 1.1rem;
        padding: clamp(3px, 0.6vw, 6px) clamp(2px, 0.4vw, 4px);
        border-radius: 8px;
        min-width: clamp(30px, 5vw, 45px);
      }
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--shadow-lg);
    }
    .btn:active { 
      transform: translateY(0) scale(0.98); 
    }
    .btn:focus { 
      outline: 3px solid var(--bg-accent); 
      outline-offset: 2px; 
    }
    .p1 .btn { 
      background: var(--p1); 
      color: var(--txt-white); 
    } 
    .p1 .btn:hover { 
      background: var(--p1-hover); 
    }
    .p2 .btn { 
      background: var(--p2); 
      color: var(--txt-white); 
    } 
    .p2 .btn:hover { 
      background: var(--p2-hover); 
    }

    .kbd { 
      opacity: 0.7; 
      font-size: clamp(0.6rem, 1.2vw, 0.8rem); 
      margin-left: clamp(4px, 1vw, 8px); 
      background: var(--border); 
      color: var(--txt-secondary);
      padding: clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 8px); 
      border-radius: 6px; 
      font-weight: 600;
    }
    
    @media (max-width: 1200px) {
      .kbd {
        font-size: clamp(0.5rem, 1vw, 0.7rem);
        margin-left: clamp(2px, 0.5vw, 6px);
        padding: clamp(1px, 0.3vw, 3px) clamp(3px, 0.8vw, 6px);
        border-radius: 4px;
      }
    }

    .overlay { 
      position: fixed; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(0,0,0,0.6); 
      z-index: 50; 
      backdrop-filter: blur(4px);
    }
    .card { 
      width: min(1200px, 95vw); 
      border-radius: 20px; 
      padding: 32px; 
      background: var(--bg-secondary); 
      color: var(--txt-primary); 
      box-shadow: var(--shadow-lg); 
      border: 1px solid var(--border);
    }
    .center { text-align: center; }
    .lg { font-size: 1.5rem; font-weight: 800; color: var(--txt-primary); }
    .muted { color: var(--txt-secondary); }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; }
    .row > * { flex: 1; min-width: 240px; }
    .select, .input, .seg { 
      background: var(--bg-primary); 
      border: 1px solid var(--border); 
      color: var(--txt-primary); 
      border-radius: 12px; 
      padding: 12px 16px; 
      font-size: 1rem; 
      transition: border-color 0.2s ease;
    }
    .select:focus, .input:focus { 
      outline: none; 
      border-color: var(--bg-accent); 
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .seg { display: flex; gap: 8px; }
    .seg button { 
      flex: 1; 
      border-radius: 10px; 
      background: var(--bg-primary); 
      border: 1px solid var(--border); 
      color: var(--txt-primary); 
      padding: 10px 8px; 
      cursor: pointer; 
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .seg button:hover { 
      background: var(--border); 
    }
    .seg button.active { 
      background: var(--bg-accent); 
      border-color: var(--bg-accent); 
      color: var(--txt-white); 
    }
    .seg button:focus, .btn:focus, .primary:focus, .outline:focus { 
      outline: 3px solid var(--bg-accent); 
      outline-offset: 2px; 
    }
    .actions { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      margin-top: 16px; 
    }
    .primary { 
      background: var(--ok); 
      color: var(--txt-white); 
      border: 0; 
      padding: 14px 24px; 
      font-weight: 800; 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }
    .primary:hover { 
      background: #059669; 
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    .outline { 
      background: transparent; 
      color: var(--txt-primary); 
      border: 1px solid var(--border); 
      padding: 14px 24px; 
      font-weight: 800; 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    .outline:hover { 
      background: var(--bg-primary); 
      border-color: var(--border-hover);
    }

    /* Í≤åÏûÑ Ï¢ÖÎ£å ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
    .end {
      width: min(600px, 90vw) !important;
      max-width: 600px;
    }
    
    .end .actions {
      justify-content: center;
      gap: 20px;
    }
    
    .end .primary,
    .end .outline {
      font-size: 1.2rem;
      padding: 18px 32px;
      min-width: 160px;
    }
    
    .end .lg {
      font-size: 2rem;
      font-weight: 800;
      color: var(--txt-primary);
      margin: 12px 0 8px;
    }
    
    .end .muted {
      font-size: 1.3rem;
      color: var(--txt-secondary);
      font-weight: 600;
    }

    .feedback { 
      position: fixed; 
      left: 50%; 
      top: 50%; 
      transform: translate(-50%, -50%); 
      font-size: clamp(1.8rem, 4vw, 2.5rem); 
      font-weight: 900; 
      padding: 0.3em 0.6em; 
      border-radius: 16px; 
      z-index: 40; 
      pointer-events: none; 
      opacity: 0; 
      transition: all 0.3s ease; 
      box-shadow: var(--shadow-lg);
    }
    .feedback.show { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1.05);
    }
    .feedback.ok { 
      background: var(--ok); 
      color: var(--txt-white); 
    }
    .feedback.bad { 
      background: var(--bad); 
      color: var(--txt-white); 
    }

    .end { gap: 16px; }
    .hint { 
      font-size: 0.9rem; 
      color: var(--txt-secondary); 
      margin-top: 8px; 
    }
    label .lbl { 
      display: block; 
      margin-bottom: 8px; 
      color: var(--txt-primary);
      font-weight: 600;
    }

    /* Venn Diagram Modal */
    .venn-modal { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.7); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 60; 
      backdrop-filter: blur(4px);
    }
    .venn-card { 
      width: min(700px, 85vw); 
      background: var(--bg-secondary); 
      border-radius: 16px; 
      padding: 16px; 
      color: var(--txt-primary); 
      max-height: 90vh; 
      overflow-y: auto; 
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
    }
    .venn-title { 
      font-size: 1.6rem; 
      font-weight: 800; 
      text-align: center; 
      margin-bottom: 12px; 
      color: var(--txt-primary);
    }
    .venn-question { 
      background: var(--bg-primary); 
      padding: 10px 14px; 
      border-radius: 12px; 
      text-align: center; 
      margin-bottom: 12px; 
      border: 1px solid var(--border);
    }
    .venn-question h2 { 
      font-size: 2rem; 
      margin: 8px 0; 
      color: var(--txt-primary);
    }
    .venn-svg { 
      background: var(--bg-secondary); 
      border-radius: 12px; 
      margin: 0 auto 12px auto; 
      border: 1px solid var(--border);
      width: 60%;
      height: auto;
      display: block;
    }
    .venn-region { 
      cursor: pointer; 
      transition: opacity 0.2s ease; 
    }
    .venn-region:hover { 
      opacity: 0.6 !important; 
    }
    .venn-btn { 
      width: 100%; 
      padding: 10px; 
      border: 0; 
      border-radius: 10px; 
      font-weight: 800; 
      font-size: 1rem; 
      cursor: pointer; 
      margin-top: 6px; 
      transition: all 0.2s ease;
    }
    .venn-btn.check { 
      background: var(--bg-accent); 
      color: var(--txt-white); 
    }
    .venn-btn.check:hover { 
      background: var(--bg-accent-hover); 
    }
    .venn-btn.next { 
      background: var(--ok); 
      color: var(--txt-white); 
    }
    .venn-btn.next:hover { 
      background: #059669; 
    }
    .venn-result { 
      padding: 16px; 
      border-radius: 12px; 
      margin-bottom: 16px; 
      text-align: center; 
    }
    .venn-result.correct { 
      background: #d1fae5; 
      color: #065f46; 
      border: 1px solid #a7f3d0;
    }
    .venn-result.wrong { 
      background: #fee2e2; 
      color: #991b1b; 
      border: 1px solid #fecaca;
    }
    .venn-help { 
      background: var(--bg-primary); 
      padding: 16px; 
      border-radius: 12px; 
      font-size: 0.95rem; 
      text-align: center; 
      color: var(--txt-secondary); 
      border: 1px solid var(--border);
    }
    .venn-timer {
      margin-top: 16px;
      text-align: center;
    }
    .venn-timer-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .venn-timer-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--ok), var(--accent), var(--bad));
      width: 100%;
      transition: width 0.3s ease;
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      color: var(--txt-secondary);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .footer a {
      color: var(--bg-accent);
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
    }

    /* Mode Selection Buttons */
    .mode-btn {
      border: 0;
      border-radius: 12px;
      font-weight: 800;
      font-size: 1rem;
      padding: 14px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--txt-white);
      min-width: 120px;
    }
    
    .mode-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .mode-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    .mode-btn:focus {
      outline: 3px solid var(--bg-accent);
      outline-offset: 2px;
    }
    
    .practice-mode {
      background: #06b6d4;
    }
    
    .practice-mode:hover {
      background: #0891b2;
    }
    
    .pvp-mode {
      background: #8b5cf6;
    }
    
    .pvp-mode:hover {
      background: #7c3aed;
    }
    
    .mode-icon {
      font-size: 1.1rem;
    }
    
    .mode-text {
      font-size: 0.9rem;
    }

    /* Ïó∞ÏäµÎ™®ÎìúÏóêÏÑú ÌîåÎ†àÏù¥Ïñ¥ 2 Ïà®Í∏∞Í∏∞ (Î†àÏù¥ÏïÑÏõÉ Ïú†ÏßÄ) */
    .practice-mode-active .p2 {
      visibility: hidden !important;
    }
    
    .practice-mode-active .scores .p2 {
      visibility: hidden !important;
    }
    
    .practice-mode-active .combo-p2 {
      visibility: hidden !important;
    }
    
    /* Î£∞Î∂Å Î™®Îã¨ Ïä§ÌÉÄÏùº */
    .rules-card {
      width: min(900px, 95vw);
      max-height: 90vh;
      background: var(--bg-secondary);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    .rules-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .rules-title {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 0;
    }
    
    .rules-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .rules-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .rules-content {
      padding: 32px;
      max-height: calc(90vh - 100px);
      overflow-y: auto;
    }
    
    .rules-section {
      margin-bottom: 32px;
    }
    
    .rules-section h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--txt-primary);
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }
    
    .rules-section p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--txt-secondary);
      margin-bottom: 16px;
    }
    
    .venn-areas {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .area-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .area-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .area-color.only-a { background: #3b82f6; }
    .area-color.intersection { background: #10b981; }
    .area-color.only-b { background: #06b6d4; }
    .area-color.outside { background: #6b7280; }
    
    .area-text {
      font-size: 1rem;
      color: var(--txt-primary);
    }
    
    .interactive-venn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
    }
    
    #rulesVennCanvas {
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      margin: 8px 0;
    }
    
    .venn-instructions {
      text-align: center;
    }
    
    .venn-instructions p {
      font-size: 1rem;
      color: var(--txt-secondary);
      margin-bottom: 12px;
    }
    
    .selected-areas {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
      padding: 12px 20px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .practice-problems {
      display: grid;
      gap: 16px;
    }
    
    .problem-item {
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .problem-item strong {
      color: var(--txt-primary);
      font-size: 1.1rem;
    }
    
    .practice-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .practice-btn {
      background: var(--bg-accent);
      color: var(--txt-white);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .practice-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .practice-btn.active {
      background: #047857;
      box-shadow: 0 2px 8px rgba(4, 120, 87, 0.3);
    }
    
    .practice-question {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--txt-primary);
      text-align: center;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .practice-result {
      margin-top: 16px;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      min-height: 20px;
    }
    
    .practice-result.correct {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .practice-result.wrong {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .practice-result.empty {
      background: var(--bg-primary);
      color: var(--txt-secondary);
      border: 1px solid var(--border);
    }
    
    .region-meaning {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin-bottom: 16px;
      min-height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Í≤åÏûÑ Ïª®Ìä∏Î°§ Î≤ÑÌäº */
    .game-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    
    .home-btn {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      border: none;
      padding: clamp(8px, 2vw, 16px);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: clamp(60px, 10vw, 80px);
      height: clamp(60px, 10vw, 80px);
      position: absolute;
      right: clamp(8px, 2vw, 20px);
      top: clamp(120px, 15vw, 200px);
      z-index: 10;
    }
    
    @media (max-width: 1200px) {
      .home-btn {
        min-width: clamp(50px, 8vw, 70px);
        height: clamp(50px, 8vw, 70px);
        right: clamp(6px, 1.5vw, 16px);
        top: clamp(80px, 12vw, 150px);
        padding: clamp(6px, 1.5vw, 12px);
      }
    }
    
    .home-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(251, 191, 36, 0.3);
    }
    
    .home-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .home-icon {
      font-size: clamp(1rem, 2vw, 1.2rem);
      line-height: 1;
    }
    
    .home-text {
      font-size: clamp(0.7rem, 1.5vw, 0.9rem);
      line-height: 1;
    }
    
    @media (max-width: 1200px) {
      .home-icon {
        font-size: clamp(0.8rem, 1.8vw, 1rem);
      }
      .home-text {
        font-size: clamp(0.6rem, 1.2vw, 0.8rem);
      }
    }
  </style>
</head>
<body>
  <!-- START OVERLAY -->
  <div class="overlay" id="start" role="dialog" aria-modal="true" aria-labelledby="start-title">
    <div class="card stack">
      <div class="center">
        <div class="title-container">
          <div class="title" id="start-title">üåê SET MASTER</div>
          <button class="rules-btn" id="rulesBtn" title="Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÌïôÏäµ">
            <span class="rules-icon">üìö</span>
            <span class="rules-text">ÌïôÏäµÌïòÍ∏∞</span>
          </button>
        </div>
      </div>

      <div class="row">
        <label class="stack">
          <span class="lbl">Ï†ÑÏ≤¥ÏßëÌï©: <b>N</b> Ïù¥ÌïòÏùò ÏûêÏó∞Ïàò</span>
          <input id="maxN" class="input" type="number" min="10" max="100" value="30" />
          <button class="outline" id="randomize">ÏßëÌï© A, B ÎûúÎç§ÏúºÎ°ú ÏñªÍ∏∞</button>
        </label>

        <div class="stack">
          <span class="lbl">ÏßëÌï© A</span>
          <div class="seg" id="typeA">
            <button data-type="mul" class="active">Î∞∞Ïàò</button>
            <button data-type="div">ÏïΩÏàò</button>
            <button data-type="prime">ÏÜåÏàò</button>
          </div>
          <select id="paramA" class="select"></select>
          <div class="hint" id="hintA"></div>
        </div>

        <div class="stack">
          <span class="lbl">ÏßëÌï© B</span>
          <div class="seg" id="typeB">
            <button data-type="mul" class="active">Î∞∞Ïàò</button>
            <button data-type="div">ÏïΩÏàò</button>
            <button data-type="prime">ÏÜåÏàò</button>
          </div>
          <select id="paramB" class="select"></select>
          <div class="hint" id="hintB"></div>
        </div>
      </div>

      <div class="row">
        <label class="stack">
          <span class="lbl">Í≤åÏûÑ ÏãúÍ∞Ñ</span>
          <div class="seg" id="timeSeg">
            <button data-t="30">30Ï¥à</button>
            <button data-t="60" class="active">60Ï¥à</button>
            <button data-t="90">90Ï¥à</button>
          </div>
        </label>
        <label class="stack">
          <span class="lbl">ÎÇúÏù¥ÎèÑ</span>
          <div class="seg" id="modeSeg">
            <button data-m="union" class="active">Easy : A‚à™BÏóêÏÑúÎßå</button>
            <button data-m="any">Hard : Ï†ÑÏ≤¥ÏßëÌï© UÏóêÏÑú</button>
          </div>
        </label>
      </div>

      <div class="actions">
        <button class="mode-btn practice-mode" id="practiceMode">
          <span class="mode-icon">üèπ</span>
          <span class="mode-text">Ïó∞Ïäµ Î™®Îìú</span>
        </button>
        <button class="mode-btn pvp-mode" id="pvpMode">
          <span class="mode-icon"> ‚öîÔ∏è </span>
          <span class="mode-text">PvP Î™®Îìú</span>
        </button>
      </div>
      
      <footer class="footer">
        <div>ÌñâÎ≥µÌïú ÏàòÌïô, Ìï®Íªò ÎßåÎì§Ïñ¥Ïöî! üòä</div>
        <div>¬© ÌñâÎ≥µÌïúÏú§Ïå§ | <a href="https://blog.naver.com/happy_yoonssam" target="_blank">https://blog.naver.com/happy_yoonssam</a></div>
      </footer>
    </div>
  </div>

  <!-- END OVERLAY -->
  <div class="overlay" id="end" style="display:none">
    <div class="card stack end">
      <div class="center">
        <div class="title">Í≤åÏûÑ Ï¢ÖÎ£å!</div>
        <div id="winMsg" class="lg" style="margin:6px 0 4px"></div>
        <div id="final" class="muted"></div>
      </div>
      <div class="actions" style="justify-content:center">
        <button class="outline" id="again">Îã§Ïãú ÌïòÍ∏∞</button>
        <button class="primary" id="settings">Ï≤´ ÌôîÎ©¥ÏúºÎ°ú</button>
      </div>
    </div>
  </div>

  <!-- VENN DIAGRAM CHALLENGE -->
  <div class="venn-modal" id="vennModal" style="display:none">
    <div class="venn-card">
      <div class="venn-title" id="vennTitle">1ÌîåÎ†àÏù¥Ïñ¥ ÏΩ§Î≥¥ Ï±åÎ¶∞ÏßÄ</div>
      
      <div class="venn-question">
        <h2 id="vennQ">A ‚à© B</h2>
        <div class="venn-timer">
          <div class="venn-timer-bar">
            <div id="vennTimerBar" class="venn-timer-fill"></div>
          </div>
        </div>
      </div>

      <canvas id="vennCanvas" class="venn-svg" width="400" height="320"></canvas>

      <div id="vennResult" style="display:none"></div>

      <button class="venn-btn check" id="vennCheck">Ï†ïÎãµ Ï†úÏ∂ú</button>
      <button class="venn-btn next" id="vennNext" style="display:none">Í≥ÑÏÜçÌïòÍ∏∞</button>
    </div>
  </div>

  <!-- RULES MODAL -->
  <div class="overlay" id="rulesModal" style="display:none">
    <div class="rules-card">
      <div class="rules-header">
        <h2 class="rules-title">üìö Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÌïôÏäµ</h2>
        <button class="rules-close" id="rulesClose">‚úï</button>
      </div>
      
      <div class="rules-content">
        <div class="rules-section">
          <h3>üéØ Í∏∞Î≥∏ Í∞úÎÖê</h3>
          <p>Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÄ ÏßëÌï©Ïùò Í¥ÄÍ≥ÑÎ•º ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÌëúÌòÑÌïòÎäî ÎèÑÍµ¨ÏûÖÎãàÎã§. Îëê Í∞úÏùò ÏõêÏúºÎ°ú AÏôÄ B ÏßëÌï©ÏùÑ ÎÇòÌÉÄÎÇ¥Í≥†, Í≤πÏπòÎäî Î∂ÄÎ∂ÑÍ≥º Í≤πÏπòÏßÄ ÏïäÎäî Î∂ÄÎ∂ÑÏùÑ Íµ¨Î∂ÑÌï©ÎãàÎã§.</p>
        </div>
        
        <div class="rules-section">
          <h3>üîç ÏòÅÏó≠Î≥Ñ ÏùòÎØ∏</h3>
          <div class="venn-areas">
            <div class="area-item">
              <div class="area-color only-a"></div>
              <div class="area-text">
                <strong>A-B</strong> : AÏóêÎßå ÏÜçÌï®
              </div>
            </div>
            <div class="area-item">
              <div class="area-color intersection"></div>
              <div class="area-text">
                <strong>A‚à©B</strong> : AÏôÄ BÎ™®ÎëêÏóê ÏÜçÌï®
              </div>
            </div>
            <div class="area-item">
              <div class="area-color only-b"></div>
              <div class="area-text">
                <strong>B-A</strong> : BÏóêÎßå ÏÜçÌï®
              </div>
            </div>
            <div class="area-item">
              <div class="area-color outside"></div>
              <div class="area-text">
                <strong>(A‚à™B)·∂ú</strong> : AÏôÄ BÏóê Î™®Îëê ÏÜçÌïòÏßÄ ÏïäÏùå
              </div>
            </div>
          </div>
        </div>
        
        <div class="rules-section">
          <h3>üéÆ Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÌïôÏäµ</h3>
          <p>Ïã§Ï†ú Ï±åÎ¶∞ÏßÄÏóê Îì±Ïû•ÌïòÎäî Î¨∏Ï†úÎ•º Ïó∞ÏäµÌï¥Î≥¥ÏÑ∏Ïöî! Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú Ï†ïÎãµÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
          <div class="interactive-venn">
            <div class="practice-controls">
              <button class="practice-btn" id="practiceEasy">Í∏∞Î≥∏ Î¨∏Ï†ú</button>
              <button class="practice-btn" id="practiceHard">ÌïòÎìú Î¨∏Ï†ú</button>
              <button class="practice-btn" id="practiceNext">Îã§Ïùå Î¨∏Ï†ú</button>
            </div>
            <div class="practice-question" id="practiceQuestion">Î¨∏Ï†úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
            <canvas id="rulesVennCanvas" width="500" height="400"></canvas>
            <div class="venn-instructions">
              <div class="region-meaning" id="regionMeaning"></div>
              <div class="practice-result" id="practiceResult"></div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <div class="feedback" id="fb"></div>

  <div class="info glass">
    <div class="scores">
      <div class="score p1">
        <div class="label">ÌîåÎ†àÏù¥Ïñ¥ 1</div>
        <div class="val" id="s1">0</div>
      </div>
      <div class="combo-display combo-p1" id="combo1"></div>
    </div>
    <div class="timer-wrap">
      <div class="game-title">üåê SET MASTER</div>
      <div class="bar"><div id="barInner"></div></div>
    </div>
    <div class="scores">
      <div class="combo-display combo-p2" id="combo2"></div>
      <div class="score p2">
        <div class="label">ÌîåÎ†àÏù¥Ïñ¥ 2</div>
        <div class="val" id="s2">0</div>
      </div>
    </div>
  </div>

  <div class="sets">
    <div class="setbox">
      <div class="desc" id="aDesc">‚Äì</div>
    </div>
    <div class="setbox">
      <div class="desc" id="bDesc">‚Äì</div>
    </div>
  </div>
  
  <!-- Î©îÏù∏ÌôîÎ©¥ ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº -->
  <button class="home-btn" id="homeBtn" title="Î©îÏù∏ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">
    <div class="home-content">
      <div class="home-icon">üè†</div>
      <div class="home-text">Î©îÏù∏</div>
    </div>
  </button>

  <div class="number">
    <div class="num" id="num">?</div>
  </div>

  <div class="controls">
    <div class="buttons p1">
      <button class="btn" data-p="1" data-a="A_MINUS_B" aria-label="AÏóêÏÑú BÎ•º Î∫Ä Ï∞®ÏßëÌï©">A‚àíB<br><span class="kbd">Q</span></button>
      <button class="btn" data-p="1" data-a="AB" aria-label="AÏôÄ BÏùò ÍµêÏßëÌï©">A‚à©B<br><span class="kbd">W</span></button>
      <button class="btn" data-p="1" data-a="B_MINUS_A" aria-label="BÏóêÏÑú AÎ•º Î∫Ä Ï∞®ÏßëÌï©">B‚àíA<br><span class="kbd">E</span></button>
      <button class="btn" data-p="1" data-a="NONE" id="p1-none" aria-label="AÏôÄ BÏùò Ìï©ÏßëÌï©Ïùò Ïó¨ÏßëÌï©">(A‚à™B)·∂ú<br><span class="kbd">R</span></button>
    </div>
    <div class="buttons p2">
      <button class="btn" data-p="2" data-a="A_MINUS_B" aria-label="AÏóêÏÑú BÎ•º Î∫Ä Ï∞®ÏßëÌï©">A‚àíB<br><span class="kbd">U</span></button>
      <button class="btn" data-p="2" data-a="AB" aria-label="AÏôÄ BÏùò ÍµêÏßëÌï©">A‚à©B<br><span class="kbd">I</span></button>
      <button class="btn" data-p="2" data-a="B_MINUS_A" aria-label="BÏóêÏÑú AÎ•º Î∫Ä Ï∞®ÏßëÌï©">B‚àíA<br><span class="kbd">O</span></button>
      <button class="btn" data-p="2" data-a="NONE" id="p2-none" aria-label="AÏôÄ BÏùò Ìï©ÏßëÌï©Ïùò Ïó¨ÏßëÌï©">(A‚à™B)·∂ú<br><span class="kbd">P</span></button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    'use strict';

    const el = (id)=>document.getElementById(id);
    const isPrime = (n)=>{
      if(n < 2) return false; if(n%2===0) return n===2; if(n%3===0) return n===3;
      for(let i=5;i*i<=n;i+=6){ if(n%i===0 || n%(i+2)===0) return false; }
      return true;
    };
    const isSquare = (n)=>{ const r = Math.floor(Math.sqrt(n)); return r*r === n; };
    const compositeNonSquaresUpTo = (N)=>{
      const arr=[]; 
      for(let i=4;i<=N;i++){ 
        if(!isPrime(i) && !isSquare(i)) {
          arr.push(i); 
        } 
      } 
      return arr;
    };

    const state = {
      N: 30,
      setA: { type:'mul', param: 2 },
      setB: { type:'mul', param: 3 },
      difficulty: 'union', // 'union' = Easy, 'any' = Hard
      time: 60,
      timeLeft: 60,
      playing: false,
      answered: false,
      num: 1,
      s: [0,0],
      combo: [0,0],
      timer: null,
      gameMode: 'pvp', // 'pvp' or 'practice'
      buttonOrder: { p1: ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'], p2: ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'] }, // Î≤ÑÌäº ÏàúÏÑú Ï†ÄÏû•
    };

    // Venn diagram problems by difficulty level
    const vennProblemsEasy = [
      { question: "A ‚à© B", answer: ["intersection"], description: "AÏôÄ BÏùò ÍµêÏßëÌï©" },
      { question: "A ‚à™ B", answer: ["onlyA", "intersection", "onlyB"], description: "AÏôÄ BÏùò Ìï©ÏßëÌï©" },
      { question: "A - B", answer: ["onlyA"], description: "AÏóêÏÑú BÎ•º Î∫Ä Ï∞®ÏßëÌï©" },
      { question: "B - A", answer: ["onlyB"], description: "BÏóêÏÑú AÎ•º Î∫Ä Ï∞®ÏßëÌï©" },
      { question: "A·∂ú", answer: ["onlyB", "outside"], description: "AÏùò Ïó¨ÏßëÌï©" },
      { question: "B·∂ú", answer: ["onlyA", "outside"], description: "BÏùò Ïó¨ÏßëÌï©" },
      { question: "A ‚à© B·∂ú", answer: ["onlyA"], description: "AÏôÄ BÏùò Ïó¨ÏßëÌï©Ïùò ÍµêÏßëÌï©" },
      { question: "A·∂ú ‚à© B", answer: ["onlyB"], description: "AÏùò Ïó¨ÏßëÌï©Í≥º BÏùò ÍµêÏßëÌï©" },
      { question: "(A ‚à© B)·∂ú", answer: ["onlyA", "onlyB", "outside"], description: "AÏôÄ BÏùò ÍµêÏßëÌï©Ïùò Ïó¨ÏßëÌï©" },
      { question: "(A ‚à™ B)·∂ú", answer: ["outside"], description: "AÏôÄ BÏùò Ìï©ÏßëÌï©Ïùò Ïó¨ÏßëÌï©" },
    ];

    const vennProblemsHard = [
      { question: "(A‚à™B)-(A‚à©B)", answer: ["onlyA", "onlyB"], description: "AÏôÄ B Ï§ë ÌïòÎÇòÏóêÎßå ÏÜçÌïòÎäî ÏõêÏÜåÎì§" },
      { question: "A·∂ú‚à©B·∂ú", answer: ["outside"], description: "AÏôÄ B Î™®ÎëêÏóê ÏÜçÌïòÏßÄ ÏïäÎäî ÏõêÏÜåÎì§" },
      { question: "(A-B)‚à™(B-A)", answer: ["onlyA", "onlyB"], description: "AÏôÄ B Ï§ë ÌïòÎÇòÏóêÎßå ÏÜçÌïòÎäî ÏõêÏÜåÎì§" },
      { question: "A·∂ú‚à™B·∂ú", answer: ["onlyA", "onlyB", "outside"], description: "AÏóê ÏÜçÌïòÏßÄ ÏïäÍ±∞ÎÇò BÏóê ÏÜçÌïòÏßÄ ÏïäÎäî ÏõêÏÜåÎì§" },
      { question: "(A‚à™B)‚à©(A‚à©B)·∂ú", answer: ["onlyA", "onlyB"], description: "AÏôÄ B Ï§ë ÌïòÎÇòÏóêÎßå ÏÜçÌïòÎäî ÏõêÏÜåÎì§" },
      { question: "A·∂ú‚à©(A‚à™B)", answer: ["onlyB"], description: "AÏùò Ïó¨ÏßëÌï©Í≥º AÏôÄ BÏùò Ìï©ÏßëÌï©Ïùò ÍµêÏßëÌï©" },
      { question: "B·∂ú‚à©(A‚à™B)", answer: ["onlyA"], description: "BÏùò Ïó¨ÏßëÌï©Í≥º AÏôÄ BÏùò Ìï©ÏßëÌï©Ïùò ÍµêÏßëÌï©" },
    ];

    const vennState = {
      currentProblem: null,
      selectedRegions: [],
      showResult: false,
      player: 1,
      timeLeft: 10,
      timer: null,
    };

    const s1 = el('s1'), s2 = el('s2');
    const combo1 = el('combo1'), combo2 = el('combo2');
    const bar = el('barInner');
    const aDesc = el('aDesc');
    const bDesc = el('bDesc');
    const numEl = el('num');
    const fb = el('fb');
    const startOv = el('start');
    const endOv = el('end');
    const winMsg = el('winMsg');
    const final = el('final');
    const maxNInput = el('maxN');
    const typeA = el('typeA');
    const typeB = el('typeB');
    const paramA = el('paramA');
    const paramB = el('paramB');
    const hintA = el('hintA');
    const hintB = el('hintB');

    const vennModal = el('vennModal');
    const vennQ = el('vennQ');
    const vennResult = el('vennResult');
    const vennCheck = el('vennCheck');
    const vennNext = el('vennNext');
    const vennTimerBar = el('vennTimerBar');
    const p1None = el('p1-none');
    const p2None = el('p2-none');

    function buildParamOptions(setKey){
      const type = state[setKey].type;
      const sel = setKey==='setA'? paramA : paramB;
      sel.innerHTML=''; sel.disabled=false; sel.style.display='';

      let values=[]; let labelFn=(v)=>v+'';
      if(type==='mul'){
        const upTo = Math.min(10, state.N);
        values = Array.from({length: Math.max(0, upTo-1)}, (_,i)=> i+2);
        labelFn = (v)=> `${v}Ïùò Î∞∞Ïàò`;
      } else if(type==='div'){
        const comps = compositeNonSquaresUpTo(state.N);
        values = comps; labelFn = (v)=> `${v}Ïùò ÏïΩÏàò`;
      } else if(type==='prime'){
        sel.disabled = true; sel.style.display='none';
      }

      for(const v of values){ const o=document.createElement('option'); o.value=v; o.textContent=labelFn(v); sel.appendChild(o); }

      if(type==='mul'){
        state[setKey].param = parseInt(sel.value || 2,10);
      } else if(type==='div'){
        const first = values[0] || 6;
        state[setKey].param = parseInt(sel.value || first,10);
      } else if(type==='prime'){
        state[setKey].param = null;
      }

      updateHints(); updateSetDesc();
    }

    function updateHints(){
      const a = state.setA, b = state.setB;
      hintA.textContent = a.type==='mul' ? `${a.param}Ïùò Î∞∞Ïàò ÏßëÌï©`
        : a.type==='div' ? `${a.param}Ïùò ÏïΩÏàò ÏßëÌï©`
        : `ÏÜåÏàò ÏßëÌï©`;
      hintB.textContent = b.type==='mul' ? `${b.param}Ïùò Î∞∞Ïàò ÏßëÌï©`
        : b.type==='div' ? `${b.param}Ïùò ÏïΩÏàò ÏßëÌï©`
        : `ÏÜåÏàò ÏßëÌï©`;
    }

    function updateSetDesc(){
      const a = state.setA, b = state.setB;
      aDesc.textContent = a.type==='mul' ? `A={x|xÎäî ${a.param}Ïùò Î∞∞Ïàò}`
        : a.type==='div' ? `A={x|xÎäî ${a.param}Ïùò ÏïΩÏàò}`
        : `A={x|xÎäî ÏÜåÏàò}`;
      bDesc.textContent = b.type==='mul' ? `B={x|xÎäî ${b.param}Ïùò Î∞∞Ïàò}`
        : b.type==='div' ? `B={x|xÎäî ${b.param}Ïùò ÏïΩÏàò}`
        : `B={x|xÎäî ÏÜåÏàò}`;
    }

    function inSet(n, set){
      if(set.type==='mul') return n % set.param === 0;
      if(set.type==='div') return set.param % n === 0;
      if(set.type==='prime') return isPrime(n);
      return false;
    }

    function correctFor(n){
      const inA = inSet(n, state.setA);
      const inB = inSet(n, state.setB);
      if(inA && inB) return 'AB';
      if(inA && !inB) return 'A_MINUS_B';
      if(!inA && inB) return 'B_MINUS_A';
      return 'NONE';
    }

    function showFB(text, ok=true){
      fb.textContent = text;
      fb.className = `feedback ${ok? 'ok':'bad'} show`;
      setTimeout(()=> fb.classList.remove('show'), 650);
    }
    

    function updateHUD(){
      s1.textContent = state.s[0];
      s2.textContent = state.s[1];
      
      // ÏΩ§Î≥¥ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (2Ï§ÑÎ°ú)
      if(state.combo[0] > 0) {
        const level = Math.min(Math.ceil(state.combo[0] / 3), 5);
        const newClassName = `combo-display combo-p1 combo-level-${level}`;
        
        // ÌÅ¥ÎûòÏä§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå HTML Ïû¨ÏÉùÏÑ±
        if(combo1.className !== newClassName) {
          let fireEmojis = 'üî•';
          if(state.combo[0] >= 4 && state.combo[0] <= 6) {
            fireEmojis = 'üî•üî•';
          } else if(state.combo[0] >= 7) {
            fireEmojis = 'üî•üî•üî•';
          }
          
          combo1.className = newClassName;
          combo1.innerHTML = `<div class="fire">${fireEmojis}</div><div class="text">${state.combo[0]}Ïó∞ÏÜç</div>`;
        } else {
          // ÌÅ¥ÎûòÏä§Í∞Ä Í∞ôÏúºÎ©¥ ÌÖçÏä§Ìä∏Îßå ÏóÖÎç∞Ïù¥Ìä∏
          const textElement = combo1.querySelector('.text');
          if(textElement) {
            textElement.textContent = `${state.combo[0]}Ïó∞ÏÜç`;
          }
        }
      } else {
        combo1.className = 'combo-display combo-p1';
        combo1.innerHTML = '';
      }
      
      if(state.combo[1] > 0) {
        const level = Math.min(Math.ceil(state.combo[1] / 3), 5);
        const newClassName = `combo-display combo-p2 combo-level-${level}`;
        
        // ÌÅ¥ÎûòÏä§Í∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå HTML Ïû¨ÏÉùÏÑ±
        if(combo2.className !== newClassName) {
          let fireEmojis = 'üî•';
          if(state.combo[1] >= 4 && state.combo[1] <= 6) {
            fireEmojis = 'üî•üî•';
          } else if(state.combo[1] >= 7) {
            fireEmojis = 'üî•üî•üî•';
          }
          
          combo2.className = newClassName;
          combo2.innerHTML = `<div class="fire">${fireEmojis}</div><div class="text">${state.combo[1]}Ïó∞ÏÜç</div>`;
        } else {
          // ÌÅ¥ÎûòÏä§Í∞Ä Í∞ôÏúºÎ©¥ ÌÖçÏä§Ìä∏Îßå ÏóÖÎç∞Ïù¥Ìä∏
          const textElement = combo2.querySelector('.text');
          if(textElement) {
            textElement.textContent = `${state.combo[1]}Ïó∞ÏÜç`;
          }
        }
      } else {
        combo2.className = 'combo-display combo-p2';
        combo2.innerHTML = '';
      }
      
      const ratio = Math.max(0, state.timeLeft) / state.time;
      bar.style.transform = `scaleX(${ratio})`;
      updateSetDesc();
      
      // Show/hide (A‚à™B)^c buttons and adjust layout based on difficulty
      const showNone = true; // Ìï≠ÏÉÅ 4Î≤àÏß∏ Î≤ÑÌäº ÌëúÏãú
      if(p1None) p1None.style.display = 'block';
      if(p2None) p2None.style.display = 'block';
      
      // Update button layout
      const p1Buttons = document.querySelector('.p1 .buttons');
      const p2Buttons = document.querySelector('.p2 .buttons');
      if(p1Buttons) p1Buttons.className = showNone ? 'buttons any-mode' : 'buttons';
      if(p2Buttons) p2Buttons.className = showNone ? 'buttons any-mode' : 'buttons';
      
      // Update button text based on combo
      updateButtonTexts();
      
      // Update UI based on game mode
      updateGameModeUI();
    }
    
    function updateButtonTexts(){
      // ÌîåÎ†àÏù¥Ïñ¥ 1 Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
      const p1Buttons = document.querySelectorAll('.p1 .btn');
      const p1Score = state.s[0];
      const p1IsHardMode = p1Score >= 10;
      
      // ÌïòÎìú Î™®Îìú ÏßÑÏûÖ Ïãú Î≤ÑÌäº ÏàúÏÑú ÎûúÎç§Ìôî
      if(p1IsHardMode && state.buttonOrder.p1[0] === 'A_MINUS_B') {
        randomizeButtonOrder('p1');
      }
      
      p1Buttons.forEach((btn, index) => {
        const answer = btn.dataset.a;
        const isHardMode = p1IsHardMode;
        console.log(`P1 Button ${answer}: score=${p1Score}, isHardMode=${isHardMode}`);
        btn.innerHTML = getButtonText(answer, p1Score, 1);
      });
      
      // ÌîåÎ†àÏù¥Ïñ¥ 2 Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (PvPÎ™®ÎìúÏóêÏÑúÎßå)
      if(state.gameMode === 'pvp'){
        const p2Buttons = document.querySelectorAll('.p2 .btn');
        const p2Score = state.s[1];
        const p2IsHardMode = p2Score >= 10;
        
        // ÌïòÎìú Î™®Îìú ÏßÑÏûÖ Ïãú Î≤ÑÌäº ÏàúÏÑú ÎûúÎç§Ìôî
        if(p2IsHardMode && state.buttonOrder.p2[0] === 'A_MINUS_B') {
          randomizeButtonOrder('p2');
        }
        
        p2Buttons.forEach((btn, index) => {
          const answer = btn.dataset.a;
          console.log(`P2 Button ${answer}: score=${p2Score}, isHardMode=${p2IsHardMode}`);
          btn.innerHTML = getButtonText(answer, p2Score, 2);
        });
      }
    }
    
    function getButtonText(answer, score, player = 1){
      const isHardMode = score >= 10;
      const keys = player === 1 ? ['Q', 'W', 'E', 'R'] : ['U', 'I', 'O', 'P'];
      
      switch(answer){
        case 'A_MINUS_B':
          return isHardMode ? `A‚à©B·∂ú<br><span class="kbd">${keys[0]}</span>` : `A‚àíB<br><span class="kbd">${keys[0]}</span>`;
        case 'AB':
          return `A‚à©B<br><span class="kbd">${keys[1]}</span>`;
        case 'B_MINUS_A':
          return isHardMode ? `A·∂ú‚à©B<br><span class="kbd">${keys[2]}</span>` : `B‚àíA<br><span class="kbd">${keys[2]}</span>`;
        case 'NONE':
          return isHardMode ? `A·∂ú‚à©B·∂ú<br><span class="kbd">${keys[3]}</span>` : `(A‚à™B)·∂ú<br><span class="kbd">${keys[3]}</span>`;
        default:
          return `A‚à©B<br><span class="kbd">${keys[1]}</span>`; // Í∏∞Î≥∏Í∞í
      }
    }
    
    function updateGameModeUI(){
      const isPractice = state.gameMode === 'practice';
      const p2Section = document.querySelector('.p2');
      const p2Score = document.querySelector('.scores .p2');
      
      if(isPractice){
        // Ïó∞ÏäµÎ™®Îìú: bodyÏóê ÌÅ¥ÎûòÏä§ Ï∂îÍ∞ÄÌïòÏó¨ CSSÎ°ú Ïà®Í∏∞Í∏∞
        document.body.classList.add('practice-mode-active');
        
        // ÌîåÎ†àÏù¥Ïñ¥ 1ÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ (ÌîåÎ†àÏù¥Ïñ¥ 1)
        const p1Label = document.querySelector('.p1 .player');
        if(p1Label) p1Label.textContent = 'ÌîåÎ†àÏù¥Ïñ¥ 1';
        
        // Í≤åÏûÑ Ï†úÎ™©ÏùÄ SET MASTERÎ°ú Ïú†ÏßÄ
        const gameTitle = document.querySelector('.game-title');
        if(gameTitle) gameTitle.textContent = 'üåê SET MASTER';
      } else {
        // PvPÎ™®Îìú: ÌÅ¥ÎûòÏä§ Ï†úÍ±∞ÌïòÍ≥† Î™®Îì† ÏÑπÏÖò ÌëúÏãú
        document.body.classList.remove('practice-mode-active');
        
        if(p2Section) p2Section.style.visibility = 'visible';
        if(p2Score) p2Score.style.visibility = 'visible';
        
        // ÌîåÎ†àÏù¥Ïñ¥ 1ÏùÑ ÏõêÎûòÎåÄÎ°ú
        const p1Label = document.querySelector('.p1 .player');
        if(p1Label) p1Label.textContent = 'ÌîåÎ†àÏù¥Ïñ¥ 1';
        
        // Í≤åÏûÑ Ï†úÎ™© ÏõêÎûòÎåÄÎ°ú
        const gameTitle = document.querySelector('.game-title');
        if(gameTitle) gameTitle.textContent = 'üåê SET MASTER';
      }
    }

    function startTimer(){
      clearInterval(state.timer);
      state.timer = setInterval(()=>{
        state.timeLeft -= 0.25;
        updateHUD();
        if(state.timeLeft<=0){ endGame(); }
      }, 250); // 0.25Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    
    // Î∞∞Ïó¥ÏùÑ ÎûúÎç§ÏúºÎ°ú ÏÑûÎäî Ìï®Ïàò (Fisher-Yates shuffle)
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    // ÌïòÎìú Î™®ÎìúÏóêÏÑú Î≤ÑÌäº ÏàúÏÑúÎ•º ÎûúÎç§ÏúºÎ°ú ÏÑ§Ï†ïÌïòÎäî Ìï®Ïàò
    function randomizeButtonOrder(player) {
      const answers = ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'];
      state.buttonOrder[player] = shuffleArray(answers);
      
      // Ïã§Ï†ú Î≤ÑÌäº ÏàúÏÑú Î≥ÄÍ≤Ω
      reorderButtons(player);
    }
    
    // Î≤ÑÌäºÏùò Ïã§Ï†ú ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÎäî Ìï®Ïàò
    function reorderButtons(player) {
      const playerClass = player === 'p1' ? '.p1' : '.p2';
      const buttonsContainer = document.querySelector(`${playerClass} .buttons`);
      if (!buttonsContainer) return;
      
      const buttons = Array.from(buttonsContainer.querySelectorAll('.btn'));
      const orderedButtons = [];
      
      // ÏÉàÎ°úÏö¥ ÏàúÏÑúÏóê Îî∞Îùº Î≤ÑÌäº Ïû¨Î∞∞Ïπò
      state.buttonOrder[player].forEach(answer => {
        const button = buttons.find(btn => btn.dataset.a === answer);
        if (button) {
          orderedButtons.push(button);
        }
      });
      
      // DOMÏóêÏÑú Î≤ÑÌäºÎì§ÏùÑ Ï†úÍ±∞ÌïòÍ≥† ÏÉàÎ°úÏö¥ ÏàúÏÑúÎ°ú Îã§Ïãú Ï∂îÍ∞Ä
      buttons.forEach(btn => btn.remove());
      orderedButtons.forEach(btn => buttonsContainer.appendChild(btn));
    }

    function pickNumber(){
      let n;
      if(state.difficulty==='union'){
        let tries=0;
        do { n = randInt(1, state.N); tries++; if(tries>500){ break; } }
        while(!inSet(n, state.setA) && !inSet(n, state.setB));
      } else {
        n = randInt(1, state.N);
      }
      state.num = n; numEl.textContent = n; state.answered=false;
    }

    function startGame(){
      state.N = Math.max(10, Math.min(100, parseInt(maxNInput.value||30,10)));
      state.s = [0,0]; 
      state.combo = [0,0];
      state.timeLeft = state.time; 
      state.playing = true; 
      state.answered=false;
      
      // Î≤ÑÌäº ÏàúÏÑú Ï¥àÍ∏∞Ìôî
      state.buttonOrder.p1 = ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'];
      state.buttonOrder.p2 = ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'];
      
      startOv.style.display='none'; 
      endOv.style.display='none';
      updateHUD(); 
      pickNumber(); 
      startTimer();
    }

    function endGame(){
      state.playing=false; 
      clearInterval(state.timer);
      const [a,b] = state.s;
      
      if(state.gameMode === 'practice'){
        winMsg.textContent = 'üéâ Ïó∞Ïäµ ÏôÑÎ£å!';
        winMsg.style.color = 'var(--p1)';
        final.innerHTML = `Ï¥ù Ï†êÏàò: <b>${a}</b>Ï†ê`;
      } else {
        if(a>b){ winMsg.textContent = 'üéâ ÌîåÎ†àÏù¥Ïñ¥ 1 ÏäπÎ¶¨!'; winMsg.style.color = 'var(--p1)'; }
        else if(b>a){ winMsg.textContent = 'üéâ ÌîåÎ†àÏù¥Ïñ¥ 2 ÏäπÎ¶¨!'; winMsg.style.color = 'var(--p2)'; }
        else { winMsg.textContent = 'ü§ù Î¨¥ÏäπÎ∂Ä!'; winMsg.style.color = 'var(--accent)'; }
        final.innerHTML = `ÌîåÎ†àÏù¥Ïñ¥ 1: <b>${a}</b>Ï†ê &nbsp;¬∑&nbsp; ÌîåÎ†àÏù¥Ïñ¥ 2: <b>${b}</b>Ï†ê`;
      }
      
      endOv.style.display='flex';
    }

    function startVennTimer() {
      vennState.timeLeft = 10;
      updateVennTimer();
      
      vennState.timer = setInterval(() => {
        vennState.timeLeft -= 0.2;
        updateVennTimer();
        
        if (vennState.timeLeft <= 0) {
          clearInterval(vennState.timer);
          // ÏãúÍ∞Ñ Ï¥àÍ≥º Ïãú ÏûêÎèôÏúºÎ°ú Ï†ïÎãµ Ï≤¥ÌÅ¨
          checkVennAnswer();
        }
      }, 200); // 0.2Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    }

    function updateVennTimer() {
      const ratio = Math.max(0, vennState.timeLeft) / 10;
      vennTimerBar.style.width = `${ratio * 100}%`;
    }

    function showVennChallenge(player){
      vennState.player = player;
      vennState.selectedRegions = [];
      vennState.showResult = false;
      
      // ÏΩ§Î≥¥ ÏàòÏ§ÄÏóê Îî∞Îùº Î¨∏Ï†ú ÎÇúÏù¥ÎèÑ Í≤∞Ï†ï
      const currentCombo = state.combo[player-1];
      const problems = currentCombo >= 4 ? vennProblemsHard : vennProblemsEasy;
      const problem = problems[randInt(0, problems.length-1)];
      vennState.currentProblem = problem;
      
      const vennTitle = el('vennTitle');
      const difficulty = currentCombo >= 4 ? ' HARD' : '' ;
      
      if(state.gameMode === 'practice'){
        vennTitle.textContent = `ÌîåÎ†àÏù¥Ïñ¥ 1 ÏΩ§Î≥¥ Ï±åÎ¶∞ÏßÄ üî•${difficulty}`;
        vennTitle.style.color = 'var(--p1)';
      } else {
        vennTitle.textContent = `${player}ÌîåÎ†àÏù¥Ïñ¥ ÏΩ§Î≥¥ Ï±åÎ¶∞ÏßÄ üî•${difficulty}`;
        vennTitle.style.color = player === 1 ? 'var(--p1)' : 'var(--p2)';
      }
      
      vennQ.textContent = problem.question;
      
      resetVennRegions();
      vennResult.style.display = 'none';
      vennCheck.style.display = 'block';
      vennNext.style.display = 'none';
      
      clearInterval(state.timer);
      vennModal.style.display = 'flex';
      
      // Ï¥àÍ∏∞ Îã§Ïù¥Ïñ¥Í∑∏Îû® Í∑∏Î¶¨Í∏∞
      drawVennDiagram();
      
      // Ï±åÎ¶∞ÏßÄ ÌÉÄÏù¥Î®∏ ÏãúÏûë
      startVennTimer();
    }

    // Canvas Í∏∞Î∞ò Venn Îã§Ïù¥Ïñ¥Í∑∏Îû®
    const vennCanvas = el('vennCanvas');
    const vennCtx = vennCanvas.getContext('2d');
    
    const vennGeom = {
      U: { x: 40, y: 40, w: 320, h: 240, r: 8 },
      A: { x: 160, y: 160, r: 80 },
      B: { x: 240, y: 160, r: 80 }
    };

    function drawVennDiagram() {
      vennCtx.clearRect(0, 0, vennCanvas.width, vennCanvas.height);
      
      // Universal set background
      vennCtx.fillStyle = '#f8fafc';
      vennCtx.fillRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
      
      // Draw selected regions
      vennState.selectedRegions.forEach(region => {
        drawVennRegion(region, '#2563eb', 1.0); // Îçî ÏßÑÌïú ÌååÎûÄÏÉâ
      });
      
      // Draw answer regions if showing result
      if(vennState.showResult) {
        vennState.currentProblem.answer.forEach(region => {
          drawVennRegion(region, '#059669', 1.0); // Îçî ÏßÑÌïú Ï¥àÎ°ùÏÉâ
        });
      }
      
      // Draw borders
      vennCtx.strokeStyle = '#64748b';
      vennCtx.lineWidth = 2;
      vennCtx.strokeRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
      
      vennCtx.strokeStyle = '#3b82f6';
      vennCtx.lineWidth = 3;
      vennCtx.beginPath();
      vennCtx.arc(vennGeom.A.x, vennGeom.A.y, vennGeom.A.r, 0, Math.PI * 2);
      vennCtx.stroke();
      
      vennCtx.strokeStyle = '#06b6d4';
      vennCtx.lineWidth = 3;
      vennCtx.beginPath();
      vennCtx.arc(vennGeom.B.x, vennGeom.B.y, vennGeom.B.r, 0, Math.PI * 2);
      vennCtx.stroke();
      
      // Draw labels
      vennCtx.fillStyle = '#000000'; // Í≤ÄÏ†ïÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
      vennCtx.font = 'bold 24px system-ui';
      vennCtx.textAlign = 'center';
      vennCtx.fillText('A', vennGeom.A.x - 20, vennGeom.A.y + 8);
      
      vennCtx.fillStyle = '#000000'; // Í≤ÄÏ†ïÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
      vennCtx.fillText('B', vennGeom.B.x + 20, vennGeom.B.y + 8);
      
      vennCtx.fillStyle = '#000000'; // Í≤ÄÏ†ïÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
      vennCtx.font = 'bold 20px system-ui';
      vennCtx.textAlign = 'left';
      vennCtx.fillText('U', vennGeom.U.x + 10, vennGeom.U.y + 25);
    }

    function drawVennRegion(region, color, opacity) {
      const offCanvas = document.createElement('canvas');
      offCanvas.width = vennCanvas.width;
      offCanvas.height = vennCanvas.height;
      const offCtx = offCanvas.getContext('2d');
      
      offCtx.fillStyle = color;
      offCtx.globalAlpha = 1.0; // Ìà¨Î™ÖÎèÑ Ï†úÍ±∞ - ÏôÑÏ†Ñ Î∂àÌà¨Î™Ö
      
      switch(region) {
        case 'outside':
          offCtx.fillRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(vennGeom.A.x, vennGeom.A.y, vennGeom.A.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.beginPath();
          offCtx.arc(vennGeom.B.x, vennGeom.B.y, vennGeom.B.r, 0, Math.PI * 2);
          offCtx.fill();
          break;
        case 'onlyA':
          offCtx.beginPath();
          offCtx.arc(vennGeom.A.x, vennGeom.A.y, vennGeom.A.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(vennGeom.B.x, vennGeom.B.y, vennGeom.B.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
          break;
        case 'onlyB':
          offCtx.beginPath();
          offCtx.arc(vennGeom.B.x, vennGeom.B.y, vennGeom.B.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(vennGeom.A.x, vennGeom.A.y, vennGeom.A.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
          break;
        case 'intersection':
          offCtx.beginPath();
          offCtx.arc(vennGeom.A.x, vennGeom.A.y, vennGeom.A.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.beginPath();
          offCtx.arc(vennGeom.B.x, vennGeom.B.y, vennGeom.B.r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(vennGeom.U.x, vennGeom.U.y, vennGeom.U.w, vennGeom.U.h);
          break;
      }
      
      vennCtx.drawImage(offCanvas, 0, 0);
    }

    function resetVennRegions(){
      vennState.selectedRegions = [];
      drawVennDiagram();
    }

    function toggleVennRegion(region){
      if(vennState.showResult) return;
      
      if(vennState.selectedRegions.includes(region)){
        vennState.selectedRegions = vennState.selectedRegions.filter(r => r !== region);
      } else {
        vennState.selectedRegions.push(region);
      }
      
      drawVennDiagram();
    }

    function checkVennAnswer(){
      // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
      clearInterval(vennState.timer);
      
      const selected = [...vennState.selectedRegions].sort();
      const correct = [...vennState.currentProblem.answer].sort();
      const isCorrect = JSON.stringify(selected) === JSON.stringify(correct);
      
      vennState.showResult = true;
      
      // Ïù¥Ï†Ñ ÏÑ†ÌÉù ÏòÅÏó≠ ÏßÄÏö∞Í≥† Ï†ïÎãµ ÏòÅÏó≠Îßå ÌëúÏãú
      vennState.selectedRegions = [];
      drawVennDiagram();
      
      if(isCorrect){
        vennResult.className = 'venn-result correct';
        vennResult.innerHTML = '<div style="font-size:1.5rem;font-weight:800">‚úì Ï†ïÎãµÏûÖÎãàÎã§!</div>';
      } else {
        vennResult.className = 'venn-result wrong';
        vennResult.innerHTML = '<div style="font-size:1.5rem;font-weight:800">‚úó ÌãÄÎ†∏ÏäµÎãàÎã§</div>';
        state.combo[vennState.player-1] = 0;
      }
      
      vennResult.style.display = 'block';
      vennCheck.style.display = 'none';
      vennNext.style.display = 'block';
    }

    function closeVennChallenge(){
      // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
      clearInterval(vennState.timer);
      
      vennModal.style.display = 'none';
      if(state.playing){
        startTimer();
        pickNumber();
      }
      updateHUD();
    }

    // Canvas ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
    function getRegionAtPoint(x, y) {
      const inA = Math.sqrt((x - vennGeom.A.x) ** 2 + (y - vennGeom.A.y) ** 2) <= vennGeom.A.r;
      const inB = Math.sqrt((x - vennGeom.B.x) ** 2 + (y - vennGeom.B.y) ** 2) <= vennGeom.B.r;
      const inU = x >= vennGeom.U.x && x <= vennGeom.U.x + vennGeom.U.w && 
                  y >= vennGeom.U.y && y <= vennGeom.U.y + vennGeom.U.h;
      
      if (!inU) return null;
      if (inA && inB) return 'intersection';
      if (inA) return 'onlyA';
      if (inB) return 'onlyB';
      return 'outside';
    }

    vennCanvas.addEventListener('click', (e) => {
      if(vennState.showResult) return;
      
      const rect = vennCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (vennCanvas.width / rect.width);
      const y = (e.clientY - rect.top) * (vennCanvas.height / rect.height);
      
      const region = getRegionAtPoint(x, y);
      if (region) {
        toggleVennRegion(region);
      }
    });


    function handleAnswer(player, ans){
      if(!state.playing || state.answered) return;
      
      // Ïó∞ÏäµÎ™®ÎìúÏóêÏÑúÎäî ÌîåÎ†àÏù¥Ïñ¥ 1Îßå ÎãµÎ≥Ä Í∞ÄÎä•
      if(state.gameMode === 'practice' && player !== 1) return;
      
      state.answered = true;
      const corr = correctFor(state.num);
      const ok = (ans === corr);
      
      if(ok){
        // 4ÏΩ§Î≥¥Î∂ÄÌÑ∞Îäî 2Ï†ê, Í∑∏ Ïô∏ÏóêÎäî 1Ï†ê
        const currentCombo = state.combo[player-1];
        const baseScore = currentCombo >= 4 ? 2 : 1;
        
        state.s[player-1] += baseScore;
        state.combo[player-1] += 1;
        state.combo[player === 1 ? 1 : 0] = 0;
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        updateHUD();
        
        if(state.combo[player-1] > 0 && state.combo[player-1] % 3 === 0){
          showFB(`${state.combo[player-1]}Ïó∞ÏÜç! Î≥¥ÎÑàÏä§ Ï±åÎ¶∞ÏßÄ!`, true);
          setTimeout(()=>{
            if(state.playing){
              showVennChallenge(player);
            }
          }, 700);
        } else {
          const playerText = state.gameMode === 'practice' ? 'ÌîåÎ†àÏù¥Ïñ¥ 1' : `ÌîåÎ†àÏù¥Ïñ¥ ${player}`;
          showFB(`${playerText} Ï†ïÎãµ!`, true);
          setTimeout(()=>{ if(state.playing){ pickNumber(); } }, 650);
        }
      } else {
        // Ïò§Îãµ Ïãú Ï†êÏàò Í∞êÏ†ê ÎåÄÏã† 0Ï†ê Ïú†ÏßÄ
        state.s[player-1] = Math.max(0, state.s[player-1]);
        state.combo[player-1] = 0;
        updateHUD();
        const playerText = state.gameMode === 'practice' ? 'ÌîåÎ†àÏù¥Ïñ¥ 1' : `ÌîåÎ†àÏù¥Ïñ¥ ${player}`;
        showFB(`${playerText} Ïò§Îãµ!`, false);
        setTimeout(()=>{ if(state.playing){ pickNumber(); } }, 650);
      }
    }

    function bindSeg(groupId, onSelect){
      const g = document.getElementById(groupId);
      if(!g) return;
      g.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        g.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        if(typeof onSelect==='function') onSelect(btn.dataset);
      });
    }

    bindSeg('typeA', (d)=>{ state.setA.type = d.type; buildParamOptions('setA'); });
    bindSeg('typeB', (d)=>{ state.setB.type = d.type; buildParamOptions('setB'); });

    if(paramA) paramA.addEventListener('change', ()=>{ state.setA.param = parseInt(paramA.value,10); updateHints(); updateSetDesc(); });
    if(paramB) paramB.addEventListener('change', ()=>{ state.setB.param = parseInt(paramB.value,10); updateHints(); updateSetDesc(); });

    function bindSimpleSeg(id, fn){ bindSeg(id, (d)=> fn(d)); }
    bindSimpleSeg('timeSeg', (d)=>{ state.time = parseInt(d.t,10); state.timeLeft = state.time; updateHUD(); });
    bindSimpleSeg('modeSeg', (d)=>{ state.difficulty = d.m; updateHUD(); });

    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      if(b.dataset && b.dataset.p){ handleAnswer(parseInt(b.dataset.p,10), b.dataset.a); }
    });

    document.addEventListener('keydown', (e)=>{
      if(!state.playing) return;
      const k = e.key.toLowerCase();
      
      // Ïó∞ÏäµÎ™®ÎìúÏóêÏÑúÎäî ÌîåÎ†àÏù¥Ïñ¥ 1 ÌÇ§Îßå ÏûëÎèô
      if(state.gameMode === 'practice'){
        const p1Answer = getAnswerFromKey(k, 'p1');
        if(p1Answer) return handleAnswer(1, p1Answer);
      } else {
        // PvPÎ™®ÎìúÏóêÏÑúÎäî Î™®Îì† ÌÇ§ ÏûëÎèô
        const p1Answer = getAnswerFromKey(k, 'p1');
        if(p1Answer) return handleAnswer(1, p1Answer);
        
        const p2Answer = getAnswerFromKey(k, 'p2');
        if(p2Answer) return handleAnswer(2, p2Answer);
      }
    });
    
    // ÌÇ§Î≥¥Îìú ÌÇ§Ïóê Îî∞Îùº ÎãµÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò (ÎûúÎç§ ÏàúÏÑú Í≥†Î†§)
    function getAnswerFromKey(key, player) {
      const p1Keys = ['q', 'w', 'e', 'r'];
      const p2Keys = ['u', 'i', 'o', 'p'];
      
      let keyIndex = -1;
      if(player === 'p1') {
        keyIndex = p1Keys.indexOf(key);
      } else if(player === 'p2') {
        keyIndex = p2Keys.indexOf(key);
      }
      
      if(keyIndex === -1) return null;
      
      // ÌïòÎìú Î™®ÎìúÍ∞Ä ÏïÑÎãàÎ©¥ Í∏∞Î≥∏ ÏàúÏÑú ÏÇ¨Ïö©
      const isHardMode = player === 'p1' ? state.s[0] >= 10 : state.s[1] >= 10;
      if(!isHardMode) {
        const defaultAnswers = ['A_MINUS_B', 'AB', 'B_MINUS_A', 'NONE'];
        return defaultAnswers[keyIndex];
      }
      
      // ÌïòÎìú Î™®ÎìúÎ©¥ ÎûúÎç§ ÏàúÏÑú ÏÇ¨Ïö©
      const playerKey = player === 'p1' ? 'p1' : 'p2';
      return state.buttonOrder[playerKey][keyIndex];
    }

    // Canvas Í∏∞Î∞ò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Îäî ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎê®

    vennCheck.addEventListener('click', checkVennAnswer);
    vennNext.addEventListener('click', closeVennChallenge);

    function randomizeSet(setKey){
      const types = ['mul','div','prime'];
      const type = types[randInt(0, types.length-1)];
      state[setKey].type = type;
      if(type==='mul'){
        const upTo = Math.min(10, state.N);
        state[setKey].param = randInt(2, Math.max(2, upTo));
      } else if(type==='div'){
        let comps = compositeNonSquaresUpTo(state.N);
        if(!comps.length){
          state[setKey].type = 'mul';
          const upTo = Math.min(10, state.N);
          state[setKey].param = Math.min(10, Math.max(2, upTo));
        } else {
          state[setKey].param = comps[randInt(0, comps.length-1)];
        }
      } else {
        state[setKey].param = null;
      }
      
      // Î≤ÑÌäº ÌôúÏÑ± ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const typeGroup = setKey === 'setA' ? typeA : typeB;
      typeGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
      const activeBtn = typeGroup.querySelector(`[data-type="${state[setKey].type}"]`);
      if(activeBtn) activeBtn.classList.add('active');
      
      buildParamOptions(setKey);
    }

    const randBtn = document.getElementById('randomize');
    if(randBtn){
      randBtn.addEventListener('click', ()=>{
        randomizeSet('setA');
        let tries=0; 
        do { randomizeSet('setB'); tries++; }
        while(tries<5 && state.setB.type===state.setA.type && state.setB.param===state.setA.param);
      });
    }

    // Mode selection buttons
    const practiceBtn = document.getElementById('practiceMode');
    const pvpBtn = document.getElementById('pvpMode');
    
    if(practiceBtn) {
      practiceBtn.addEventListener('click', ()=>{
        state.gameMode = 'practice';
        startGame();
      });
    }
    
    if(pvpBtn) {
      pvpBtn.addEventListener('click', ()=>{
        state.gameMode = 'pvp';
        startGame();
      });
    }
    
    const againBtn = document.getElementById('again');
    if(againBtn) againBtn.addEventListener('click', ()=>{ endOv.style.display='none'; startGame(); });
    const settingsBtn = document.getElementById('settings');
    if(settingsBtn) settingsBtn.addEventListener('click', ()=>{ endOv.style.display='none'; startOv.style.display='flex'; });
    
    // Î©îÏù∏ÌôîÎ©¥ ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäº
    const homeBtn = document.getElementById('homeBtn');
    if(homeBtn) {
      homeBtn.addEventListener('click', () => {
        // Í≤åÏûÑ Ï§ëÏù¥Î©¥ ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
        if(state.playing) {
          clearInterval(state.timer);
          state.playing = false;
        }
        // Î™®Îì† Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í≥† ÏãúÏûë ÌôîÎ©¥ ÌëúÏãú
        endOv.style.display = 'none';
        startOv.style.display = 'flex';
      });
    }
    
    // Î£∞Î∂Å Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    const rulesBtn = document.getElementById('rulesBtn');
    const rulesModal = document.getElementById('rulesModal');
    const rulesClose = document.getElementById('rulesClose');
    
    if(rulesBtn) {
      rulesBtn.addEventListener('click', () => {
        rulesModal.style.display = 'flex';
        initRulesVenn();
      });
    }
    
    if(rulesClose) {
      rulesClose.addEventListener('click', () => {
        rulesModal.style.display = 'none';
      });
    }
    
    // Î£∞Î∂Å Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    if(rulesModal) {
      rulesModal.addEventListener('click', (e) => {
        if(e.target === rulesModal) {
          rulesModal.style.display = 'none';
        }
      });
    }

    if(maxNInput) maxNInput.addEventListener('change', ()=>{ state.N = Math.max(10, Math.min(100, parseInt(maxNInput.value||30,10))); buildParamOptions('setA'); buildParamOptions('setB'); });
    state.N = parseInt(maxNInput.value,10);
    buildParamOptions('setA');
    buildParamOptions('setB');
    updateHints(); 
    updateSetDesc();
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏÉÅÌÉú
    const rulesVennState = {
      selectedRegions: [],
      canvas: null,
      ctx: null,
      currentProblem: null,
      isAnswered: false
    };
    
    // Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏòÅÏó≠Í≥º ÏßëÌï© Ïó∞ÏÇ∞ Îß§Ìïë
    const regionToSetOperation = {
      'onlyA': 'A-B : AÏóêÎßå ÏÜçÌï®',
      'intersection': 'A‚à©B : AÏôÄ BÎ™®ÎëêÏóê ÏÜçÌï®',
      'onlyB': 'B-A : BÏóêÎßå ÏÜçÌï®',
      'outside': '(A‚à™B)·∂ú : AÏôÄ BÏóê Î™®Îëê ÏÜçÌïòÏßÄ ÏïäÏùå'
    };
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® Ï¥àÍ∏∞Ìôî
    function initRulesVenn() {
      rulesVennState.canvas = document.getElementById('rulesVennCanvas');
      rulesVennState.ctx = rulesVennState.canvas.getContext('2d');
      rulesVennState.selectedRegions = [];
      rulesVennState.currentProblem = null;
      rulesVennState.isAnswered = false;
      
      drawRulesVenn();
      updateRegionMeaning();
      updatePracticeResult();
      
      // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
      rulesVennState.canvas.addEventListener('click', handleRulesVennClick);
      
      // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
      setupPracticeButtons();
    }
    
    // Ïó∞Ïäµ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    function setupPracticeButtons() {
      const practiceEasy = document.getElementById('practiceEasy');
      const practiceHard = document.getElementById('practiceHard');
      const practiceNext = document.getElementById('practiceNext');
      
      if(practiceEasy) {
        practiceEasy.addEventListener('click', () => {
          generatePracticeProblem('easy');
          setActiveButton(practiceEasy);
        });
      }
      
      if(practiceHard) {
        practiceHard.addEventListener('click', () => {
          generatePracticeProblem('hard');
          setActiveButton(practiceHard);
        });
      }
      
      if(practiceNext) {
        practiceNext.addEventListener('click', () => {
          if(rulesVennState.currentProblem) {
            generatePracticeProblem(rulesVennState.currentProblem.difficulty);
          }
        });
      }
    }
    
    // ÌôúÏÑ± Î≤ÑÌäº ÏÑ§Ï†ï
    function setActiveButton(activeBtn) {
      document.querySelectorAll('.practice-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      activeBtn.classList.add('active');
    }
    
    // Ïó∞Ïäµ Î¨∏Ï†ú ÏÉùÏÑ±
    function generatePracticeProblem(difficulty) {
      const problems = difficulty === 'easy' ? vennProblemsEasy : vennProblemsHard;
      const problem = problems[randInt(0, problems.length - 1)];
      
      rulesVennState.currentProblem = {
        ...problem,
        difficulty: difficulty
      };
      rulesVennState.selectedRegions = [];
      rulesVennState.isAnswered = false;
      
      // Î¨∏Ï†ú ÌëúÏãú
      const questionEl = document.getElementById('practiceQuestion');
      questionEl.textContent = problem.question;
      
      // Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® Îã§Ïãú Í∑∏Î¶¨Í∏∞
      drawRulesVenn();
      updateRegionMeaning();
      updatePracticeResult();
    }
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® Í∑∏Î¶¨Í∏∞
    function drawRulesVenn() {
      const canvas = rulesVennState.canvas;
      const ctx = rulesVennState.ctx;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Universal set background (Ï§ëÏïôÏóê Îçî ÌÅ∞ ÌÅ¨Í∏∞Î°ú)
      const U_x = 50;
      const U_y = 50;
      const U_w = 400;
      const U_h = 300;
      ctx.fillStyle = '#f8fafc';
      ctx.fillRect(U_x, U_y, U_w, U_h);
      
      // Draw selected regions
      rulesVennState.selectedRegions.forEach(region => {
        drawRulesVennRegion(region, '#2563eb', 1.0);
      });
      
      // Draw borders
      ctx.strokeStyle = '#64748b';
      ctx.lineWidth = 2;
      ctx.strokeRect(U_x, U_y, U_w, U_h);
      
      // Ïõê A (ÏôºÏ™Ω, Îçî ÌÅ¨Í≤å)
      const A_x = 200;
      const A_y = 200;
      const A_r = 80;
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(A_x, A_y, A_r, 0, Math.PI * 2);
      ctx.stroke();
      
      // Ïõê B (Ïò§Î•∏Ï™Ω, Îçî ÌÅ¨Í≤å)
      const B_x = 300;
      const B_y = 200;
      const B_r = 80;
      ctx.strokeStyle = '#06b6d4';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(B_x, B_y, B_r, 0, Math.PI * 2);
      ctx.stroke();
      
      // Draw labels (Îçî ÌÅ¨Í≥† Ï§ëÏïôÏóê)
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 28px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('A', A_x - 30, A_y + 8);
      ctx.fillText('B', B_x + 30, B_y + 8);
      
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 20px system-ui';
      ctx.textAlign = 'left';
      ctx.fillText('U', U_x + 10, U_y + 25);
    }
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏòÅÏó≠ Í∑∏Î¶¨Í∏∞
    function drawRulesVennRegion(region, color, opacity) {
      const canvas = rulesVennState.canvas;
      const ctx = rulesVennState.ctx;
      
      const offCanvas = document.createElement('canvas');
      offCanvas.width = canvas.width;
      offCanvas.height = canvas.height;
      const offCtx = offCanvas.getContext('2d');
      
      offCtx.fillStyle = color;
      offCtx.globalAlpha = 1.0;
      
      // ÏÉàÎ°úÏö¥ Ï¢åÌëú ÏÇ¨Ïö©
      const U_x = 50, U_y = 50, U_w = 400, U_h = 300;
      const A_x = 200, A_y = 200, A_r = 80;
      const B_x = 300, B_y = 200, B_r = 80;
      
      switch(region) {
        case 'outside':
          offCtx.fillRect(U_x, U_y, U_w, U_h);
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(A_x, A_y, A_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.beginPath();
          offCtx.arc(B_x, B_y, B_r, 0, Math.PI * 2);
          offCtx.fill();
          break;
        case 'onlyA':
          offCtx.beginPath();
          offCtx.arc(A_x, A_y, A_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(B_x, B_y, B_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(U_x, U_y, U_w, U_h);
          break;
        case 'onlyB':
          offCtx.beginPath();
          offCtx.arc(B_x, B_y, B_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-out';
          offCtx.beginPath();
          offCtx.arc(A_x, A_y, A_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(U_x, U_y, U_w, U_h);
          break;
        case 'intersection':
          offCtx.beginPath();
          offCtx.arc(A_x, A_y, A_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.beginPath();
          offCtx.arc(B_x, B_y, B_r, 0, Math.PI * 2);
          offCtx.fill();
          offCtx.globalCompositeOperation = 'destination-in';
          offCtx.fillRect(U_x, U_y, U_w, U_h);
          break;
      }
      
      ctx.drawImage(offCanvas, 0, 0);
    }
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÌÅ¥Î¶≠ Ï≤òÎ¶¨
    function handleRulesVennClick(e) {
      const canvas = rulesVennState.canvas;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      
      const region = getRulesRegionAtPoint(x, y);
      if (region) {
        toggleRulesVennRegion(region);
      }
    }
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏòÅÏó≠ ÌôïÏù∏
    function getRulesRegionAtPoint(x, y) {
      const A_x = 200, A_y = 200, A_r = 80;
      const B_x = 300, B_y = 200, B_r = 80;
      const U_x = 50, U_y = 50, U_w = 400, U_h = 300;
      
      const inA = Math.sqrt((x - A_x) ** 2 + (y - A_y) ** 2) <= A_r;
      const inB = Math.sqrt((x - B_x) ** 2 + (y - B_y) ** 2) <= B_r;
      const inU = x >= U_x && x <= U_x + U_w && y >= U_y && y <= U_y + U_h;
      
      if (!inU) return null;
      if (inA && inB) return 'intersection';
      if (inA) return 'onlyA';
      if (inB) return 'onlyB';
      return 'outside';
    }
    
    // Î£∞Î∂Å Î≤§Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏòÅÏó≠ ÌÜ†Í∏Ä
    function toggleRulesVennRegion(region) {
      if (rulesVennState.isAnswered) return; // Ïù¥ÎØ∏ ÎãµÏùÑ ÌôïÏù∏Ìïú Í≤ΩÏö∞ Î¨¥Ïãú
      
      if (rulesVennState.selectedRegions.includes(region)) {
        rulesVennState.selectedRegions = rulesVennState.selectedRegions.filter(r => r !== region);
      } else {
        rulesVennState.selectedRegions.push(region);
      }
      
      drawRulesVenn();
      updateRegionMeaning();
      checkPracticeAnswer();
    }
    
    // Ïó∞Ïäµ Î¨∏Ï†ú Ï†ïÎãµ ÌôïÏù∏
    function checkPracticeAnswer() {
      if (!rulesVennState.currentProblem || rulesVennState.isAnswered) return;
      
      const selected = [...rulesVennState.selectedRegions].sort();
      const correct = [...rulesVennState.currentProblem.answer].sort();
      const isCorrect = JSON.stringify(selected) === JSON.stringify(correct);
      
      if (isCorrect) {
        rulesVennState.isAnswered = true;
        updatePracticeResult('correct', 'Ï†ïÎãµÏûÖÎãàÎã§! üéâ');
      } else if (rulesVennState.selectedRegions.length > 0) {
        updatePracticeResult('wrong', 'Îã§Ïãú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî!');
      } else {
        updatePracticeResult('empty', '');
      }
    }
    
    // ÏòÅÏó≠ ÏùòÎØ∏ ÏóÖÎç∞Ïù¥Ìä∏
    function updateRegionMeaning() {
      const regionMeaningEl = document.getElementById('regionMeaning');
      if (!regionMeaningEl) return;
      
      if (rulesVennState.selectedRegions.length === 1) {
        const selectedRegion = rulesVennState.selectedRegions[0];
        regionMeaningEl.textContent = regionToSetOperation[selectedRegion] || '';
      } else {
        regionMeaningEl.textContent = '';
      }
    }
    
    // Ïó∞Ïäµ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
    function updatePracticeResult(type = 'empty', message = '') {
      const resultEl = document.getElementById('practiceResult');
      resultEl.className = `practice-result ${type}`;
      resultEl.textContent = message;
    }
  });
  </script>
</body>
</html>