<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤–AI ì›ì•ˆì§€ ê²€í† ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                formatError: (jax, error) => {
                    console.warn('MathJax ë Œë”ë§ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    return '';
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
        }
        
        /* ìƒë‹¨ íŒ¨ë„ */
        .header-panel {
            background: #fff; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 15px;
        }
        .header-panel select, .header-panel input {
            padding: 12px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 14px;
            transition: all 0.3s;
        }
        .header-panel select { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea; 
            font-weight: 600;
            cursor: pointer;
        }
        .header-panel select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .header-panel input[type="password"] { 
            flex: 1; 
            min-width: 250px; 
            border-color: #667eea;
        }
        .header-panel input[type="password"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { 
            display: flex; 
            gap: 20px; 
            height: calc(100vh - 150px);
            min-height: 600px;
        }
        
        @media (max-width: 1024px) {
            .container { flex-direction: column; height: auto; }
            #pdf-container { flex: none; height: 500px; }
            #crop-result { flex: none; max-height: 500px; }
        }
        
        /* ì™¼ìª½: PDF ìº”ë²„ìŠ¤ ì˜ì—­ (ë“œë¡­ì¡´) */
        #pdf-container { 
            flex: 6; 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            overflow-y: auto; 
            position: relative;
            text-align: center; 
            border: 3px dashed transparent; 
            transition: all 0.3s;
        }
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™” ì‹œ ìŠ¤íƒ€ì¼ */
        #pdf-container.drag-over {
            border-color: #667eea; 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: scale(1.01);
        }

        /* ì˜¤ë¥¸ìª½: ê²°ê³¼ ì˜ì—­ */
        #crop-result { 
            flex: 4; 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }
        #crop-result h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        /* ìº”ë²„ìŠ¤ ë˜í¼ (í˜ì´ì§€ë³„) */
        .page-wrapper {
            position: relative; 
            display: inline-block; 
            margin-bottom: 20px;
            margin-top: 60px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            background: white;
        }
        .page-wrapper canvas {
            display: block;
            border-radius: 0 0 8px 8px;
        }
        canvas { 
            display: block; 
            cursor: crosshair; 
            max-width: 100%;
            height: auto;
        }
        

        /* ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ (ì‚¬ìš©ì ìˆ˜ë™) */
        #selection-box { 
            position: fixed; 
            border: 3px dashed #FF5722; 
            background-color: rgba(255, 87, 34, 0.15); 
            display: none; 
            pointer-events: none; 
            z-index: 1000;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.5);
        }

        /* AI ì¶”ì²œ ë°•ìŠ¤ (ìë™) */
        .ai-box {
            position: absolute; 
            border: 3px solid #2196F3; 
            background-color: rgba(33, 150, 243, 0.2);
            cursor: move; 
            z-index: 50; 
            transition: all 0.2s;
            border-radius: 4px;
        }
        .ai-box:hover { 
            background-color: rgba(33, 150, 243, 0.4); 
            border-color: #1976D2;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }
        .ai-box-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #2196F3;
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
        }
        .ai-box:hover .ai-box-label {
            background: #1976D2;
        }
        .ai-box-click-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-weight: 900;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8), 0 0 12px rgba(0,0,0,0.6), 2px 2px 4px rgba(0,0,0,0.9);
            white-space: nowrap;
            z-index: 1;
            font-size: 16px;
        }
        
        /* í¬ê¸° ì¡°ì ˆ í•¸ë“¤ */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #2196F3;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 51;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .resize-handle:hover {
            background: #1976D2;
            transform: scale(1.3);
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }
        .resize-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }
        .resize-handle.ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }
        .resize-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }
        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }

        /* ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            border: 2px solid #e0e0e0; 
            border-radius: 12px; 
            padding: 15px; 
            background: #fff; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .card img { 
            max-width: 100%; 
            border-radius: 8px; 
            border: 2px solid #e0e0e0; 
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn-group { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        button { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-analyze { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            flex: 1;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-analyze:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-del { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(245, 87, 108, 0.3);
        }
        .btn-del:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 87, 108, 0.4);
        }
        .btn-add { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
        }
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 172, 254, 0.4);
        }
        .btn-add.active {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }
        .image-item {
            position: relative;
            width: 100%;
        }
        .image-item img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }
        .image-item .remove-img-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(245, 87, 108, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
            opacity: 0;
        }
        .image-item:hover .remove-img-btn {
            opacity: 1;
        }
        .image-item .remove-img-btn:hover {
            background: rgba(245, 87, 108, 1);
            transform: scale(1.1);
        }
        .image-count-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .ai-response { 
            background: #ffffff;
            padding: 20px; 
            border-radius: 10px; 
            font-size: 16px; 
            line-height: 1.8;
            min-height: 50px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }
        .ai-response::-webkit-scrollbar {
            width: 8px;
        }
        .ai-response::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .ai-response::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .ai-response::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .response-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-copy {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-copy:hover {
            background: #e0e0e0;
            color: #333;
        }
        .btn-copy.copied {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        .response-content {
            color: #333;
            font-size: 16px;
        }
        .response-content p {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        .response-content p:last-child {
            margin-bottom: 0;
        }
        .response-content strong {
            color: #667eea;
            font-weight: 700;
            display: block;
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 18px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e0e0e0;
        }
        .response-content strong:first-child {
            margin-top: 0;
        }
        .response-content em {
            color: #666;
            font-style: normal;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .response-content ul, .response-content ol {
            margin: 8px 0 8px 20px;
            padding: 0;
            color: #444;
        }
        .response-content li {
            margin: 6px 0;
            line-height: 1.7;
        }
        .response-content h1, .response-content h2, .response-content h3 {
            color: #667eea;
            margin: 16px 0 8px 0;
            font-weight: 700;
        }
        .response-content h1 {
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .response-content h2 {
            font-size: 18px;
        }
        .response-content h3 {
            font-size: 17px;
        }
        
        /* íŒì • ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        .verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 15px;
            width: 100%;
            justify-content: center;
        }
        .verdict-red {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
        }
        .verdict-yellow {
            background: #fff8e1;
            color: #f57c00;
            border: 2px solid #ffb74d;
        }
        .verdict-green {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #66bb6a;
        }
        .verdict-icon {
            font-size: 24px;
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .summary-text {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
        }
        
        .detail-toggle {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }
        .detail-toggle:hover {
            background: #e0e0e0;
            color: #333;
        }
        .detail-toggle.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .detail-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            animation: slideDown 0.3s ease;
        }
        .detail-content.show {
            display: block;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .loading { 
            color: #667eea; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 3px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-msg { 
            color: #d32f2f; 
            background: #ffebee; 
            padding: 12px; 
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state h2 {
            margin: 0 0 10px 0;
            color: #666;
        }
        
        /* ì¼ê´„ ê²€í†  ë²„íŠ¼ */
        .batch-review-section {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .batch-review-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-batch-review {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn-batch-review:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            background: white;
            border-color: white;
        }
        .btn-batch-review:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .batch-progress {
            margin-top: 12px;
            color: white;
            font-size: 14px;
            text-align: center;
            display: none;
            font-weight: 600;
        }
        .batch-progress.show {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        /* MathJax ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° */
        .MathJax_Error,
        mjx-merror,
        [class*="MathJax_Error"],
        [class*="merror"] {
            display: none !important;
            visibility: hidden !important;
        }
    </style>
</head>
<body>

    <div class="header-panel">
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; width: 100%;">
            <span style="font-size: 22px; font-weight: bold; margin-right: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent;">ğŸ“ AI ì›ì•ˆì§€ ê²€í† ê¸°</span>
            <select id="model-select">
                <option value="gemini-3-pro-preview" selected>ğŸš€ Gemini 3.0 Pro (í”„ë¦¬ë·°)</option>
                <option value="gemini-2.5-pro">ğŸš€ Gemini 2.5 Pro (ì¶”ì²œ)</option>
                <option value="gemini-1.5-pro">ğŸš€ Gemini 1.5 Pro (ì•ˆì •)</option>
                <option value="gemini-2.0-flash">âš¡ Gemini 2.0 Flash (ë¹ ë¦„)</option>
                <option value="gemini-1.5-flash">âš¡ Gemini 1.5 Flash (ë¹ ë¦„)</option>
            </select>
            <input type="password" id="api-key" placeholder="ğŸ”‘ API Key ì…ë ¥ (Google AI Studioì—ì„œ ë°œê¸‰)" style="flex: 1; min-width: 200px;">
            <button id="help-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(76, 175, 80, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 8px rgba(76, 175, 80, 0.3)';" onclick="toggleHelp()">ğŸ“– ì‚¬ìš©ë²•</button>
            <button id="settings-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.3)';" onclick="toggleSettings()">âš™ï¸ì„¤ì •</button>
            <button id="clear-cache-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 107, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 8px rgba(255, 107, 107, 0.3)';" onclick="clearCache()" title="ì €ì¥ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ">ğŸ§¹ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #667eea; font-size: 24px;">âš™ï¸ AI ê²€í†  ì„¤ì •</h2>
                <button onclick="toggleSettings()" style="background: #f5f5f5; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0e0e0';" onmouseout="this.style.background='#f5f5f5';">Ã—</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 18px;">ğŸ“š êµê³¼ëª©</label>
                <select id="subject-select" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea';" onblur="this.style.borderColor='#e0e0e0';">
                    <option value="êµ­ì–´">êµ­ì–´</option>
                    <option value="ì˜ì–´">ì˜ì–´</option>
                    <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                    <option value="ê³¼í•™">ê³¼í•™</option>
                    <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 18px;">ğŸ“Š ë¶„ì„ ìˆ˜ì¤€</label>
                <select id="analysis-level-select" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea';" onblur="this.style.borderColor='#e0e0e0';">
                    <option value="ìì„¸íˆ" selected>ìì„¸íˆ (ê¸°ë³¸)</option>
                    <option value="ê°„ëµíˆ">ê°„ëµíˆ</option>
                    <option value="ë‹µë§Œ">ë‹µë§Œ</option>
                </select>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 18px;">ğŸ“ ì¶”ê°€ ìš”êµ¬ì‚¬í•­</label>
                <textarea id="additional-requirements" placeholder="ì˜ˆ: íŠ¹ì • êµìœ¡ê³¼ì • ê¸°ì¤€ìœ¼ë¡œ ê²€í† , íŠ¹ì • ë‚œì´ë„ ê¸°ì¤€ ì ìš©, íŠ¹ì • í˜•ì‹ ìš”êµ¬ì‚¬í•­ ë“±&#10;AIê°€ ê²€í†  ì‹œ ì°¸ê³ í•  ì¶”ê°€ ìš”êµ¬ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical; min-height: 100px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea';" onblur="this.style.borderColor='#e0e0e0';"></textarea>
                <div style="margin-top: 5px; color: #999; font-size: 14px;">ğŸ’¡ ì´ ìš”êµ¬ì‚¬í•­ì€ AI ê²€í†  ì‹œ í”„ë¡¬í”„íŠ¸ì— ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</div>
            </div>
            
            <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="font-weight: 600; color: #333; font-size: 18px; margin: 0;">ğŸ“‹ í”„ë¡¬í”„íŠ¸ í¸ì§‘</label>
                    <button onclick="togglePromptEditor()" style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ë³´ê¸°/í¸ì§‘</button>
                </div>
                <div style="color: #666; font-size: 15px; margin-bottom: 10px;">AI ê²€í† ì— ì‚¬ìš©ë˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                <div id="prompt-editor-container" style="display: none; margin-top: 10px;">
                    <textarea id="prompt-editor" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; min-height: 200px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea';" onblur="this.style.borderColor='#e0e0e0';"></textarea>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button onclick="loadCurrentPrompt()" style="flex: 1; padding: 10px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">í˜„ì¬ í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="resetPrompt()" style="flex: 1; padding: 10px; background: #fff3cd; color: #856404; border: 1px solid #ffc107; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›</button>
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.3)';">ğŸ’¾ ì„¤ì • ì €ì¥</button>
        </div>
    </div>

    <!-- ì‚¬ìš©ë²• ëª¨ë‹¬ -->
    <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #4caf50; font-size: 24px;">ğŸ“– ì‚¬ìš©ë²• ì•ˆë‚´</h2>
                <button onclick="toggleHelp()" style="background: #f5f5f5; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e0e0e0';" onmouseout="this.style.background='#f5f5f5';">Ã—</button>
            </div>
            
            <div style="line-height: 1.8; color: #333; font-size: 16px;">
                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">1ï¸âƒ£ API Key ë°œê¸‰ ë° ì…ë ¥</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0 0 15px 0; font-weight: 600; color: #333;">ğŸ”‘ Google AI Studioì—ì„œ API Key ë°œê¸‰ë°›ê¸°:</p>
                    <ol style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">ë¸Œë¼ìš°ì €ì—ì„œ <a href="https://aistudio.google.com/apikey" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 600;">Google AI Studio</a>ì— ì ‘ì†í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">"Create API Key" ë˜ëŠ” "API í‚¤ ë§Œë“¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ìƒì„±ëœ API Keyë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ìƒë‹¨ì˜ "ğŸ”‘ API Key ì…ë ¥" í•„ë“œì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.</li>
                    </ol>
                    <p style="margin: 15px 0 0 0; color: #666; font-size: 14px;">ğŸ’¡ API KeyëŠ” ìë™ìœ¼ë¡œ ì €ì¥ë˜ë©°, ë‹¤ìŒì— ì ‘ì†í•  ë•Œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">2ï¸âƒ£ PDF íŒŒì¼ ì—…ë¡œë“œ</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">ì™¼ìª½ ì˜ì—­ì— PDF íŒŒì¼ì„ <strong>ë“œë˜ê·¸ ì•¤ ë“œë¡­</strong>í•˜ê±°ë‚˜, ì˜ì—­ì„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">PDF íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ìë™ìœ¼ë¡œ í˜ì´ì§€ë³„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">3ï¸âƒ£ ë¬¸ì œ ì˜ì—­ ì„ íƒ</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">PDF í˜ì´ì§€ì—ì„œ ê²€í† í•˜ê³  ì‹¶ì€ <strong>ë¬¸ì œ ì˜ì—­ì„ ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸</strong>í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ì„ íƒí•œ ì˜ì—­ì´ ë¹¨ê°„ìƒ‰ ì ì„ ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ì—¬ëŸ¬ ë¬¸ì œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìœ¼ë©°, ê° ë¬¸ì œëŠ” ì˜¤ë¥¸ìª½ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">4ï¸âƒ£ AI ê²€í†  ì‹¤í–‰</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0 0 15px 0; font-weight: 600;">ê°œë³„ ê²€í† :</p>
                    <ul style="margin: 0 0 15px 20px; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">ì˜¤ë¥¸ìª½ ëª©ë¡ì—ì„œ ê° ë¬¸ì œ ì¹´ë“œì˜ <strong>"âš¡ AI ê²€í† "</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">AIê°€ ë¬¸ì œë¥¼ ë¶„ì„í•˜ì—¬ ê²€í†  ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
                    </ul>
                    <p style="margin: 15px 0 0 0; font-weight: 600;">ì¼ê´„ ê²€í† :</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">ì—¬ëŸ¬ ë¬¸ì œë¥¼ ì„ íƒí•œ í›„, ìƒë‹¨ì˜ <strong>"ğŸš€ ì¼ê´„ ê²€í†  ì‹œì‘"</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ëª¨ë“  ë¬¸ì œê°€ ìˆœì°¨ì ìœ¼ë¡œ ìë™ ê²€í† ë©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ì§„í–‰ ìƒí™©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">5ï¸âƒ£ ê²€í†  ê²°ê³¼ í™•ì¸</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;"><strong>ğŸ”´ ë¹¨ê°„ë¶ˆ</strong>: ì¹˜ëª…ì  ì˜¤ë¥˜ - ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œ</li>
                        <li style="margin-bottom: 10px;"><strong>ğŸŸ¡ ë…¸ë€ë¶ˆ</strong>: ì˜¤ë¥˜ ì˜ì‹¬ / ì ê²€ í•„ìš” - ì„ ìƒë‹˜ í™•ì¸ì´ í•„ìš”í•œ ë¶€ë¶„</li>
                        <li style="margin-bottom: 10px;"><strong>ğŸŸ¢ ì´ˆë¡ë¶ˆ</strong>: ë¬¸ì œ ì—†ìŒ - ì •ìƒì ìœ¼ë¡œ ì¶œì œ ê°€ëŠ¥</li>
                        <li style="margin-bottom: 10px;">ê° ê²°ê³¼ ì¹´ë“œì—ì„œ <strong>"ğŸ“– ìì„¸íˆ ë³´ê¸°"</strong>ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸í•œ ë¶„ì„ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;"><strong>"ğŸ“‹ ì „ì²´ ë³µì‚¬"</strong> ë²„íŠ¼ìœ¼ë¡œ ê²€í†  ê²°ê³¼ë¥¼ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">6ï¸âƒ£ ì„¤ì • í™œìš©</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;"><strong>âš™ï¸ ì„¤ì •</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‹¤ìŒì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</li>
                        <li style="margin-left: 20px; margin-bottom: 10px;">ğŸ“š êµê³¼ëª© ì„ íƒ (êµ­ì–´, ì˜ì–´, ìˆ˜í•™, ê³¼í•™, ì‚¬íšŒ, ê¸°íƒ€)</li>
                        <li style="margin-left: 20px; margin-bottom: 10px;">ğŸ“Š ë¶„ì„ ìˆ˜ì¤€ ì„ íƒ (ìì„¸íˆ, ê°„ëµíˆ, ë‹µë§Œ)</li>
                        <li style="margin-left: 20px; margin-bottom: 10px;">ğŸ“ ì¶”ê°€ ìš”êµ¬ì‚¬í•­ ì…ë ¥</li>
                        <li style="margin-left: 20px; margin-bottom: 10px;">ğŸ“‹ í”„ë¡¬í”„íŠ¸ í¸ì§‘ (ê³ ê¸‰ ì‚¬ìš©ììš©)</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">7ï¸âƒ£ ê¸°íƒ€ ê¸°ëŠ¥</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;"><strong>ğŸ§¹ ì´ˆê¸°í™”</strong> ë²„íŠ¼: ì €ì¥ëœ ëª¨ë“  ë°ì´í„°(API Key, ì„¤ì • ë“±)ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;"><strong>ëª¨ë¸ ì„ íƒ</strong>: ìƒë‹¨ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 10px;">ê° ë¬¸ì œ ì¹´ë“œì˜ <strong>âŒ</strong> ë²„íŠ¼ìœ¼ë¡œ ê°œë³„ ë¬¸ì œë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-top: 25px;">
                    <p style="margin: 0; font-weight: 600; font-size: 18px;">ğŸ’¡ íŒ</p>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">ìˆ˜í•™ ë¬¸ì œì˜ ê²½ìš° LaTeX ìˆ˜ì‹ì´ ìë™ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.</li>
                        <li style="margin-bottom: 8px;">API KeyëŠ” ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê³ , íƒ€ì¸ê³¼ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="pdf-container">
            <div id="selection-box"></div>
            <div id="canvas-wrapper-inner">
                <div style="margin-top: 100px; color: #999; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“„</div>
                    <h1 style="color: #667eea; margin: 0 0 10px 0;">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h1>
                    <p style="margin: 0 0 20px 0;">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                    <input type="file" id="file-input" accept="application/pdf" style="display:none;">
                </div>
            </div>
        </div>

        <div id="crop-result">
            <h3>âœ‚ï¸ ë¬¸í•­ ë¶„ì„ ëª©ë¡</h3>
            <div class="batch-review-section" id="batch-review-section" style="display: none;">
                <button class="btn-batch-review" id="btn-batch-review" onclick="startBatchReview()">
                    <span>ğŸš€</span>
                    <span>ì¼ê´„ ê²€í†  ì‹œì‘</span>
                </button>
                <div class="batch-progress" id="batch-progress">
                    <div>ì§„í–‰ ì¤‘: <span id="progress-text">0 / 0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </div>
            <div id="crops-list">
                <div class="empty-state">
                    <h2>ğŸ“‹ ë¶„ì„í•  ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p>PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const pdfContainer = document.getElementById('pdf-container');
        const fileInput = document.getElementById('file-input');
        const canvasWrapperInner = document.getElementById('canvas-wrapper-inner');
        const selectionBox = document.getElementById('selection-box');
        const cropsList = document.getElementById('crops-list');
        const apiKeyInput = document.getElementById('api-key');
        const modelSelect = document.getElementById('model-select');

        let isDragging = false, startX, startY;
        let activeCanvas = null;
        let activeWrapper = null;
        let cropCount = 0;
        let addingToCardId = null; // ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•  ì¹´ë“œ ID (nullì´ë©´ ìƒˆ ì¹´ë“œ ìƒì„±)
        
        // ì„¤ì •ê°’ (ê¸°ë³¸ê°’)
        let settings = {
            subject: 'ê¸°íƒ€',
            analysisLevel: 'ìì„¸íˆ',
            additionalRequirements: '',
            customPrompt: '' // ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸ (ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©)
        };
        
        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (DOM ë¡œë“œ í›„ ì‹¤í–‰)
        function loadSettings() {
            const savedSettings = localStorage.getItem('exam_review_settings');
            if (savedSettings) {
                try {
                    settings = JSON.parse(savedSettings);
                    // ê¸°ì¡´ ì„¤ì •ì— í•„ë“œê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì´ˆê¸°í™”
                    if (!settings.additionalRequirements) {
                        settings.additionalRequirements = '';
                    }
                    if (!settings.customPrompt) {
                        settings.customPrompt = '';
                    }
                    const subjectSelect = document.getElementById('subject-select');
                    const analysisLevelSelect = document.getElementById('analysis-level-select');
                    const additionalRequirements = document.getElementById('additional-requirements');
                    if (subjectSelect) subjectSelect.value = settings.subject;
                    if (analysisLevelSelect) analysisLevelSelect.value = settings.analysisLevel;
                    if (additionalRequirements) additionalRequirements.value = settings.additionalRequirements || '';
                } catch (e) {
                    console.error('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', e);
                }
            }
        }
        
        // DOM ë¡œë“œ í›„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadSettings);
        } else {
            loadSettings();
        }
        
        // ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
        // ë¶„ì„ ìˆ˜ì¤€ì— ë”°ë¥¸ í† í° ì œí•œ ë° ìƒì„± ì„¤ì • ë°˜í™˜ í•¨ìˆ˜
        function getGenerationConfig() {
            const level = settings.analysisLevel;
            
            // ë¶„ì„ ìˆ˜ì¤€ì— ë”°ë¼ í† í° ì œí•œ ë° temperature ì¡°ì •
            let maxOutputTokens, temperature;
            
            if (level === 'ë‹µë§Œ') {
                maxOutputTokens = 2048;  // ìµœì†Œ í† í° (ë‹µë§Œ í•„ìš”)
                temperature = 0.3;        // ë‚®ì€ ì°½ì˜ì„± (ì •í™•í•˜ê³  ê°„ê²°í•˜ê²Œ)
            } else if (level === 'ê°„ëµíˆ') {
                maxOutputTokens = 4096;  // ì¤‘ê°„ í† í°
                temperature = 0.5;        // ì¤‘ê°„ ì°½ì˜ì„±
            } else { // 'ìì„¸íˆ'
                maxOutputTokens = 8192;  // ìµœëŒ€ í† í° (ìƒì„¸í•œ ë¶„ì„)
                temperature = 0.7;       // ë†’ì€ ì°½ì˜ì„± (í˜„ì¬ ê°’)
            }
            
            return {
                maxOutputTokens,
                temperature,
                topP: 0.95,
                topK: 40
            };
        }
        
        function generateReviewPrompt() {
            // ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
            if (settings.customPrompt && settings.customPrompt.trim()) {
                console.log('ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©');
                return settings.customPrompt.trim();
            }
            
            // ìµœì‹  ì„¤ì •ê°’ ì‚¬ìš© (í•­ìƒ ìµœì‹  settings ê°ì²´ ì°¸ì¡°)
            const subject = settings.subject;
            const level = settings.analysisLevel;
            
            // ë””ë²„ê¹…ìš© ë¡œê·¸ (ê°œë°œì ë„êµ¬ì—ì„œ í™•ì¸ ê°€ëŠ¥)
            console.log('í”„ë¡¬í”„íŠ¸ ìƒì„± - êµê³¼ëª©:', subject, 'ë¶„ì„ ìˆ˜ì¤€:', level);
            
            let prompt = `ì´ ì‹œí—˜ ë¬¸ì œë¥¼ ê²€í† í•˜ê³  ë‹¤ìŒ ê¸°ì¤€ì— ë”°ë¼ ì •í™•íˆ íŒì •í•´ì£¼ì„¸ìš”.`;
            
            if (subject !== 'ê¸°íƒ€') {
                prompt += `\n\nğŸ“š êµê³¼ëª©: ${subject}`;
            }
            
            prompt += `\n\nğŸš¦ [í™•ì •] AI ì‹œí—˜ì§€ ê²€í†  íŒì • ê¸°ì¤€

ğŸ”´ ë¹¨ê°„ë¶ˆ (ì¹˜ëª…ì  ì˜¤ë¥˜) - "ì´ëŒ€ë¡œ ì¶œì œí•˜ë©´ í°ì¼ ë‚©ë‹ˆë‹¤!"
ê¸°ì¤€: ì¶œì œ ì‹œ ì¬ì‹œí—˜ì´ í™•ì‹¤ì‹œë˜ëŠ” ì‹¬ê°í•œ ê²°í•¨.
ìƒí™©:
- ì •ë‹µ ì—†ìŒ / ë³µìˆ˜ ì •ë‹µ
- ìˆ˜ì‹ ë° ê³„ì‚°ì˜ ë…¼ë¦¬ì  ì˜¤ë¥˜
- ì¡°ê±´ ë¶€ì¡±ìœ¼ë¡œ ë¬¸ì œ ì„±ë¦½ ë¶ˆê°€
ì•¡ì…˜: ì„ ìƒë‹˜, ì´ê±´ ë¬´ì¡°ê±´ ìˆ˜ì •í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.

ğŸŸ¡ ë…¸ë€ë¶ˆ (ì˜¤ë¥˜ ì˜ì‹¬ / ì ê²€ í•„ìš”) - "í‹€ë¦° ê±´ ì•„ë‹Œë°... ì„ ìƒë‹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
ê¸°ì¤€: ë¬¸ì œëŠ” í’€ë¦¬ì§€ë§Œ, ì™„ì„±ë„ë‚˜ ê·œì •ì— ì–´ê¸‹ë‚  ì†Œì§€ê°€ ìˆìŒ.
ìƒí™©:
- ì¤‘ì˜ì  í‘œí˜„: í•™ìƒì´ ë‹¤ë¥´ê²Œ í•´ì„í•  ì—¬ì§€ê°€ ìˆìŒ
- ë‹¨ìˆœ ì˜¤íƒ€: 'í•¨ìˆ˜' â†’ 'í•¨ìŠ¤' (í’€ì´ëŠ” ê°€ëŠ¥í•˜ë‚˜ ìˆ˜ì • í•„ìš”)
- êµìœ¡ê³¼ì • ìœ„ë°˜ ì˜ì‹¬: "ì´ê±° ê³ 1 ê³¼ì • ë§ë‚˜ìš”? ì„ í–‰ ê°œë… ê°™ìŠµë‹ˆë‹¤."
- ê°€ë…ì„± ë¶ˆëŸ‰: í°íŠ¸ ê¹¨ì§, ê·¸ë˜í”„ íë¦¿í•¨, ê·¸ë¦¼ ì•ˆ ë³´ì„
ì•¡ì…˜: AIê°€ ì§€ì í•œ ë¶€ë¶„ì„ ë³´ì‹œê³  ë„˜ê¸¸ì§€, ìˆ˜ì •í• ì§€ ì„ ìƒë‹˜ì´ ê²°ì •í•´ ì£¼ì„¸ìš”.

ğŸŸ¢ ì´ˆë¡ë¶ˆ (ì •ìƒ) - "ì™„ë²½í•©ë‹ˆë‹¤."
ê¸°ì¤€: ì¶œì œí•´ë„ ì•„ë¬´ëŸ° ë¬¸ì œê°€ ì—†ëŠ” í´ë¦°í•œ ìƒíƒœ.
ìƒí™©:
- ë…¼ë¦¬, ê³„ì‚°, í‘œê¸°ë²•, êµìœ¡ê³¼ì • ì í•©ì„± ë“± ëª¨ë“  ë©´ì—ì„œ ì´ìƒ ì—†ìŒ
ì•¡ì…˜: ì•ˆì‹¬í•˜ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ì„¸ìš”.

**ì¤‘ìš”: ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:**

1. ì²« ì¤„ì— íŒì • ê²°ê³¼ë¥¼ ëª…í™•íˆ í‘œì‹œ: ğŸ”´ ë¹¨ê°„ë¶ˆ ë˜ëŠ” ğŸŸ¡ ë…¸ë€ë¶ˆ ë˜ëŠ” ğŸŸ¢ ì´ˆë¡ë¶ˆ

2. <<ìš”ì•½>> ì„¹ì…˜ (2-3ë¬¸ì¥):
   - íŒì • ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…
   - ê°€ì¥ ì¤‘ìš”í•œ ë¬¸ì œì  ë˜ëŠ” ì •ìƒì„ì„ ëª…ì‹œ`;

            if (level === 'ìì„¸íˆ') {
                prompt += `

3. <<ìì„¸í•œ ì„¤ëª…>> ì„¹ì…˜:
   - ì˜¤ë¥˜ ë‚´ìš© (ìˆëŠ” ê²½ìš°)
   - ë‚œì´ë„ í‰ê°€
   - **ê°„ëµí•œ í’€ì´ ê³¼ì •**: ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ ë‹¨ê³„ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…
   - **í•´ë‹µ**: 
     * ì£¼ê´€ì‹/ì„œìˆ í˜•: ì •ë‹µì„ ëª…í™•íˆ ì œì‹œ
     * ê°ê´€ì‹: ì •ë‹µ ë²ˆí˜¸(ì˜ˆ: â‘ , â‘¡, â‘¢, â‘£, â‘¤ ë˜ëŠ” 1ë²ˆ, 2ë²ˆ ë“±)ë¥¼ ëª…í™•íˆ í‘œì‹œí•˜ê³ , í•´ë‹¹ ì„ íƒì§€ì˜ ë‚´ìš©ë„ í•¨ê»˜ ì œì‹œ
   - í•™ìƒìš© í’€ì´ ê³¼ì • (ìƒì„¸)
   - ê°œì„  ì œì•ˆ (í•„ìš”í•œ ê²½ìš°)`;
            } else if (level === 'ê°„ëµíˆ') {
                prompt += `

3. <<ìì„¸í•œ ì„¤ëª…>> ì„¹ì…˜:
   - ì˜¤ë¥˜ ë‚´ìš© (ìˆëŠ” ê²½ìš°)
   - **í•´ë‹µ**: 
     * ì£¼ê´€ì‹/ì„œìˆ í˜•: ì •ë‹µì„ ëª…í™•íˆ ì œì‹œ
     * ê°ê´€ì‹: ì •ë‹µ ë²ˆí˜¸(ì˜ˆ: â‘ , â‘¡, â‘¢, â‘£, â‘¤)ë¥¼ ëª…í™•íˆ í‘œì‹œí•˜ê³ , í•´ë‹¹ ì„ íƒì§€ì˜ ë‚´ìš©ë„ í•¨ê»˜ ì œì‹œ
   - ê°„ëµí•œ í’€ì´ ê³¼ì •`;
            } else if (level === 'ë‹µë§Œ') {
                prompt += `

3. <<ìì„¸í•œ ì„¤ëª…>> ì„¹ì…˜:
   - **í•´ë‹µ**: 
     * ì£¼ê´€ì‹/ì„œìˆ í˜•: ì •ë‹µì„ ëª…í™•íˆ ì œì‹œ
     * ê°ê´€ì‹: ì •ë‹µ ë²ˆí˜¸(ì˜ˆ: â‘ , â‘¡, â‘¢, â‘£, â‘¤ ë˜ëŠ” 1ë²ˆ, 2ë²ˆ ë“±)ë¥¼ ëª…í™•íˆ í‘œì‹œí•˜ê³ , í•´ë‹¹ ì„ íƒì§€ì˜ ë‚´ìš©ë„ í•¨ê»˜ ì œì‹œ`;
            }
            
            prompt += `\n\në°˜ë“œì‹œ ğŸ”´, ğŸŸ¡, ğŸŸ¢ ì¤‘ í•˜ë‚˜ë¥¼ ì²« ì¤„ì— ëª…ì‹œí•˜ê³ , <<ìš”ì•½>>ê³¼ <<ìì„¸í•œ ì„¤ëª…>> ì„¹ì…˜ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
            
            // ì¶”ê°€ ìš”êµ¬ì‚¬í•­ì´ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ì— í¬í•¨
            if (settings.additionalRequirements && settings.additionalRequirements.trim()) {
                prompt += `\n\nğŸ“Œ ì¶”ê°€ ìš”êµ¬ì‚¬í•­:\n${settings.additionalRequirements.trim()}\n\nìœ„ ìš”êµ¬ì‚¬í•­ì„ ë°˜ë“œì‹œ ì°¸ê³ í•˜ì—¬ ê²€í† í•´ì£¼ì„¸ìš”.`;
            }
            
            return prompt;
        }
        
        
        // API Key ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }
        
        // API Key ì €ì¥
        apiKeyInput.addEventListener('blur', () => {
            if (apiKeyInput.value.trim()) {
                localStorage.setItem('gemini_api_key', apiKeyInput.value.trim());
            }
        });

        // --- 1. ë“œë˜ê·¸ ì•¤ ë“œë¡­ & íŒŒì¼ ì²˜ë¦¬ (ê°œì„ ) ---
        pdfContainer.addEventListener('click', (e) => {
            // ìº”ë²„ìŠ¤, ë²„íŠ¼, AI ë°•ìŠ¤ í´ë¦­ì´ ì•„ë‹ ë•Œë§Œ íŒŒì¼ì°½ ì—´ê¸°
            if (e.target.tagName === 'CANVAS' || 
                e.target.classList.contains('detect-btn') || 
                e.target.classList.contains('ai-box') ||
                e.target.closest('.ai-box') ||
                e.target.closest('.page-wrapper')) {
                return;
            }
            
            if (e.target === pdfContainer || 
                e.target === canvasWrapperInner || 
                e.target.parentElement === canvasWrapperInner ||
                canvasWrapperInner.contains(e.target)) {
                fileInput.click();
            }
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        // ë“œë˜ê·¸ íš¨ê³¼
        pdfContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfContainer.classList.add('drag-over');
        });
        pdfContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            pdfContainer.classList.remove('drag-over');
        });
        pdfContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfContainer.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        async function handleFile(file) {
            if (!file || file.type !== 'application/pdf') {
                alert('âŒ PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); 
                return;
            }
            
            try {
                canvasWrapperInner.innerHTML = '<div style="padding: 50px; color: #667eea;"><div class="loading"></div> PDF ë¡œë”© ì¤‘...</div>';
            const buffer = await file.arrayBuffer();
            canvasWrapperInner.innerHTML = ''; // ì´ˆê¸°í™”
            
            const pdf = await pdfjsLib.getDocument(buffer).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                    await renderPage(pdf, i);
                }
            } catch (error) {
                console.error('PDF ë¡œë”© ì˜¤ë¥˜:', error);
                alert('âŒ PDF íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                canvasWrapperInner.innerHTML = `
                    <div style="margin-top: 100px; color: #999; padding: 40px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“„</div>
                        <h1 style="color: #667eea; margin: 0 0 10px 0;">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h1>
                        <p style="margin: 0 0 20px 0;">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                        <input type="file" id="file-input" accept="application/pdf" style="display:none;">
                    </div>
                `;
            }
        }

        async function renderPage(pdf, pageNum) {
            const page = await pdf.getPage(pageNum);
            const scale = 2.0; // ê³ í™”ì§ˆ ë Œë”ë§
            const viewport = page.getViewport({ scale: scale });

            // ë˜í¼ ìƒì„± (ìº”ë²„ìŠ¤ + ë²„íŠ¼ + ì˜¤ë²„ë ˆì´ ë‹´ì„ ê³µê°„)
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            
            // ìº”ë²„ìŠ¤ ìƒì„±
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            // í™”ë©´ í‘œì‹œìš© ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜•)
            canvas.style.width = (viewport.width / scale) + 'px'; 
            canvas.style.height = (viewport.height / scale) + 'px';
            
            wrapper.appendChild(canvas);
            canvasWrapperInner.appendChild(wrapper);

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            
            // ìˆ˜ë™ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì—°ê²°
            addManualCropEvents(canvas, wrapper);
        }

        // --- 2. ì¢Œí‘œ ë³´ì •ëœ ìˆ˜ë™ ë“œë˜ê·¸ ì»· (ê°œì„ ) ---
        function addManualCropEvents(canvas, wrapper) {
            canvas.addEventListener('mousedown', e => {
                // AI ë°•ìŠ¤ í´ë¦­ì´ ì•„ë‹ ë•Œë§Œ ë“œë˜ê·¸ ì‹œì‘
                if (e.target.classList.contains('ai-box') || e.target.closest('.ai-box')) {
                    return;
                }
                
                e.preventDefault();
                isDragging = true; 
                activeCanvas = canvas;
                activeWrapper = wrapper;
                
                // ì¶”ê°€ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì•ˆë‚´
                if (addingToCardId) {
                    const card = document.getElementById(addingToCardId);
                    if (card) {
                        card.style.boxShadow = '0 0 20px rgba(79, 172, 254, 0.6)';
                        setTimeout(() => {
                            card.style.boxShadow = '';
                        }, 500);
                    }
                }
                
                const rect = canvas.getBoundingClientRect();
                
                // í™”ë©´ì— ë³´ì´ëŠ” ë°•ìŠ¤ë¥¼ ê·¸ë¦¬ê¸° ìœ„í•œ ì¢Œí‘œ (Fixed position)
                selectionBox.style.display = 'block';
                startX = e.clientX;
                startY = e.clientY;
                
                // ë°•ìŠ¤ ì´ˆê¸° ìœ„ì¹˜ (fixed positioning)
                selectionBox.style.left = startX + 'px';
                selectionBox.style.top = startY + 'px';
                selectionBox.style.width = '0px';
                selectionBox.style.height = '0px';
            });

            document.addEventListener('mousemove', e => {
                if (!isDragging || !activeCanvas) return;
                
                const curX = e.clientX;
                const curY = e.clientY;
                
                const w = Math.abs(curX - startX);
                const h = Math.abs(curY - startY);
                const left = Math.min(curX, startX);
                const top = Math.min(curY, startY);

                selectionBox.style.width = w + 'px';
                selectionBox.style.height = h + 'px';
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
            });

            document.addEventListener('mouseup', e => {
                if (!isDragging || !activeCanvas) return;
                isDragging = false; 
                selectionBox.style.display = 'none';
                
                const rect = activeCanvas.getBoundingClientRect();
                const scaleX = activeCanvas.width / rect.width;
                const scaleY = activeCanvas.height / rect.height;

                const mouseEndX = e.clientX;
                const mouseEndY = e.clientY;

                // ìº”ë²„ìŠ¤ ë‚´ë¶€ ì¢Œí‘œë¡œ ë³€í™˜
                const relativeStartX = Math.max(0, Math.min((startX - rect.left) * scaleX, activeCanvas.width));
                const relativeStartY = Math.max(0, Math.min((startY - rect.top) * scaleY, activeCanvas.height));
                const relativeEndX = Math.max(0, Math.min((mouseEndX - rect.left) * scaleX, activeCanvas.width));
                const relativeEndY = Math.max(0, Math.min((mouseEndY - rect.top) * scaleY, activeCanvas.height));

                const x = Math.min(relativeStartX, relativeEndX);
                const y = Math.min(relativeStartY, relativeEndY);
                const w = Math.abs(relativeEndX - relativeStartX);
                const h = Math.abs(relativeEndY - relativeStartY);

                // ìµœì†Œ í¬ê¸° ì²´í¬
                if (w > 30 && h > 30) {
                    cropImage(activeCanvas, x, y, w, h);
                    
                    // ì¶”ê°€ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    if (addingToCardId) {
                        const card = document.getElementById(addingToCardId);
                        if (card) {
                            const responseDiv = document.getElementById(`response-${addingToCardId}`);
                            if (responseDiv && !responseDiv.querySelector('.verdict-badge')) {
                                responseDiv.innerHTML = `
                                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%); border-radius: 8px; border: 2px dashed #4facfe;">
                                        <div style="font-size: 32px; margin-bottom: 10px;">âœ…</div>
                                        <div style="color: #4facfe; font-weight: 600; margin-bottom: 5px;">ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                                        <div style="color: #666; font-size: 13px;">ê³„ì† ì¶”ê°€í•˜ê±°ë‚˜ "â• ì¶”ê°€" ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ì·¨ì†Œí•˜ì„¸ìš”</div>
                                    </div>
                                `;
                            }
                        }
                    }
                }
                
                activeCanvas = null;
                activeWrapper = null;
            });
        }


        // --- ê³µí†µ: ì´ë¯¸ì§€ ìë¥´ê¸° & ê²°ê³¼ ìƒì„± (ê°œì„ ) ---
        function cropImage(sourceCanvas, x, y, w, h) {
            // ì¢Œí‘œ ê²€ì¦ ë° ë³´ì •
            x = Math.max(0, Math.min(x, sourceCanvas.width));
            y = Math.max(0, Math.min(y, sourceCanvas.height));
            w = Math.max(1, Math.min(w, sourceCanvas.width - x));
            h = Math.max(1, Math.min(h, sourceCanvas.height - y));
            
            if (w <= 0 || h <= 0) {
                console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ í¬ê¸°:', w, h);
                return;
            }
            
            const destCanvas = document.createElement('canvas');
            destCanvas.width = w;
            destCanvas.height = h;
            
            const ctx = destCanvas.getContext('2d');
            ctx.drawImage(sourceCanvas, x, y, w, h, 0, 0, w, h);
            const imgData = destCanvas.toDataURL('image/png', 0.95);

            // ê¸°ì¡´ ì¹´ë“œì— ì´ë¯¸ì§€ ì¶”ê°€ ëª¨ë“œì¸ì§€ í™•ì¸
            if (addingToCardId) {
                const card = document.getElementById(addingToCardId);
                if (card) {
                    addImageToCard(card, imgData);
                    // ì¶”ê°€ ëª¨ë“œ í•´ì œ
                    cancelAddMode();
                    return;
                }
            }

            // ìƒˆ ì¹´ë“œ ìƒì„±
            cropCount++;
            const cardId = `crop-${cropCount}`;

            const card = document.createElement('div');
            card.className = 'card';
            card.id = cardId;
            card.dataset.images = JSON.stringify([imgData]); // ì´ë¯¸ì§€ ë°°ì—´ ì €ì¥
            
            card.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 12px; font-weight: 600; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ“‹ ë¬¸í•­ #${cropCount}</span>
                </div>
                <div class="images-container" id="images-${cardId}">
                    <div class="image-item">
                        <img src="${imgData}" alt="ì„ íƒí•œ ì˜ì—­" class="crop-image" onclick="toggleImageZoom(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn-analyze" onclick="analyzeImage(this, '${cardId}')">âš¡ AI ê²€í† </button>
                    <button class="btn-add" id="btn-add-${cardId}" onclick="enableAddMode('${cardId}')">â• ì¶”ê°€</button>
                    <button class="btn-del" onclick="removeCard('${cardId}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                <div class="ai-response" id="response-${cardId}">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">â³</div>
                        <div>AI ê²€í† ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>
                </div>
            `;
            
            // ë¹ˆ ìƒíƒœ ì œê±°
            const emptyState = cropsList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            // ì¼ê´„ ê²€í†  ë²„íŠ¼ í‘œì‹œ
            const batchSection = document.getElementById('batch-review-section');
            if (batchSection) {
                batchSection.style.display = 'block';
            }
            
            cropsList.appendChild(card);
            cropsList.scrollTop = cropsList.scrollHeight;
            
            // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(-20px)';
                card.style.transition = 'all 0.3s';
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 10);
            }, 10);
        }
        
        // ì¹´ë“œì— ì´ë¯¸ì§€ ì¶”ê°€ í•¨ìˆ˜
        function addImageToCard(card, imgData) {
            const cardId = card.id;
            const imagesContainer = document.getElementById(`images-${cardId}`);
            if (!imagesContainer) return;
            
            // ê¸°ì¡´ ì´ë¯¸ì§€ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
            let images = [];
            try {
                images = JSON.parse(card.dataset.images || '[]');
            } catch (e) {
                // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
                const firstImg = card.querySelector('.crop-image');
                if (firstImg && firstImg.src) {
                    images = [firstImg.src];
                }
            }
            
            // ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
            images.push(imgData);
            card.dataset.images = JSON.stringify(images);
            
            // ì´ë¯¸ì§€ ì•„ì´í…œ ìƒì„±
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            const imageIndex = images.length;
            imageItem.innerHTML = `
                <div class="image-count-badge">${imageIndex}</div>
                <img src="${imgData}" alt="ì¶”ê°€ëœ ì˜ì—­" class="crop-image" onclick="toggleImageZoom(this)">
                <button class="remove-img-btn" onclick="removeImageFromCard('${cardId}', ${imageIndex - 1})" title="ì´ë¯¸ì§€ ì‚­ì œ">Ã—</button>
            `;
            
            imagesContainer.appendChild(imageItem);
            
            // ê¸°ì¡´ ì´ë¯¸ì§€ì—ë„ ë°°ì§€ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°)
            const existingItems = imagesContainer.querySelectorAll('.image-item');
            existingItems.forEach((item, idx) => {
                if (!item.querySelector('.image-count-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'image-count-badge';
                    badge.textContent = idx + 1;
                    item.insertBefore(badge, item.firstChild);
                }
                if (!item.querySelector('.remove-img-btn')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-img-btn';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.title = 'ì´ë¯¸ì§€ ì‚­ì œ';
                    removeBtn.onclick = () => removeImageFromCard(cardId, idx);
                    item.appendChild(removeBtn);
                }
            });
            
            // ì¶”ê°€ ëª¨ë“œëŠ” ìœ ì§€ (ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì—°ì†ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡)
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì·¨ì†Œí•˜ê±°ë‚˜ AI ê²€í† ë¥¼ ì‹œì‘í•  ë•Œ í•´ì œë¨
        }
        
        // ì¹´ë“œì—ì„œ ì´ë¯¸ì§€ ì œê±° í•¨ìˆ˜
        window.removeImageFromCard = function(cardId, imageIndex) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            let images = [];
            try {
                images = JSON.parse(card.dataset.images || '[]');
            } catch (e) {
                return;
            }
            
            if (imageIndex < 0 || imageIndex >= images.length) return;
            
            // ì´ë¯¸ì§€ ì œê±°
            images.splice(imageIndex, 1);
            card.dataset.images = JSON.stringify(images);
            
            // UI ì—…ë°ì´íŠ¸
            const imagesContainer = document.getElementById(`images-${cardId}`);
            if (imagesContainer) {
                imagesContainer.innerHTML = '';
                images.forEach((imgData, idx) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <div class="image-count-badge">${idx + 1}</div>
                        <img src="${imgData}" alt="ì„ íƒí•œ ì˜ì—­" class="crop-image" onclick="toggleImageZoom(this)">
                        <button class="remove-img-btn" onclick="removeImageFromCard('${cardId}', ${idx})" title="ì´ë¯¸ì§€ ì‚­ì œ">Ã—</button>
                    `;
                    imagesContainer.appendChild(imageItem);
                });
            }
            
            // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ì‚­ì œ
            if (images.length === 0) {
                removeCard(cardId);
            }
        };
        
        // ì´ë¯¸ì§€ ì¶”ê°€ ëª¨ë“œ í™œì„±í™”
        window.enableAddMode = function(cardId) {
            // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (addingToCardId === cardId) {
                cancelAddMode();
                return;
            }
            
            // ê¸°ì¡´ ì¶”ê°€ ëª¨ë“œ í•´ì œ
            if (addingToCardId) {
                cancelAddMode();
            }
            
            addingToCardId = cardId;
            const btn = document.getElementById(`btn-add-${cardId}`);
            const card = document.getElementById(cardId);
            
            if (btn) {
                btn.classList.add('active');
                btn.innerHTML = '<span>â¸ï¸</span><span>ì¶”ê°€ ëª¨ë“œ</span>';
            }
            
            if (card) {
                card.style.border = '3px solid #4facfe';
                card.style.boxShadow = '0 0 15px rgba(79, 172, 254, 0.5)';
            }
            
            // ì•ˆë‚´ ë©”ì‹œì§€
            const responseDiv = document.getElementById(`response-${cardId}`);
            if (responseDiv) {
                responseDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%); border-radius: 8px; border: 2px dashed #4facfe;">
                        <div style="font-size: 32px; margin-bottom: 10px;">â•</div>
                        <div style="color: #4facfe; font-weight: 600; margin-bottom: 5px;">ì´ë¯¸ì§€ ì¶”ê°€ ëª¨ë“œ í™œì„±í™”</div>
                        <div style="color: #666; font-size: 13px;">PDFì—ì„œ ë“œë˜ê·¸í•˜ì—¬ ì˜ì—­ì„ ì„ íƒí•˜ë©´<br>ì´ ë¬¸í•­ì— ì´ë¯¸ì§€ê°€ ì¶”ê°€ë©ë‹ˆë‹¤</div>
                        <div style="margin-top: 10px; color: #999; font-size: 12px;">"â• ì¶”ê°€" ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì·¨ì†Œë©ë‹ˆë‹¤</div>
                    </div>
                `;
            }
        };
        
        // ì´ë¯¸ì§€ ì¶”ê°€ ëª¨ë“œ ì·¨ì†Œ
        function cancelAddMode() {
            if (addingToCardId) {
                const btn = document.getElementById(`btn-add-${addingToCardId}`);
                const card = document.getElementById(addingToCardId);
                
                if (btn) {
                    btn.classList.remove('active');
                    btn.innerHTML = '<span>â•</span><span>ì¶”ê°€</span>';
                }
                
                if (card) {
                    card.style.border = '';
                    card.style.boxShadow = '';
                    
                    // ì‘ë‹µ ì˜ì—­ ì´ˆê¸°í™” (ê²€í†  ê²°ê³¼ê°€ ì—†ì„ ë•Œë§Œ)
                    const responseDiv = document.getElementById(`response-${addingToCardId}`);
                    if (responseDiv && !responseDiv.querySelector('.verdict-badge')) {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; color: #999; padding: 20px;">
                                <div style="font-size: 24px; margin-bottom: 8px;">â³</div>
                                <div>AI ê²€í† ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                            </div>
                        `;
                    }
                }
            }
            addingToCardId = null;
        }
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.cancelAddMode = cancelAddMode;
        
        function removeCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.style.transition = 'all 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    card.remove();
                    // ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì¼ê´„ ê²€í†  ë²„íŠ¼ ìˆ¨ê¹€
                    const cards = cropsList.querySelectorAll('.card');
                    if (cards.length === 0) {
                        cropsList.innerHTML = `
                            <div class="empty-state">
                                <h2>ğŸ“‹ ë¶„ì„í•  ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤</h2>
                                <p>PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            </div>
                        `;
                        const batchSection = document.getElementById('batch-review-section');
                        if (batchSection) {
                            batchSection.style.display = 'none';
                        }
                    }
                }, 300);
            }
        }

        // --- AI ê²€í†  (ê°œì„ ) ---
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (onclickì—ì„œ ì‚¬ìš©)
        window.analyzeImage = async function(btn, cardId) {
            const apiKey = apiKeyInput.value.trim();
            const selectedModel = modelSelect.value;
            if (!apiKey) { 
                alert("âš ï¸ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!"); 
                return; 
            }

            const card = document.getElementById(cardId);
            if (!card) return;
            
            const responseDiv = document.getElementById(`response-${cardId}`);
            if (!responseDiv) return;
            
            // ì¹´ë“œì˜ ëª¨ë“  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            let images = [];
            try {
                images = JSON.parse(card.dataset.images || '[]');
            } catch (e) {
                // ê¸°ì¡´ ë°©ì‹ í˜¸í™˜ì„±: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
                const firstImg = card.querySelector('.crop-image');
                if (firstImg && firstImg.src) {
                    images = [firstImg.src];
                }
            }
            
            if (images.length === 0) {
                alert('âš ï¸ ë¶„ì„í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì¶”ê°€ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (addingToCardId === cardId) {
                cancelAddMode();
            }
            
            btn.disabled = true;
            btn.innerText = `â³ ë¶„ì„ ì¤‘...`;
            responseDiv.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div class="loading" style="justify-content: center; margin-bottom: 10px;"></div>
                    <div style="color: #667eea; font-weight: 600; margin-bottom: 5px;">ğŸ¤” AI ë¶„ì„ ì¤‘...</div>
                    <div style="color: #999; font-size: 13px;">${selectedModel} ëª¨ë¸ì´ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
            `;
            
            try {
                // ì´ë¯¸ì§€ë“¤ì„ Base64 ë°ì´í„°ë¡œ ë³€í™˜
                const imageParts = images.map(imgData => {
                    const imageData = imgData.includes(',') ? imgData.split(',')[1] : imgData;
                    return { inline_data: { mime_type: "image/png", data: imageData } };
                });
                
                // ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„± (ì„¤ì •ê°’ ë°˜ì˜)
                const promptText = generateReviewPrompt();
                
                // ì—¬ëŸ¬ ì´ë¯¸ì§€ì™€ í•¨ê»˜ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                const parts = [{ text: promptText }, ...imageParts];
                
                // ë¶„ì„ ìˆ˜ì¤€ì— ë”°ë¥¸ ìƒì„± ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                const genConfig = getGenerationConfig();

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }],
                        generationConfig: genConfig
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}`;
                    console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', errorData);
                    console.error('ì‚¬ìš©í•œ ëª¨ë¸:', selectedModel);
                    console.error('ì‚¬ìš©í•œ URL:', url.replace(apiKey, 'API_KEY_HIDDEN'));
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // ì „ì²´ ì‘ë‹µ ë¡œê¹… (ë””ë²„ê¹…ìš©)
                console.log('ì „ì²´ API ì‘ë‹µ:', JSON.stringify(data, null, 2));
                
                if (data.error) {
                    console.error('API ì˜¤ë¥˜:', data.error);
                    console.error('ì‚¬ìš©í•œ ëª¨ë¸:', selectedModel);
                    throw new Error(data.error.message);
                }
                
                if (!data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
                    console.error('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                    throw new Error('AI ì‘ë‹µì— candidatesê°€ ì—†ìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬(F12) ì½˜ì†”ì—ì„œ ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
                const candidate = data.candidates[0];
                console.log('ì²« ë²ˆì§¸ candidate:', JSON.stringify(candidate, null, 2));
                
                if (!candidate) {
                    console.error('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                    throw new Error('AI ì‘ë‹µì— candidateê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // finishReason í™•ì¸
                let shouldRetryWithSimplifiedMode = false;
                if (candidate.finishReason === 'MAX_TOKENS') {
                    console.warn('í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µì´ ì˜ë ¸ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    // ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰ í™•ì¸
                    if (data.usageMetadata) {
                        const outputTokens = data.usageMetadata.candidatesTokenCount || data.usageMetadata.totalTokenCount - data.usageMetadata.promptTokenCount;
                        const currentLimit = getGenerationConfig().maxOutputTokens;
                        console.log('í† í° ì‚¬ìš©ëŸ‰:', {
                            ì…ë ¥_í† í°: data.usageMetadata.promptTokenCount,
                            ì¶œë ¥_í† í°: outputTokens,
                            ì´_í† í°: data.usageMetadata.totalTokenCount,
                            ìµœëŒ€_ì¶œë ¥_ì œí•œ: currentLimit
                        });
                        
                        // ì¶œë ¥ í† í°ì´ ì œí•œì˜ 90% ì´ìƒ ì‚¬ìš©ë˜ì—ˆê³ , í˜„ì¬ "ìì„¸íˆ" ëª¨ë“œì¸ ê²½ìš° ì¬ì‹œë„ ì œì•ˆ
                        if (outputTokens >= currentLimit * 0.9 && settings.analysisLevel === 'ìì„¸íˆ') {
                            shouldRetryWithSimplifiedMode = true;
                        }
                    }
                    // MAX_TOKENSì¸ ê²½ìš°ì—ë„ partsê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                } else if (candidate.finishReason === 'SAFETY') {
                    throw new Error('AI ì‘ë‹µì´ ì•ˆì „ í•„í„°ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (candidate.finishReason === 'RECITATION') {
                    throw new Error('AI ì‘ë‹µì´ ì €ì‘ê¶Œ ë³´í˜¸ë¡œ ì¸í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•ì‹ ì§€ì›
                let resultText = null;
                
                // í˜•ì‹ 1: candidate.content.parts[0].text (í‘œì¤€ í˜•ì‹)
                if (candidate.content && candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                    const part = candidate.content.parts[0];
                    if (part && part.text) {
                        resultText = part.text;
                    }
                }
                
                // í˜•ì‹ 2: candidate.text (ì§ì ‘ text ì†ì„±)
                if (!resultText && candidate.text) {
                    resultText = candidate.text;
                }
                
                // í˜•ì‹ 3: candidate.content.text (contentì— ì§ì ‘ text)
                if (!resultText && candidate.content && candidate.content.text) {
                    resultText = candidate.content.text;
                }
                
                // í˜•ì‹ 4: candidate.output ë˜ëŠ” candidate.response
                if (!resultText && candidate.output) {
                    resultText = typeof candidate.output === 'string' ? candidate.output : JSON.stringify(candidate.output);
                }
                if (!resultText && candidate.response) {
                    resultText = typeof candidate.response === 'string' ? candidate.response : JSON.stringify(candidate.response);
                }
                
                if (!resultText) {
                    console.error('ì‘ë‹µ ë°ì´í„° êµ¬ì¡°:', JSON.stringify(data, null, 2));
                    console.error('candidate êµ¬ì¡°:', JSON.stringify(candidate, null, 2));
                    
                    // finishReasonì— ë”°ë¥¸ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
                    if (candidate.finishReason === 'MAX_TOKENS') {
                        let tokenInfo = '';
                        let diagnosis = '';
                        let retryButton = '';
                        if (data.usageMetadata) {
                            const inputTokens = data.usageMetadata.promptTokenCount || 0;
                            const outputTokens = (data.usageMetadata.candidatesTokenCount || data.usageMetadata.totalTokenCount - inputTokens) || 0;
                            const totalTokens = data.usageMetadata.totalTokenCount || 0;
                            const currentLimit = getGenerationConfig().maxOutputTokens;
                            
                            tokenInfo = `\n\nğŸ“Š ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰:\n- ì…ë ¥ í† í°: ${inputTokens.toLocaleString()}ê°œ (í”„ë¡¬í”„íŠ¸ + ì´ë¯¸ì§€)\n- ì¶œë ¥ í† í°: ${outputTokens.toLocaleString()}ê°œ (AIê°€ ìƒì„±í•œ ì‘ë‹µ)\n- ì´ í† í°: ${totalTokens.toLocaleString()}ê°œ\n- ì¶œë ¥ ì œí•œ: ${currentLimit.toLocaleString()}ê°œ (í˜„ì¬ ì„¤ì •: "${settings.analysisLevel}")`;
                            
                            // ì§„ë‹¨ ë©”ì‹œì§€
                            if (outputTokens >= currentLimit * 0.9) {
                                // ì¶œë ¥ í† í°ì´ ì œí•œì— ê±°ì˜ ë„ë‹¬í•œ ê²½ìš°
                                diagnosis = `\n\nâš ï¸ ì§„ë‹¨: AIê°€ ê±°ì˜ ${currentLimit.toLocaleString()}ê°œì˜ ì¶œë ¥ í† í°ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\nì´ëŠ” AIê°€ ë§¤ìš° ìƒì„¸í•˜ê³  ê¸´ ì‘ë‹µì„ ìƒì„±í•˜ë ¤ê³  í–ˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ ì›ì¸:\n1. í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ìƒì„¸í•œ ë¶„ì„ì„ ìš”êµ¬í•¨ (í˜„ì¬ ì„¤ì •: "${settings.analysisLevel}")\n2. ë¬¸ì œê°€ ë§¤ìš° ë³µì¡í•˜ê±°ë‚˜ ì—¬ëŸ¬ ë‹¨ê³„ì˜ í’€ì´ê°€ í•„ìš”í•¨\n3. AIê°€ ëª¨ë“  ê°€ëŠ¥ì„±ì„ ìƒì„¸íˆ ì„¤ëª…í•˜ë ¤ê³  ì‹œë„í•¨`;
                                
                                // "ìì„¸íˆ" ëª¨ë“œì¸ ê²½ìš° ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„ ì œì•ˆ
                                if (settings.analysisLevel === 'ìì„¸íˆ') {
                                    retryButton = `\n\nğŸ”„ ìë™ ì¬ì‹œë„ ì˜µì…˜:\nì•„ë˜ "ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ "ê°„ëµíˆ" ëª¨ë“œë¡œ ì¬ê²€í† í•©ë‹ˆë‹¤.`;
                                }
                            } else if (inputTokens > 20000) {
                                // ì…ë ¥ í† í°ì´ ë„ˆë¬´ ë§ì€ ê²½ìš°
                                diagnosis = `\n\nâš ï¸ ì§„ë‹¨: ì…ë ¥ í† í°ì´ ${inputTokens.toLocaleString()}ê°œë¡œ ë§¤ìš° ë§ìŠµë‹ˆë‹¤.\nì´ëŠ” ì´ë¯¸ì§€ê°€ ë§ê±°ë‚˜ ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ ì›ì¸:\n1. ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ì˜ ë¬¸í•­ì— ì¶”ê°€í•¨ (${images.length}ê°œ ì´ë¯¸ì§€)\n2. ì´ë¯¸ì§€ í•´ìƒë„ê°€ ë†’ì•„ì„œ í† í° ì†Œë¹„ê°€ í¼\n3. í”„ë¡¬í”„íŠ¸ê°€ ê¸¸ì–´ì„œ ì…ë ¥ í† í°ì´ ë§ìŒ`;
                            } else {
                                diagnosis = `\n\nâš ï¸ ì§„ë‹¨: ì¶œë ¥ í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\nì¼ë°˜ì ìœ¼ë¡œ ìˆ˜í•™ ë¬¸ì œ í•˜ë‚˜ ê²€í† ì—ëŠ” 500~1,500 í† í°ì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.\n${outputTokens.toLocaleString()}ê°œê°€ ì‚¬ìš©ëœ ê²ƒì€ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ ì‘ë‹µì…ë‹ˆë‹¤.`;
                            }
                        }
                        
                        // ì¬ì‹œë„ ê°€ëŠ¥í•œ ê²½ìš° ì—ëŸ¬ ëŒ€ì‹  ì¬ì‹œë„ UI í‘œì‹œ
                        if (shouldRetryWithSimplifiedMode && settings.analysisLevel === 'ìì„¸íˆ') {
                            responseDiv.innerHTML = `
                                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border-radius: 12px; border: 2px solid #ff9800;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                                    <h3 style="color: #ff9800; margin: 0 0 15px 0; font-size: 18px;">í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤</h3>
                                    <div style="color: #666; margin-bottom: 20px; text-align: left; background: white; padding: 15px; border-radius: 8px; font-size: 13px;">
                                        ${tokenInfo}${diagnosis}
                                    </div>
                                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                        <button onclick="retryWithSimplifiedMode('${cardId}')" style="padding: 12px 24px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                            âœ… ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„
                                        </button>
                                        <button onclick="dismissTokenError('${cardId}')" style="padding: 12px 24px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                            ì·¨ì†Œ
                                        </button>
                                    </div>
                                    <div style="margin-top: 15px; color: #999; font-size: 12px;">
                                        ğŸ’¡ "ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„"ë¥¼ ì„ íƒí•˜ë©´ "ê°„ëµíˆ" ì„¤ì •ìœ¼ë¡œ ìë™ ì¬ê²€í† í•©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            `;
                            btn.disabled = false;
                            btn.innerText = 'âš¡ AI ê²€í† ';
                            return; // ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•Šê³  UIë§Œ í‘œì‹œ
                        }
                        
                        throw new Error(`AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì¶œë ¥ í† í° ì œí•œ(${getGenerationConfig().maxOutputTokens.toLocaleString()}ê°œ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.${tokenInfo}${diagnosis}${retryButton}\n\nğŸ’¡ í•´ê²° ë°©ë²•:\n1. ì„¤ì • â†’ "ë¶„ì„ ìˆ˜ì¤€"ì„ "ê°„ëµíˆ" ë˜ëŠ” "ë‹µë§Œ"ìœ¼ë¡œ ë³€ê²½ (ê°€ì¥ íš¨ê³¼ì )\n2. ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•œ ê²½ìš°, ì´ë¯¸ì§€ í•´ìƒë„ ë‚®ì¶”ê¸°\n3. ë” ê°•ë ¥í•œ ëª¨ë¸(Gemini 3.0 Pro ë“±) ì‚¬ìš©\n4. ë¬¸ì œë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ê²€í† `);
                    } else if (candidate.finishReason === 'SAFETY') {
                        throw new Error('AI ì‘ë‹µì´ ì•ˆì „ í•„í„°ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else if (candidate.finishReason === 'RECITATION') {
                        throw new Error('AI ì‘ë‹µì´ ì €ì‘ê¶Œ ë³´í˜¸ë¡œ ì¸í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        throw new Error(`AI ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (finishReason: ${candidate.finishReason || 'unknown'}) ê°œë°œì ë„êµ¬(F12) ì½˜ì†”ì—ì„œ ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    }
                }
                
                // íŒì • ê²°ê³¼ íŒŒì‹±
                const verdict = parseVerdict(resultText);
                
                // ê°„ë‹¨í•œ ì„¤ëª… ì¶”ì¶œ (ì²« 2-3ë¬¸ì¥)
                const summary = extractSummary(resultText, verdict.type);
                
                // ìì„¸í•œ ì„¤ëª… (ì „ì²´ í…ìŠ¤íŠ¸ í¬ë§·íŒ…)
                const detailText = formatDetailText(resultText);
                
                // UI êµ¬ì„±
                const copyBtnId = `copy-btn-${cardId}`;
                const toggleBtnId = `toggle-btn-${cardId}`;
                const detailId = `detail-${cardId}`;
                
                responseDiv.innerHTML = `
                    <div class="verdict-badge verdict-${verdict.type}">
                        <span class="verdict-icon">${verdict.icon}</span>
                        <span>${verdict.label}</span>
                    </div>
                    <div class="summary-section">
                        <p class="summary-text">${summary}</p>
                    </div>
                    <button class="detail-toggle" id="${toggleBtnId}" onclick="toggleDetail('${detailId}', '${toggleBtnId}')">
                        <span>ğŸ“–</span>
                        <span>ìì„¸íˆ ë³´ê¸°</span>
                        <span style="margin-left: auto;">â–¼</span>
                    </button>
                    <div class="detail-content" id="${detailId}">
                        <div class="response-content">${detailText}</div>
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="btn-copy" id="${copyBtnId}" onclick="copyResponse('${cardId}')">
                                <span>ğŸ“‹</span>
                                <span>ì „ì²´ ë³µì‚¬</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // MathJaxë¡œ LaTeX ìˆ˜ì‹ ë Œë”ë§
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([responseDiv]).then(() => {
                            // ë Œë”ë§ í›„ ì˜¤ë¥˜ ë©”ì‹œì§€ ìš”ì†Œ ì œê±°
                            const errorElements = responseDiv.querySelectorAll('.MathJax_Error, mjx-merror, [class*="MathJax_Error"], [class*="merror"]');
                            errorElements.forEach(el => el.remove());
                        }).catch((err) => {
                            console.warn('MathJax ë Œë”ë§ ì˜¤ë¥˜:', err);
                            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì˜¤ë¥˜ ë©”ì‹œì§€ ìš”ì†Œ ì œê±°
                            const errorElements = responseDiv.querySelectorAll('.MathJax_Error, mjx-merror, [class*="MathJax_Error"], [class*="merror"]');
                            errorElements.forEach(el => el.remove());
                        });
                    }, 100);
                }
                
                // ë³µì‚¬ ê¸°ëŠ¥ ì¶”ê°€
                window.copyResponse = function(cardId) {
                    const responseDiv = document.getElementById(`response-${cardId}`);
                    const detailDiv = responseDiv.querySelector('.detail-content .response-content');
                    const summaryDiv = responseDiv.querySelector('.summary-text');
                    
                    // ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬ (ê°„ë‹¨ ì„¤ëª… + ìì„¸í•œ ì„¤ëª…)
                    let fullText = '';
                    if (summaryDiv) {
                        fullText += summaryDiv.innerText || summaryDiv.textContent;
                        fullText += '\n\n';
                    }
                    if (detailDiv) {
                        fullText += detailDiv.innerText || detailDiv.textContent;
                    }
                    
                    const copyBtn = document.getElementById(`copy-btn-${cardId}`);
                    
                    navigator.clipboard.writeText(fullText).then(() => {
                        copyBtn.innerHTML = '<span>âœ“</span><span>ë³µì‚¬ë¨</span>';
                        copyBtn.classList.add('copied');
                        setTimeout(() => {
                            copyBtn.innerHTML = '<span>ğŸ“‹</span><span>ì „ì²´ ë³µì‚¬</span>';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                        alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                    });
                };
                
                btn.disabled = false;
                btn.innerText = 'âš¡ AI ê²€í† ';
                
            } catch (error) {
                console.error('AI ê²€í†  ì˜¤ë¥˜:', error);
                console.error('ì „ì²´ ì˜¤ë¥˜ ì •ë³´:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    model: selectedModel
                });
                
                let errorMsg = 'ê²€í†  ì‹¤íŒ¨: ';
                if (error.message.includes('API_KEY') || error.message.includes('401')) {
                    errorMsg += 'API Keyê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.message.includes('quota') || error.message.includes('429')) {
                    errorMsg += 'API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('403')) {
                    errorMsg += 'API ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API Keyì™€ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('not found') || error.message.includes('not supported') || error.message.includes('not available')) {
                    errorMsg += `ëª¨ë¸ "${selectedModel}"ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
                } else if (error.message.includes('í† í° ì œí•œ') || error.message.includes('MAX_TOKENS') || error.message.includes('ì¶œë ¥ í† í° ì œí•œ')) {
                    // ì—ëŸ¬ ë©”ì‹œì§€ì— ì´ë¯¸ ìƒì„¸í•œ ì„¤ëª…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    errorMsg += error.message;
                } else if (error.message.includes('í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') || error.message.includes('partsê°€ ì—†ìŠµë‹ˆë‹¤') || error.message.includes('candidatesê°€ ì—†ìŠµë‹ˆë‹¤')) {
                    errorMsg += error.message + '\n\nğŸ’¡ ê°œë°œì ë„êµ¬(F12) â†’ Console íƒ­ì—ì„œ "ì „ì²´ API ì‘ë‹µ"ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else {
                    errorMsg += error.message;
                }
                
                // ëª¨ë¸ ê´€ë ¨ ì—ëŸ¬ì¸ ê²½ìš° ì¶”ê°€ ì•ˆë‚´
                if (error.message.includes('not found') || error.message.includes('not supported')) {
                    errorMsg += '\n\nğŸ’¡ í•´ê²° ë°©ë²•: ëª¨ë¸ ì„ íƒì—ì„œ "Gemini 1.5 Pro" ë˜ëŠ” "Gemini 2.0 Flash"ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.';
                }
                
                responseDiv.innerHTML = `<span class="error-msg">${errorMsg}</span>`;
                btn.disabled = false;
                btn.innerText = 'âš¡ AI ê²€í† ';
            }
        };
        
        // ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„ í•¨ìˆ˜
        window.retryWithSimplifiedMode = async function(cardId) {
            // ì„ì‹œë¡œ ì„¤ì •ì„ "ê°„ëµíˆ"ë¡œ ë³€ê²½
            const originalLevel = settings.analysisLevel;
            settings.analysisLevel = 'ê°„ëµíˆ';
            
            // ì¬ê²€í†  ì‹¤í–‰
            const card = document.getElementById(cardId);
            if (card) {
                const btn = card.querySelector('.btn-analyze');
                if (btn) {
                    // ì„¤ì •ì„ ì„ì‹œë¡œ ë³€ê²½í•œ ìƒíƒœì—ì„œ ì¬ê²€í† 
                    await analyzeImage(btn, cardId);
                    // ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë³µì›
                    settings.analysisLevel = originalLevel;
                }
            }
        };
        
        // í† í° ì—ëŸ¬ ë¬´ì‹œ í•¨ìˆ˜
        window.dismissTokenError = function(cardId) {
            const responseDiv = document.getElementById(`response-${cardId}`);
            if (responseDiv) {
                responseDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">â³</div>
                        <div>AI ê²€í† ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>
                `;
            }
        };
        
        // removeCardë„ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.removeCard = removeCard;
        
        // ì¼ê´„ ê²€í†  í•¨ìˆ˜
        window.startBatchReview = async function() {
            const apiKey = apiKeyInput.value.trim();
            const selectedModel = modelSelect.value;
            if (!apiKey) {
                alert("âš ï¸ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            
            // ëª¨ë“  ì¹´ë“œ ì°¾ê¸°
            const cards = cropsList.querySelectorAll('.card');
            if (cards.length === 0) {
                alert("âš ï¸ ê²€í† í•  ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // ì´ë¯¸ ê²€í†  ì™„ë£Œëœ ì¹´ë“œ ì œì™¸
            const pendingCards = Array.from(cards).filter(card => {
                const responseDiv = card.querySelector('.ai-response');
                if (!responseDiv) return false;
                const hasResult = responseDiv.querySelector('.verdict-badge');
                return !hasResult; // ê²°ê³¼ê°€ ì—†ëŠ” ì¹´ë“œë§Œ
            });
            
            if (pendingCards.length === 0) {
                alert("âœ… ëª¨ë“  ë¬¸í•­ì´ ì´ë¯¸ ê²€í† ë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
            }
            
            const batchBtn = document.getElementById('btn-batch-review');
            const progressDiv = document.getElementById('batch-progress');
            const progressText = document.getElementById('progress-text');
            const progressFill = document.getElementById('progress-fill');
            
            batchBtn.disabled = true;
            batchBtn.innerHTML = '<span>â³</span><span>ì¼ê´„ ê²€í†  ì§„í–‰ ì¤‘...</span>';
            progressDiv.classList.add('show');
            
            let completed = 0;
            const total = pendingCards.length;
            
            // ê° ì¹´ë“œ ìˆœì°¨ì ìœ¼ë¡œ ê²€í† 
            for (let i = 0; i < pendingCards.length; i++) {
                const card = pendingCards[i];
                const cardId = card.id;
                const btn = card.querySelector('.btn-analyze');
                const responseDiv = document.getElementById(`response-${cardId}`);
                
                if (!btn || !responseDiv) continue;
                
                // ì¹´ë“œì˜ ëª¨ë“  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                let images = [];
                try {
                    images = JSON.parse(card.dataset.images || '[]');
                } catch (e) {
                    // ê¸°ì¡´ ë°©ì‹ í˜¸í™˜ì„±: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
                    const firstImg = card.querySelector('.crop-image');
                    if (firstImg && firstImg.src) {
                        images = [firstImg.src];
                    }
                }
                
                if (images.length === 0) continue;
                
                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œì‘ ì „)
                progressText.textContent = `${i + 1} / ${total}`;
                progressFill.style.width = `${((i + 1) / total) * 100}%`;
                
                // ìŠ¤í¬ë¡¤í•˜ì—¬ í˜„ì¬ ì¹´ë“œ ë³´ì´ê²Œ
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                btn.disabled = true;
                btn.innerText = 'â³ ë¶„ì„ ì¤‘...';
                responseDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div class="loading" style="justify-content: center; margin-bottom: 10px;"></div>
                        <div style="color: #667eea; font-weight: 600; margin-bottom: 5px;">ğŸ¤” AI ë¶„ì„ ì¤‘... (${i + 1}/${total})</div>
                        <div style="color: #999; font-size: 13px;">${selectedModel} ëª¨ë¸ì´ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                
                // ê²€í†  ì‹¤í–‰
                try {
                    // ì´ë¯¸ì§€ë“¤ì„ Base64 ë°ì´í„°ë¡œ ë³€í™˜
                    const imageParts = images.map(imgData => {
                        const imageData = imgData.includes(',') ? imgData.split(',')[1] : imgData;
                        return { inline_data: { mime_type: "image/png", data: imageData } };
                    });
                    
                    // ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„± (ì„¤ì •ê°’ ë°˜ì˜)
                    const promptText = generateReviewPrompt();
                    
                    // ì—¬ëŸ¬ ì´ë¯¸ì§€ì™€ í•¨ê»˜ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                    const parts = [{ text: promptText }, ...imageParts];
                    
                    // ë¶„ì„ ìˆ˜ì¤€ì— ë”°ë¥¸ ìƒì„± ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                    const genConfig = getGenerationConfig();
                    
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: parts
                            }],
                            generationConfig: genConfig
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // ì „ì²´ ì‘ë‹µ ë¡œê¹… (ë””ë²„ê¹…ìš©)
                    console.log(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] ì „ì²´ API ì‘ë‹µ:`, JSON.stringify(data, null, 2));
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }
                    
                    if (!data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
                        console.error('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                        throw new Error('AI ì‘ë‹µì— candidatesê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    const candidate = data.candidates[0];
                    console.log(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] ì²« ë²ˆì§¸ candidate:`, JSON.stringify(candidate, null, 2));
                    
                    if (!candidate) {
                        console.error('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));
                        throw new Error('AI ì‘ë‹µì— candidateê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    // finishReason í™•ì¸
                    let shouldRetryBatch = false;
                    if (candidate.finishReason === 'MAX_TOKENS') {
                        console.warn(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µì´ ì˜ë ¸ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        // ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰ í™•ì¸
                        if (data.usageMetadata) {
                            const outputTokens = data.usageMetadata.candidatesTokenCount || data.usageMetadata.totalTokenCount - data.usageMetadata.promptTokenCount;
                            const currentLimit = getGenerationConfig().maxOutputTokens;
                            console.log(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] í† í° ì‚¬ìš©ëŸ‰:`, {
                                ì…ë ¥_í† í°: data.usageMetadata.promptTokenCount,
                                ì¶œë ¥_í† í°: outputTokens,
                                ì´_í† í°: data.usageMetadata.totalTokenCount,
                                ìµœëŒ€_ì¶œë ¥_ì œí•œ: currentLimit
                            });
                            
                            // ì¶œë ¥ í† í°ì´ ì œí•œì˜ 90% ì´ìƒ ì‚¬ìš©ë˜ì—ˆê³ , í˜„ì¬ "ìì„¸íˆ" ëª¨ë“œì¸ ê²½ìš° ì¬ì‹œë„
                            if (outputTokens >= currentLimit * 0.9 && settings.analysisLevel === 'ìì„¸íˆ') {
                                shouldRetryBatch = true;
                            }
                        }
                    } else if (candidate.finishReason === 'SAFETY') {
                        throw new Error('AI ì‘ë‹µì´ ì•ˆì „ í•„í„°ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    } else if (candidate.finishReason === 'RECITATION') {
                        throw new Error('AI ì‘ë‹µì´ ì €ì‘ê¶Œ ë³´í˜¸ë¡œ ì¸í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•ì‹ ì§€ì›
                    let resultText = null;
                    
                    // í˜•ì‹ 1: candidate.content.parts[0].text (í‘œì¤€ í˜•ì‹)
                    if (candidate.content && candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                        const part = candidate.content.parts[0];
                        if (part && part.text) {
                            resultText = part.text;
                        }
                    }
                    
                    // í˜•ì‹ 2: candidate.text (ì§ì ‘ text ì†ì„±)
                    if (!resultText && candidate.text) {
                        resultText = candidate.text;
                    }
                    
                    // í˜•ì‹ 3: candidate.content.text (contentì— ì§ì ‘ text)
                    if (!resultText && candidate.content && candidate.content.text) {
                        resultText = candidate.content.text;
                    }
                    
                    // í˜•ì‹ 4: candidate.output ë˜ëŠ” candidate.response
                    if (!resultText && candidate.output) {
                        resultText = typeof candidate.output === 'string' ? candidate.output : JSON.stringify(candidate.output);
                    }
                    if (!resultText && candidate.response) {
                        resultText = typeof candidate.response === 'string' ? candidate.response : JSON.stringify(candidate.response);
                    }
                    
                    if (!resultText) {
                        console.error('ì‘ë‹µ ë°ì´í„° êµ¬ì¡°:', JSON.stringify(data, null, 2));
                        console.error('candidate êµ¬ì¡°:', JSON.stringify(candidate, null, 2));
                        
                        // finishReasonì— ë”°ë¥¸ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
                        if (candidate.finishReason === 'MAX_TOKENS') {
                            // ì¼ê´„ ê²€í† ì—ì„œ ì¬ì‹œë„ ê°€ëŠ¥í•œ ê²½ìš° ìë™ìœ¼ë¡œ ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„
                            if (shouldRetryBatch && settings.analysisLevel === 'ìì„¸íˆ') {
                                console.log(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] ê°„ëµ ëª¨ë“œë¡œ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤...`);
                                const originalLevel = settings.analysisLevel;
                                settings.analysisLevel = 'ê°„ëµíˆ';
                                
                                // ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„
                                const retryPromptText = generateReviewPrompt();
                                const retryParts = [{ text: retryPromptText }, ...imageParts];
                                const retryGenConfig = getGenerationConfig();
                                
                                const retryResponse = await fetch(url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: retryParts
                                        }],
                                        generationConfig: retryGenConfig
                                    })
                                });
                                
                                if (retryResponse.ok) {
                                    const retryData = await retryResponse.json();
                                    if (retryData.candidates && retryData.candidates[0] && retryData.candidates[0].content && retryData.candidates[0].content.parts && retryData.candidates[0].content.parts[0] && retryData.candidates[0].content.parts[0].text) {
                                        resultText = retryData.candidates[0].content.parts[0].text;
                                        console.log(`[ì¼ê´„ ê²€í†  ${i + 1}/${total}] ê°„ëµ ëª¨ë“œë¡œ ì¬ì‹œë„ ì„±ê³µ!`);
                                    }
                                }
                                
                                // ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë³µì›
                                settings.analysisLevel = originalLevel;
                            }
                            
                            // ì¬ì‹œë„ í›„ì—ë„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
                            if (!resultText) {
                                let tokenInfo = '';
                                let diagnosis = '';
                                if (data.usageMetadata) {
                                    const inputTokens = data.usageMetadata.promptTokenCount || 0;
                                    const outputTokens = (data.usageMetadata.candidatesTokenCount || data.usageMetadata.totalTokenCount - inputTokens) || 0;
                                    const totalTokens = data.usageMetadata.totalTokenCount || 0;
                                    const currentLimit = getGenerationConfig().maxOutputTokens;
                                    
                                    tokenInfo = `\n\nğŸ“Š ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰:\n- ì…ë ¥ í† í°: ${inputTokens.toLocaleString()}ê°œ (í”„ë¡¬í”„íŠ¸ + ì´ë¯¸ì§€)\n- ì¶œë ¥ í† í°: ${outputTokens.toLocaleString()}ê°œ (AIê°€ ìƒì„±í•œ ì‘ë‹µ)\n- ì´ í† í°: ${totalTokens.toLocaleString()}ê°œ\n- ì¶œë ¥ ì œí•œ: ${currentLimit.toLocaleString()}ê°œ (í˜„ì¬ ì„¤ì •: "${settings.analysisLevel}")`;
                                    
                                    // ì§„ë‹¨ ë©”ì‹œì§€
                                    if (outputTokens >= currentLimit * 0.9) {
                                        diagnosis = `\n\nâš ï¸ ì§„ë‹¨: AIê°€ ê±°ì˜ ${currentLimit.toLocaleString()}ê°œì˜ ì¶œë ¥ í† í°ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\nì´ëŠ” AIê°€ ë§¤ìš° ìƒì„¸í•˜ê³  ê¸´ ì‘ë‹µì„ ìƒì„±í•˜ë ¤ê³  í–ˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ ì›ì¸:\n1. í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ìƒì„¸í•œ ë¶„ì„ì„ ìš”êµ¬í•¨ (í˜„ì¬ ì„¤ì •: "${settings.analysisLevel}")\n2. ë¬¸ì œê°€ ë§¤ìš° ë³µì¡í•˜ê±°ë‚˜ ì—¬ëŸ¬ ë‹¨ê³„ì˜ í’€ì´ê°€ í•„ìš”í•¨\n3. AIê°€ ëª¨ë“  ê°€ëŠ¥ì„±ì„ ìƒì„¸íˆ ì„¤ëª…í•˜ë ¤ê³  ì‹œë„í•¨`;
                                    } else if (inputTokens > 20000) {
                                        diagnosis = `\n\nâš ï¸ ì§„ë‹¨: ì…ë ¥ í† í°ì´ ${inputTokens.toLocaleString()}ê°œë¡œ ë§¤ìš° ë§ìŠµë‹ˆë‹¤.\nì´ëŠ” ì´ë¯¸ì§€ê°€ ë§ê±°ë‚˜ ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ ì›ì¸:\n1. ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ì˜ ë¬¸í•­ì— ì¶”ê°€í•¨ (${images.length}ê°œ ì´ë¯¸ì§€)\n2. ì´ë¯¸ì§€ í•´ìƒë„ê°€ ë†’ì•„ì„œ í† í° ì†Œë¹„ê°€ í¼\n3. í”„ë¡¬í”„íŠ¸ê°€ ê¸¸ì–´ì„œ ì…ë ¥ í† í°ì´ ë§ìŒ`;
                                    } else {
                                        diagnosis = `\n\nâš ï¸ ì§„ë‹¨: ì¶œë ¥ í† í° ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.\nì¼ë°˜ì ìœ¼ë¡œ ìˆ˜í•™ ë¬¸ì œ í•˜ë‚˜ ê²€í† ì—ëŠ” 500~1,500 í† í°ì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.\n${outputTokens.toLocaleString()}ê°œê°€ ì‚¬ìš©ëœ ê²ƒì€ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ ì‘ë‹µì…ë‹ˆë‹¤.`;
                                    }
                                }
                                throw new Error(`AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì¶œë ¥ í† í° ì œí•œ(${getGenerationConfig().maxOutputTokens.toLocaleString()}ê°œ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.${tokenInfo}${diagnosis}\n\nğŸ’¡ í•´ê²° ë°©ë²•:\n1. ì„¤ì • â†’ "ë¶„ì„ ìˆ˜ì¤€"ì„ "ê°„ëµíˆ" ë˜ëŠ” "ë‹µë§Œ"ìœ¼ë¡œ ë³€ê²½ (ê°€ì¥ íš¨ê³¼ì )\n2. ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•œ ê²½ìš°, ì´ë¯¸ì§€ í•´ìƒë„ ë‚®ì¶”ê¸°\n3. ë” ê°•ë ¥í•œ ëª¨ë¸(Gemini 3.0 Pro ë“±) ì‚¬ìš©\n4. ë¬¸ì œë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ê²€í† `);
                            }
                        } else if (candidate.finishReason === 'SAFETY') {
                            throw new Error('AI ì‘ë‹µì´ ì•ˆì „ í•„í„°ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } else if (candidate.finishReason === 'RECITATION') {
                            throw new Error('AI ì‘ë‹µì´ ì €ì‘ê¶Œ ë³´í˜¸ë¡œ ì¸í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } else {
                            throw new Error(`AI ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (finishReason: ${candidate.finishReason || 'unknown'}) ê°œë°œì ë„êµ¬(F12) ì½˜ì†”ì—ì„œ ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                        }
                    }
                    
                    // íŒì • ê²°ê³¼ íŒŒì‹±
                    const verdict = parseVerdict(resultText);
                    
                    // ê°„ë‹¨í•œ ì„¤ëª… ì¶”ì¶œ
                    const summary = extractSummary(resultText, verdict.type);
                    
                    // ìì„¸í•œ ì„¤ëª… í¬ë§·íŒ…
                    const detailText = formatDetailText(resultText);
                    
                    // UI êµ¬ì„±
                    const copyBtnId = `copy-btn-${cardId}`;
                    const toggleBtnId = `toggle-btn-${cardId}`;
                    const detailId = `detail-${cardId}`;
                    
                    responseDiv.innerHTML = `
                        <div class="verdict-badge verdict-${verdict.type}">
                            <span class="verdict-icon">${verdict.icon}</span>
                            <span>${verdict.label}</span>
                        </div>
                        <div class="summary-section">
                            <p class="summary-text">${summary}</p>
                        </div>
                        <button class="detail-toggle" id="${toggleBtnId}" onclick="toggleDetail('${detailId}', '${toggleBtnId}')">
                            <span>ğŸ“–</span>
                            <span>ìì„¸íˆ ë³´ê¸°</span>
                            <span style="margin-left: auto;">â–¼</span>
                        </button>
                        <div class="detail-content" id="${detailId}">
                            <div class="response-content">${detailText}</div>
                            <div style="margin-top: 15px; text-align: right;">
                                <button class="btn-copy" id="${copyBtnId}" onclick="copyResponse('${cardId}')">
                                    <span>ğŸ“‹</span>
                                    <span>ì „ì²´ ë³µì‚¬</span>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    btn.disabled = false;
                    btn.innerText = 'âš¡ AI ê²€í† ';
                    completed++;
                    
                    // MathJaxë¡œ LaTeX ìˆ˜ì‹ ë Œë”ë§
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([responseDiv]).then(() => {
                                // ë Œë”ë§ í›„ ì˜¤ë¥˜ ë©”ì‹œì§€ ìš”ì†Œ ì œê±°
                                const errorElements = responseDiv.querySelectorAll('.MathJax_Error, mjx-merror, [class*="MathJax_Error"], [class*="merror"]');
                                errorElements.forEach(el => el.remove());
                            }).catch((err) => {
                                console.warn('MathJax ë Œë”ë§ ì˜¤ë¥˜:', err);
                                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì˜¤ë¥˜ ë©”ì‹œì§€ ìš”ì†Œ ì œê±°
                                const errorElements = responseDiv.querySelectorAll('.MathJax_Error, mjx-merror, [class*="MathJax_Error"], [class*="merror"]');
                                errorElements.forEach(el => el.remove());
                            });
                        }, 100);
                    }
                    
                    // ê° ê²€í†  ì‚¬ì´ì— ì•½ê°„ì˜ ë”œë ˆì´ (API ë¶€í•˜ ë°©ì§€)
                    if (i < pendingCards.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch (error) {
                    console.error(`ì¹´ë“œ ${cardId} ê²€í†  ì˜¤ë¥˜:`, error);
                    console.error(`ì¹´ë“œ ${cardId} ì „ì²´ ì˜¤ë¥˜ ì •ë³´:`, {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    
                    let errorMsg = 'ê²€í†  ì‹¤íŒ¨: ';
                    if (error.message.includes('API_KEY') || error.message.includes('401')) {
                        errorMsg += 'API Keyê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    } else if (error.message.includes('quota') || error.message.includes('429')) {
                        errorMsg += 'API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    } else if (error.message.includes('403')) {
                        errorMsg += 'API ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API Keyì™€ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (error.message.includes('í† í° ì œí•œ') || error.message.includes('MAX_TOKENS') || error.message.includes('ì¶œë ¥ í† í° ì œí•œ')) {
                        // ì—ëŸ¬ ë©”ì‹œì§€ì— ì´ë¯¸ ìƒì„¸í•œ ì„¤ëª…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        errorMsg += error.message;
                    } else if (error.message.includes('í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') || error.message.includes('partsê°€ ì—†ìŠµë‹ˆë‹¤') || error.message.includes('candidatesê°€ ì—†ìŠµë‹ˆë‹¤')) {
                        errorMsg += error.message + '\n\nğŸ’¡ ê°œë°œì ë„êµ¬(F12) â†’ Console íƒ­ì—ì„œ "ì „ì²´ API ì‘ë‹µ"ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    responseDiv.innerHTML = `<span class="error-msg">${errorMsg}</span>`;
                    btn.disabled = false;
                    btn.innerText = 'âš¡ AI ê²€í† ';
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ ì¹´ë“œ ê³„ì† ì§„í–‰
                }
            }
            
            // ì™„ë£Œ ì²˜ë¦¬
            progressText.textContent = `${total} / ${total}`;
            progressFill.style.width = '100%';
            batchBtn.disabled = false;
            batchBtn.innerHTML = '<span>âœ…</span><span>ì¼ê´„ ê²€í†  ì™„ë£Œ</span>';
            setTimeout(() => {
                batchBtn.innerHTML = '<span>ğŸš€</span><span>ì¼ê´„ ê²€í†  ì‹œì‘</span>';
                progressDiv.classList.remove('show');
                progressFill.style.width = '0%';
            }, 2000);
        };
        
        // íŒì • ê²°ê³¼ íŒŒì‹± í•¨ìˆ˜
        function parseVerdict(text) {
            const lowerText = text.toLowerCase();
            
            // ì²« ì¤„ ë˜ëŠ” ì²˜ìŒ 200ìì—ì„œ ëª…í™•í•œ íŒì • ì´ëª¨ì§€ ìš°ì„  ê²€ìƒ‰
            const firstLines = text.substring(0, 200).trim();
            
            // ì²« ì¤„ì—ì„œ ëª…í™•í•œ íŒì • ì´ëª¨ì§€ í™•ì¸ (ìµœìš°ì„ )
            if (firstLines.includes('ğŸ”´')) {
                return {
                    type: 'red',
                    icon: 'ğŸ”´',
                    label: 'ë¹¨ê°„ë¶ˆ (ì¹˜ëª…ì  ì˜¤ë¥˜)',
                    message: 'ì´ëŒ€ë¡œ ì¶œì œí•˜ë©´ í°ì¼ ë‚©ë‹ˆë‹¤! ë¬´ì¡°ê±´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            }
            if (firstLines.includes('ğŸŸ¡')) {
                return {
                    type: 'yellow',
                    icon: 'ğŸŸ¡',
                    label: 'ë…¸ë€ë¶ˆ (ì˜¤ë¥˜ ì˜ì‹¬ / ì ê²€ í•„ìš”)',
                    message: 'í‹€ë¦° ê±´ ì•„ë‹Œë°... ì„ ìƒë‹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            }
            if (firstLines.includes('ğŸŸ¢')) {
                return {
                    type: 'green',
                    icon: 'ğŸŸ¢',
                    label: 'ì´ˆë¡ë¶ˆ (ì •ìƒ)',
                    message: 'ì™„ë²½í•©ë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ì„¸ìš”.'
                };
            }
            
            // ì²« ì¤„ì—ì„œ íŒì • í…ìŠ¤íŠ¸ í™•ì¸ (ì´ëª¨ì§€ê°€ ì—†ì„ ê²½ìš°)
            if (firstLines.includes('ë¹¨ê°„ë¶ˆ') || firstLines.includes('ë¹¨ê°•')) {
                return {
                    type: 'red',
                    icon: 'ğŸ”´',
                    label: 'ë¹¨ê°„ë¶ˆ (ì¹˜ëª…ì  ì˜¤ë¥˜)',
                    message: 'ì´ëŒ€ë¡œ ì¶œì œí•˜ë©´ í°ì¼ ë‚©ë‹ˆë‹¤! ë¬´ì¡°ê±´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            }
            if (firstLines.includes('ë…¸ë€ë¶ˆ') || firstLines.includes('ë…¸ë‘')) {
                return {
                    type: 'yellow',
                    icon: 'ğŸŸ¡',
                    label: 'ë…¸ë€ë¶ˆ (ì˜¤ë¥˜ ì˜ì‹¬ / ì ê²€ í•„ìš”)',
                    message: 'í‹€ë¦° ê±´ ì•„ë‹Œë°... ì„ ìƒë‹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            }
            if (firstLines.includes('ì´ˆë¡ë¶ˆ') || firstLines.includes('ì´ˆë¡')) {
                return {
                    type: 'green',
                    icon: 'ğŸŸ¢',
                    label: 'ì´ˆë¡ë¶ˆ (ì •ìƒ)',
                    message: 'ì™„ë²½í•©ë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ì„¸ìš”.'
                };
            }
            
            // ì²« ì¤„ì—ì„œ íŒì •ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°, ì „ì²´ í…ìŠ¤íŠ¸ì—ì„œ í‚¤ì›Œë“œ ê²€ìƒ‰
            const redKeywords = [
                'ì¹˜ëª…ì ', 'ì¬ì‹œí—˜', 'ì •ë‹µ ì—†ìŒ', 'ë³µìˆ˜ ì •ë‹µ', 'ìˆ˜ì‹ ì˜¤ë¥˜', 
                'ê³„ì‚° ì˜¤ë¥˜', 'ë…¼ë¦¬ì  ì˜¤ë¥˜', 'ë¬¸ì œ ì„±ë¦½ ë¶ˆê°€', 'ì¡°ê±´ ë¶€ì¡±',
                'í°ì¼', 'ë¬´ì¡°ê±´ ìˆ˜ì •', 'ì‹¬ê°í•œ ê²°í•¨'
            ];
            
            const yellowKeywords = [
                'ì˜¤ë¥˜ ì˜ì‹¬', 'ì ê²€ í•„ìš”', 'í™•ì¸ í•„ìš”', 'ì¤‘ì˜ì ', 'ë‹¤ë¥´ê²Œ í•´ì„',
                'ì˜¤íƒ€', 'êµìœ¡ê³¼ì • ìœ„ë°˜', 'ì„ í–‰ ê°œë…', 'ê°€ë…ì„±', 'í°íŠ¸', 'ê·¸ë˜í”„',
                'í‹€ë¦° ê±´ ì•„ë‹Œë°', 'ìˆ˜ì • í•„ìš”'
            ];
            
            const greenKeywords = [
                'ì™„ë²½', 'ì •ìƒ', 'ì´ìƒ ì—†ìŒ', 'ë¬¸ì œ ì—†ìŒ', 'í´ë¦°', 'ì í•©',
                'ëª¨ë“  ë©´ì—ì„œ', 'ì•„ë¬´ëŸ° ë¬¸ì œ'
            ];
            
            // í‚¤ì›Œë“œ ë§¤ì¹­
            let redCount = redKeywords.filter(kw => lowerText.includes(kw)).length;
            let yellowCount = yellowKeywords.filter(kw => lowerText.includes(kw)).length;
            let greenCount = greenKeywords.filter(kw => lowerText.includes(kw)).length;
            
            // ì „ì²´ í…ìŠ¤íŠ¸ì—ì„œ ì´ëª¨ì§€ë‚˜ í…ìŠ¤íŠ¸ ì§ì ‘ ê²€ìƒ‰ (ê°€ì¤‘ì¹˜ ë‚®ì¶¤)
            if (text.includes('ğŸ”´') || text.includes('ë¹¨ê°„ë¶ˆ') || text.includes('ë¹¨ê°•')) {
                redCount += 2;
            }
            if (text.includes('ğŸŸ¡') || text.includes('ë…¸ë€ë¶ˆ') || text.includes('ë…¸ë‘')) {
                yellowCount += 2;
            }
            if (text.includes('ğŸŸ¢') || text.includes('ì´ˆë¡ë¶ˆ') || text.includes('ì´ˆë¡')) {
                greenCount += 2;
            }
            
            // íŒì • ê²°ì •
            if (redCount > 0 && redCount >= yellowCount && redCount >= greenCount) {
                return {
                    type: 'red',
                    icon: 'ğŸ”´',
                    label: 'ë¹¨ê°„ë¶ˆ (ì¹˜ëª…ì  ì˜¤ë¥˜)',
                    message: 'ì´ëŒ€ë¡œ ì¶œì œí•˜ë©´ í°ì¼ ë‚©ë‹ˆë‹¤! ë¬´ì¡°ê±´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            } else if (greenCount > 0 && greenCount >= redCount && greenCount >= yellowCount) {
                return {
                    type: 'green',
                    icon: 'ğŸŸ¢',
                    label: 'ì´ˆë¡ë¶ˆ (ì •ìƒ)',
                    message: 'ì™„ë²½í•©ë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ì„¸ìš”.'
                };
            } else if (yellowCount > 0) {
                return {
                    type: 'yellow',
                    icon: 'ğŸŸ¡',
                    label: 'ë…¸ë€ë¶ˆ (ì˜¤ë¥˜ ì˜ì‹¬ / ì ê²€ í•„ìš”)',
                    message: 'í‹€ë¦° ê±´ ì•„ë‹Œë°... ì„ ìƒë‹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                };
            } else {
                // ê¸°ë³¸ê°’: ë…¸ë€ë¶ˆ (í™•ì¸ í•„ìš”)
                return {
                    type: 'yellow',
                    icon: 'ğŸŸ¡',
                    label: 'ë…¸ë€ë¶ˆ (ì ê²€ í•„ìš”)',
                    message: 'AI ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
                };
            }
        }
        
        // ê°„ë‹¨í•œ ì„¤ëª… ì¶”ì¶œ í•¨ìˆ˜
        function extractSummary(text, verdictType) {
            // ì²« 2-3ë¬¸ì¥ ì¶”ì¶œ
            const sentences = text.split(/[.!?]\s+/).filter(s => s.trim().length > 10);
            const summary = sentences.slice(0, 2).join('. ') + (sentences.length > 2 ? '...' : '');
            
            // íŒì • ë©”ì‹œì§€ì™€ ê²°í•©
            const verdictMsg = parseVerdict(text).message;
            return verdictMsg + ' ' + summary;
        }
        
        // ìì„¸í•œ ì„¤ëª… í¬ë§·íŒ… í•¨ìˆ˜
        function formatDetailText(text) {
            // ë²ˆí˜¸ ì œê±° (2., 3. ë“±)
            let formatted = text
                // ë²ˆí˜¸ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ ì œê±° (2. 3. ë“±)
                .replace(/^\d+\.\s+/gm, '')
                // ë²ˆí˜¸ì™€ í•¨ê»˜ ìˆëŠ” ë³¼ë“œ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                .replace(/^\d+\.\s*\*\*(.*?)\*\*/gm, '**$1**');
            
            // ë‹¨ë…ìœ¼ë¡œ ìˆëŠ” * ê¸°í˜¸ ì œê±° (ë¶ˆí•„ìš”í•œ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸)
            formatted = formatted.replace(/^\*\s*$/gm, '');
            formatted = formatted.replace(/^\*\s*\n/gm, '');
            // * ë’¤ì— ì¤„ë°”ê¿ˆì´ ì˜¤ëŠ” ê²½ìš° ì œê±°
            formatted = formatted.replace(/\*\s*\n/g, '\n');
            // * ì•ì— ì¤„ë°”ê¿ˆì´ ì˜¤ëŠ” ê²½ìš° ì œê±°
            formatted = formatted.replace(/\n\s*\*/g, '\n');
            
            // ì„¹ì…˜ í—¤ë” ì•ë’¤ì˜ ë¶ˆí•„ìš”í•œ ê³µë°± ì •ë¦¬
            formatted = formatted.replace(/\n+\s*<<([^>]+)>>\s*\n+/g, '\n\n<<$1>>\n\n');
            
            // <<ìš”ì•½>> ë˜ëŠ” <<ìì„¸í•œ ì„¤ëª…>> ì„¹ì…˜ ì°¾ê¸° ë° ê°•ì¡° (ë¨¼ì € ì²˜ë¦¬)
            formatted = formatted.replace(/<<(ìš”ì•½|ê°„ë‹¨í•œ ìš”ì•½|ê°„ë‹¨í•œ ì„¤ëª…)>>/gi, '<div style="margin: 20px 0 10px 0; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 700; font-size: 1.1em;">&lt;&lt;ìš”ì•½&gt;&gt;</div>');
            
            formatted = formatted.replace(/<<(ìì„¸í•œ ì„¤ëª…|ìì„¸í•œ ë¶„ì„|ìƒì„¸ ì„¤ëª…|ìƒì„¸ ë¶„ì„)>>/gi, '<div style="margin: 20px 0 10px 0; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 700; font-size: 1.1em;">&lt;&lt;ìì„¸í•œ ì„¤ëª…&gt;&gt;</div>');
            
            // ì¼ë°˜ì ì¸ << >> í˜•ì‹ìœ¼ë¡œ ëœ ì„¹ì…˜ í—¤ë” ê°•ì¡°
            formatted = formatted.replace(/<<([^>]+)>>/g, '<div style="margin: 20px 0 10px 0; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 700; font-size: 1.1em;">&lt;&lt;$1&gt;&gt;</div>');
            
            // LaTeX ìˆ˜ì‹ì„ ì„ì‹œë¡œ ë³´í˜¸ (ë³¼ë“œ/ì´íƒ¤ë¦­ ì²˜ë¦¬ ì „)
            const latexPlaceholders = [];
            let latexIndex = 0;
            formatted = formatted.replace(/\$([^$]+)\$/g, (match, content) => {
                const placeholder = `___LATEX_${latexIndex}___`;
                latexPlaceholders[latexIndex] = match;
                latexIndex++;
                return placeholder;
            });
            
            // ë³¼ë“œ í…ìŠ¤íŠ¸ (LaTeX ë³´í˜¸ í›„)
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // ë¶ˆë¦¿ ëª©ë¡ (ë³¼ë“œ ì²˜ë¦¬ í›„)
            formatted = formatted.replace(/^[-â€¢]\s+(.+)$/gm, '<li>$1</li>');
            
            // ì´íƒ¤ë¦­ (ë³¼ë“œì™€ ë¶ˆë¦¿ ëª©ë¡ ì²˜ë¦¬ í›„, LaTeX ì œì™¸)
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // LaTeX ìˆ˜ì‹ ë³µì›
            latexPlaceholders.forEach((latex, index) => {
                formatted = formatted.replace(`___LATEX_${index}___`, latex);
            });
            
            // ë‚¨ì•„ìˆëŠ” ë‹¨ë… * ê¸°í˜¸ ì œê±° (ì´íƒ¤ë¦­ ì²˜ë¦¬ í›„)
            formatted = formatted.replace(/\*\s*\n/g, '\n');
            formatted = formatted.replace(/\n\s*\*/g, '\n');
            formatted = formatted.replace(/^\*\s*$/gm, '');
            // * ì•ë’¤ë¡œ ê³µë°±ê³¼ ì¤„ë°”ê¿ˆì´ ìˆëŠ” ê²½ìš° ëª¨ë‘ ì œê±°
            formatted = formatted.replace(/\s*\*\s*\n/g, '\n');
            formatted = formatted.replace(/\n\s*\*\s*/g, '\n');
            
            // ë¶ˆí•„ìš”í•œ ì—°ì† ì¤„ë°”ê¿ˆ ì œê±° (3ê°œ ì´ìƒì„ 2ê°œë¡œ, ì„¹ì…˜ í—¤ë” divëŠ” ì œì™¸)
            // ì„¹ì…˜ í—¤ë” divë¥¼ ì„ì‹œë¡œ ë³´í˜¸
            formatted = formatted.replace(/<div[^>]*>([^<]*)<\/div>/g, (match) => {
                return match.replace(/\n/g, '___NEWLINE___');
            });
            
            // ë¹ˆ ì¤„ì´ ì—¬ëŸ¬ ê°œ ì—°ì†ìœ¼ë¡œ ìˆëŠ” ê²½ìš° ì •ë¦¬ (3ê°œ ì´ìƒì„ 2ê°œë¡œ)
            formatted = formatted.replace(/\n{3,}/g, '\n\n');
            
            // ë‹¨ë…ìœ¼ë¡œ ìˆëŠ” * ê¸°í˜¸ì™€ ê·¸ ì•ë’¤ ì¤„ë°”ê¿ˆ ì œê±°
            formatted = formatted.replace(/\n\s*\*\s*\n/g, '\n');
            formatted = formatted.replace(/\n\s*\*/g, '\n');
            formatted = formatted.replace(/\*\s*\n/g, '\n');
            
            // ì„¹ì…˜ í—¤ë” divì˜ ì„ì‹œ ë§ˆì»¤ë¥¼ ë‹¤ì‹œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³µì›
            formatted = formatted.replace(/___NEWLINE___/g, '\n');
            
            // ì„¹ì…˜ í—¤ë” div ì‚¬ì´ì˜ ê³¼ë„í•œ ì¤„ë°”ê¿ˆ ì •ë¦¬
            formatted = formatted.replace(/(<\/div>)\s*\n{3,}\s*(<div)/g, '$1\n\n$2');
            
            // ì œëª©ì„± ê°•ì¡° í…ìŠ¤íŠ¸ëŠ” ì¤„ë°”ê¿ˆ ìœ ì§€ (í•´ë‹µ, í’€ì´ ê³¼ì • ë“±)
            const titleKeywords = ['í•´ë‹µ', 'í’€ì´ ê³¼ì •', 'í’€ì´ê³¼ì •', 'ì˜¤ë¥˜ ë‚´ìš©', 'ë‚œì´ë„ í‰ê°€', 'ê°œì„  ì œì•ˆ', 'í•™ìƒìš© í’€ì´', 'ê°„ëµí•œ í’€ì´'];
            titleKeywords.forEach(keyword => {
                const regex = new RegExp(`(<strong>.*?${keyword}.*?</strong>)`, 'gi');
                formatted = formatted.replace(regex, (match) => {
                    return match.replace(/\n/g, '___TITLE_NEWLINE___');
                });
            });
            
            // ì¼ë°˜ ê°•ì¡° í…ìŠ¤íŠ¸(<strong>) ì•ë’¤ì˜ ë¶ˆí•„ìš”í•œ ì¤„ë°”ê¿ˆ ì œê±° (ì œëª©ì„± ê°•ì¡° ì œì™¸)
            formatted = formatted.replace(/\n\s*<strong>/g, ' <strong>');
            formatted = formatted.replace(/<\/strong>\s*\n/g, '</strong> ');
            formatted = formatted.replace(/<strong>\s*\n/g, '<strong>');
            formatted = formatted.replace(/\n\s*<\/strong>/g, '</strong>');
            
            // ì œëª©ì„± ê°•ì¡°ì˜ ì¤„ë°”ê¿ˆ ë³µì›
            formatted = formatted.replace(/___TITLE_NEWLINE___/g, '\n');
            
            // ì¼ë°˜ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            formatted = formatted.replace(/\n\n+/g, '</p><p>');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // HTML ë³€í™˜ í›„ ì¼ë°˜ ê°•ì¡° í…ìŠ¤íŠ¸ ì£¼ë³€ì˜ ë¶ˆí•„ìš”í•œ <br> ì œê±° (ì œëª©ì„± ê°•ì¡° ì œì™¸)
            // ì œëª©ì„± ê°•ì¡°ëŠ” ë¨¼ì € ë³´í˜¸
            titleKeywords.forEach(keyword => {
                const regex = new RegExp(`(<strong>.*?${keyword}.*?</strong>)`, 'gi');
                formatted = formatted.replace(regex, (match) => {
                    return match.replace(/<br>/g, '___TITLE_BR___');
                });
            });
            
            formatted = formatted.replace(/<br>\s*<strong>/g, ' <strong>');
            formatted = formatted.replace(/<\/strong>\s*<br>/g, '</strong> ');
            formatted = formatted.replace(/<p>\s*<strong>/g, '<p><strong>');
            formatted = formatted.replace(/<\/strong>\s*<\/p>/g, '</strong></p>');
            
            // ì œëª©ì„± ê°•ì¡°ì˜ <br> ë³µì›
            formatted = formatted.replace(/___TITLE_BR___/g, '<br>');
            
            // ëª©ë¡ì´ ìˆìœ¼ë©´ ulë¡œ ê°ì‹¸ê¸°
            formatted = formatted.replace(/(<li>.*?<\/li>)/gs, (match) => {
                if (!match.includes('<ul>')) {
                    return '<ul>' + match + '</ul>';
                }
                return match;
            });
            
            // HTML ë³€í™˜ í›„ ë‚¨ì•„ìˆëŠ” ë‹¨ë… * ê¸°í˜¸ ì œê±° (ëª¨ë“  íŒ¨í„´)
            formatted = formatted.replace(/<br>\s*\*\s*<br>/g, '<br>');
            formatted = formatted.replace(/<p>\s*\*\s*<\/p>/g, '');
            formatted = formatted.replace(/<p>\s*\*\s*<br>/g, '<p>');
            formatted = formatted.replace(/<br>\s*\*\s*<\/p>/g, '</p>');
            formatted = formatted.replace(/\s*\*\s*<br>/g, '<br>');
            formatted = formatted.replace(/<br>\s*\*\s*/g, '<br>');
            formatted = formatted.replace(/\s*\*\s*/g, ' ');
            // ë‚¨ì•„ìˆëŠ” ë‹¨ë… * ê¸°í˜¸ ìµœì¢… ì œê±°
            formatted = formatted.replace(/<strong>\*\s*<\/strong>/g, '');
            formatted = formatted.replace(/<em>\*\s*<\/em>/g, '');
            
            if (!formatted.startsWith('<p>') && !formatted.startsWith('<ul>') && !formatted.startsWith('<div')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }
        
        // ìì„¸íˆ ë³´ê¸° í† ê¸€ í•¨ìˆ˜
        window.toggleDetail = function(detailId, toggleBtnId) {
            const detailDiv = document.getElementById(detailId);
            const toggleBtn = document.getElementById(toggleBtnId);
            
            if (detailDiv.classList.contains('show')) {
                detailDiv.classList.remove('show');
                toggleBtn.classList.remove('active');
                toggleBtn.querySelector('span:last-child').textContent = 'â–¼';
            } else {
                detailDiv.classList.add('show');
                toggleBtn.classList.add('active');
                toggleBtn.querySelector('span:last-child').textContent = 'â–²';
            }
        };
        
        // ë°•ìŠ¤ í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
        function startResize(e, boxDiv, position, canvas, scaleX, scaleY) {
            e.preventDefault();
            e.stopPropagation();
            
            const startX = e.clientX;
            const startY = e.clientY;
            const rect = canvas.getBoundingClientRect();
            const wrapperRect = boxDiv.parentElement.getBoundingClientRect();
            
            // í˜„ì¬ ë°•ìŠ¤ ìœ„ì¹˜ì™€ í¬ê¸° (í™”ë©´ ì¢Œí‘œ)
            const boxLeft = parseFloat(boxDiv.style.left);
            const boxTop = parseFloat(boxDiv.style.top);
            const boxWidth = parseFloat(boxDiv.style.width);
            const boxHeight = parseFloat(boxDiv.style.height);
            
            // ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜ëœ í˜„ì¬ ê°’
            let canvasX = parseFloat(boxDiv.dataset.canvasX);
            let canvasY = parseFloat(boxDiv.dataset.canvasY);
            let canvasW = parseFloat(boxDiv.dataset.canvasW);
            let canvasH = parseFloat(boxDiv.dataset.canvasH);
            
            const onMouseMove = (moveEvent) => {
                const deltaX = (moveEvent.clientX - startX) / scaleX;
                const deltaY = (moveEvent.clientY - startY) / scaleY;
                
                let newX = canvasX;
                let newY = canvasY;
                let newW = canvasW;
                let newH = canvasH;
                
                // ìœ„ì¹˜ì— ë”°ë¼ í¬ê¸° ì¡°ì ˆ
                if (position === 'nw') {
                    // ì¢Œìƒë‹¨: x, y, width, height ëª¨ë‘ ë³€ê²½
                    newX = Math.max(0, canvasX + deltaX);
                    newY = Math.max(0, canvasY + deltaY);
                    newW = canvasW - deltaX;
                    newH = canvasH - deltaY;
                } else if (position === 'ne') {
                    // ìš°ìƒë‹¨: y, width, height ë³€ê²½
                    newY = Math.max(0, canvasY + deltaY);
                    newW = canvasW + deltaX;
                    newH = canvasH - deltaY;
                } else if (position === 'sw') {
                    // ì¢Œí•˜ë‹¨: x, width, height ë³€ê²½
                    newX = Math.max(0, canvasX + deltaX);
                    newW = canvasW - deltaX;
                    newH = canvasH + deltaY;
                } else if (position === 'se') {
                    // ìš°í•˜ë‹¨: width, height ë³€ê²½
                    newW = canvasW + deltaX;
                    newH = canvasH + deltaY;
                }
                
                // ìµœì†Œ í¬ê¸° ì²´í¬
                if (newW < 30) {
                    newW = 30;
                    if (position === 'nw' || position === 'sw') {
                        newX = canvasX + canvasW - 30;
                    }
                }
                if (newH < 30) {
                    newH = 30;
                    if (position === 'nw' || position === 'ne') {
                        newY = canvasY + canvasH - 30;
                    }
                }
                
                // ìº”ë²„ìŠ¤ ë²”ìœ„ ì²´í¬
                if (newX + newW > canvas.width) {
                    newW = canvas.width - newX;
                }
                if (newY + newH > canvas.height) {
                    newH = canvas.height - newY;
                }
                if (newX < 0) {
                    newW += newX;
                    newX = 0;
                }
                if (newY < 0) {
                    newH += newY;
                    newY = 0;
                }
                
                // í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜í•˜ì—¬ ì—…ë°ì´íŠ¸
                boxDiv.style.left = (newX * scaleX) + 'px';
                boxDiv.style.top = (newY * scaleY) + 'px';
                boxDiv.style.width = (newW * scaleX) + 'px';
                boxDiv.style.height = (newH * scaleY) + 'px';
                
                // ë°ì´í„° ì—…ë°ì´íŠ¸
                boxDiv.dataset.canvasX = newX;
                boxDiv.dataset.canvasY = newY;
                boxDiv.dataset.canvasW = newW;
                boxDiv.dataset.canvasH = newH;
                
                // í´ë¦­ í…ìŠ¤íŠ¸ ê¸€ì”¨ í¬ê¸° ì—…ë°ì´íŠ¸
                const clickText = boxDiv.querySelector('.ai-box-click-text');
                if (clickText) {
                    const minSize = Math.min(newW * scaleX, newH * scaleY);
                    const fontSize = Math.max(14, Math.min(32, minSize * 0.12));
                    clickText.style.fontSize = fontSize + 'px';
                }
            };
            
            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        // ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ í•¨ìˆ˜
        window.toggleImageZoom = function(img) {
            if (img.style.position === 'fixed') {
                // ì¶•ì†Œ
                img.style.position = 'relative';
                img.style.top = 'auto';
                img.style.left = 'auto';
                img.style.transform = 'scale(1)';
                img.style.zIndex = '1';
                img.style.maxWidth = '100%';
            } else {
                // í™•ëŒ€
                img.style.position = 'fixed';
                img.style.top = '50%';
                img.style.left = '50%';
                img.style.transform = 'translate(-50%, -50%) scale(1.8)';
                img.style.zIndex = '9999';
                img.style.maxWidth = '90vw';
                img.style.maxHeight = '90vh';
                img.style.cursor = 'zoom-out';
                img.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';
                
                // ë°°ê²½ ì˜¤ë²„ë ˆì´ ì¶”ê°€
                let overlay = document.getElementById('image-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'image-overlay';
                    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998; cursor: zoom-out;';
                    overlay.onclick = () => toggleImageZoom(img);
                    document.body.appendChild(overlay);
                }
                
                // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì¶•ì†Œ
                img.onclick = () => toggleImageZoom(img);
            }
            
            // ì˜¤ë²„ë ˆì´ ì œê±°
            const overlay = document.getElementById('image-overlay');
            if (overlay && img.style.position !== 'fixed') {
                overlay.remove();
            }
        };
        
        // ì‚¬ìš©ë²• ëª¨ë‹¬ í† ê¸€ í•¨ìˆ˜
        window.toggleHelp = function() {
            const modal = document.getElementById('help-modal');
            if (modal.style.display === 'none' || !modal.style.display) {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        };
        
        // ì„¤ì • ëª¨ë‹¬ í† ê¸€ í•¨ìˆ˜
        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            if (modal.style.display === 'none' || !modal.style.display) {
                // ëª¨ë‹¬ì„ ì—´ ë•Œ í˜„ì¬ ì„¤ì •ê°’ í‘œì‹œ
                const subjectSelect = document.getElementById('subject-select');
                const analysisLevelSelect = document.getElementById('analysis-level-select');
                const additionalRequirements = document.getElementById('additional-requirements');
                if (subjectSelect) subjectSelect.value = settings.subject;
                if (analysisLevelSelect) analysisLevelSelect.value = settings.analysisLevel;
                if (additionalRequirements) additionalRequirements.value = settings.additionalRequirements || '';
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        };
        
        // í”„ë¡¬í”„íŠ¸ í¸ì§‘ê¸° í† ê¸€ í•¨ìˆ˜
        window.togglePromptEditor = function() {
            const container = document.getElementById('prompt-editor-container');
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                loadCurrentPrompt();
            } else {
                container.style.display = 'none';
            }
        };
        
        // í˜„ì¬ í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadCurrentPrompt = function() {
            const promptEditor = document.getElementById('prompt-editor');
            if (settings.customPrompt && settings.customPrompt.trim()) {
                promptEditor.value = settings.customPrompt;
            } else {
                // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ì—¬ í‘œì‹œ
                const tempSettings = { ...settings };
                settings.customPrompt = '';
                promptEditor.value = generateReviewPrompt();
                settings = tempSettings;
            }
        };
        
        // í”„ë¡¬í”„íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
        window.resetPrompt = function() {
            if (confirm('í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ í¸ì§‘í•œ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                const promptEditor = document.getElementById('prompt-editor');
                settings.customPrompt = '';
                promptEditor.value = '';
                loadCurrentPrompt();
            }
        };
        
        // ì„¤ì • ì €ì¥ í•¨ìˆ˜
        window.saveSettings = function() {
            const subject = document.getElementById('subject-select').value;
            const analysisLevel = document.getElementById('analysis-level-select').value;
            const additionalRequirements = document.getElementById('additional-requirements').value;
            const promptEditor = document.getElementById('prompt-editor');
            const customPrompt = promptEditor ? promptEditor.value.trim() : '';
            
            // settings ê°ì²´ ì—…ë°ì´íŠ¸
            settings.subject = subject;
            settings.analysisLevel = analysisLevel;
            settings.additionalRequirements = additionalRequirements || '';
            settings.customPrompt = customPrompt || '';
            
            // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
            localStorage.setItem('exam_review_settings', JSON.stringify(settings));
            
            // ë””ë²„ê¹…ìš© ë¡œê·¸
            console.log('ì„¤ì • ì €ì¥ë¨ - êµê³¼ëª©:', subject, 'ë¶„ì„ ìˆ˜ì¤€:', analysisLevel);
            console.log('ì¶”ê°€ ìš”êµ¬ì‚¬í•­:', additionalRequirements ? 'ìˆìŒ' : 'ì—†ìŒ');
            console.log('ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸:', customPrompt ? 'ìˆìŒ' : 'ì—†ìŒ');
            console.log('í˜„ì¬ settings ê°ì²´:', settings);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            toggleSettings();
            
            // ì„±ê³µ ë©”ì‹œì§€
            const btn = document.getElementById('settings-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `âœ… ì €ì¥ë¨ (${analysisLevel})`;
            btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }, 2000);
        };
        
        // ìºì‹œ ì‚­ì œ í•¨ìˆ˜
        window.clearCache = function() {
            if (confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œë˜ëŠ” ë°ì´í„°:\n- API í‚¤\n- ê²€í†  ì„¤ì • (êµê³¼ëª©, ë¶„ì„ ìˆ˜ì¤€, ì¶”ê°€ ìš”êµ¬ì‚¬í•­, ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸)\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ëª¨ë“  ê´€ë ¨ ë°ì´í„° ì‚­ì œ
                localStorage.removeItem('gemini_api_key');
                localStorage.removeItem('exam_review_settings');
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                const apiKeyInput = document.getElementById('api-key');
                if (apiKeyInput) {
                    apiKeyInput.value = '';
                }
                
                // ì„¤ì •ê°’ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                settings = {
                    subject: 'ê¸°íƒ€',
                    analysisLevel: 'ìì„¸íˆ',
                    additionalRequirements: '',
                    customPrompt: ''
                };
                
                // ì„¤ì • ëª¨ë‹¬ì˜ ì…ë ¥ í•„ë“œë„ ì´ˆê¸°í™”
                const subjectSelect = document.getElementById('subject-select');
                const analysisLevelSelect = document.getElementById('analysis-level-select');
                const additionalRequirements = document.getElementById('additional-requirements');
                const promptEditor = document.getElementById('prompt-editor');
                
                if (subjectSelect) subjectSelect.value = 'ê¸°íƒ€';
                if (analysisLevelSelect) analysisLevelSelect.value = 'ìì„¸íˆ';
                if (additionalRequirements) additionalRequirements.value = '';
                if (promptEditor) promptEditor.value = '';
                
                // ì„±ê³µ ë©”ì‹œì§€
                const btn = document.getElementById('clear-cache-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… ì‚­ì œ ì™„ë£Œ';
                btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                }, 2000);
                
                console.log('ì´ˆê¸°í™” ì™„ë£Œ');
            }
        };
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const settingsModal = document.getElementById('settings-modal');
            const helpModal = document.getElementById('help-modal');
            if (e.target === settingsModal) {
                toggleSettings();
            }
            if (e.target === helpModal) {
                toggleHelp();
            }
        });
    </script>
</body>
</html>